<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Thread - My Student Club</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://www.mystudentclub.com/scripts/portal-style.css">
    <link rel="icon" type="image/x-icon" href="/assets/icon-70x70.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging-compat.js"></script>
    <style>
        :root {
            --surface-bg: #EFF6FF;
            --text-primary: #1E3A8A;
            --border-medium: #DBEAFE;
            --primary-brand: #3B82F6;
            --radius-xl: 16px;
            --radius-md: 10px;
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --transition-std: all 0.2s;
        }
        body { background: var(--surface-bg); color: var(--text-primary); }
        .form-container { max-width: 800px; margin: 2rem auto; padding: 2rem; background: #FFFFFF; border-radius: var(--radius-xl); box-shadow: var(--shadow-md); }
        .form-container h1 { font-size: 1.75rem; margin-bottom: 2rem; font-weight: 700; color: var(--text-primary); }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-primary); }
        .form-group input, .form-group textarea { width: 100%; padding: 0.75rem; border-radius: var(--radius-md); border: 1px solid var(--border-medium); font-size: 1rem; transition: all var(--transition-std); }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-brand); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        .form-group textarea { min-height: 200px; resize: vertical; }
        .action-button { background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); text-decoration: none; }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4); }
        .action-button:disabled { background: #9CA3AF; cursor: not-allowed; transform: none; box-shadow: none; }
    </style>
</head>
<body>
    <header class="site-header">
      <div class="header-container">
        <a href="/" class="brand-link">
          <img src="/assets/logo.png" alt="My Student Club" class="brand-logo">
        </a>
        <div class="nav-actions">
          <div class="auth-buttons-container"></div>
          <button class="icon-button menu-toggle-btn" id="menuButton" aria-label="Open menu">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <div class="expanded-menu" id="expandedMenu">
      <button class="icon-button menu-close-btn" id="menuCloseBtn" aria-label="Close menu">
          <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
      </button>
      <div class="menu-items-container">
          <a href="/ca-industrial-training-program/" class="menu-item">CA Industrial Training Program</a>
          <a href="/articleship-guarantee-program/" class="menu-item">Articleship Program</a>
          <a href="/learning-management-system/" class="menu-item" id="lms-nav-link" style="display: none;">My Courses</a>
          <a href="/ai-interview.html" class="menu-item">AI Interview Bot</a>
          <a href="/" class="menu-item">Discussion Forum</a>
          <div class="menu-item-dropdown">
              <button class="menu-item" id="resourcesDropdownBtn">
                  Resources
                  <svg class="dropdown-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
              </button>
              <div class="dropdown-content" id="resourcesDropdown">
                  <a href="/fresher.html" class="dropdown-item">CA Freshers</a>
                  <a href="/ca-industrial-training-resources.html" class="dropdown-item">CA Industrial Training</a>
                  <a href="/articleship.html" class="dropdown-item">Articleship</a>
              </div>
          </div>
      </div>
    </div>

    <main class="form-container">
        <h1>Start a New Discussion</h1>
        <form id="new-thread-form">
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" id="title" required placeholder="Enter a clear and concise title">
            </div>
            <div class="form-group">
                <label for="content">Content</label>
                <textarea id="content" required placeholder="Describe your question or topic in detail here..."></textarea>
            </div>
            <button type="submit" class="action-button">Post Thread</button>
        </form>
    </main>

    <script type="module">
        const supabaseUrl = 'https://izsggdtdiacxdsjjncdq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6c2dnZHRkaWFjeGRzampuY2RxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1OTEzNjUsImV4cCI6MjA1NDE2NzM2NX0.FVKBJG-TmXiiYzBDjGIRBM2zg-DYxzNP--WM6q2UMt0';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        const form = document.getElementById('new-thread-form');
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session || !session.user) {
                const redirectUrl = encodeURIComponent(window.location.pathname + window.location.search);
                window.location.href = `/login.html?redirect=${redirectUrl}`;
            } else {
                currentUser = session.user;
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();
            const submitBtn = form.querySelector('button[type="submit"]');

            if (!title || !content || !currentUser) return;

            submitBtn.disabled = true;
            submitBtn.textContent = 'Posting...';

            const { data, error } = await supabaseClient
                .from('forum_threads')
                .insert({
                    title,
                    content,
                    author_id: currentUser.id,
                    author_email: currentUser.email
                })
                .select()
                .single();

            if (error) {
                alert('Error creating thread: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Post Thread';
            } else {
                 await supabaseClient.from('forum_user_profiles').upsert({
                    user_id: currentUser.id,
                    username: currentUser.email.split('@')[0],
                    display_name: currentUser.email.split('@')[0]
                }, { onConflict: 'user_id' });
                window.location.href = `/thread.html?id=${data.id}`;
            }
        });

        const menuButton = document.getElementById('menuButton');
        const menuCloseBtn = document.getElementById('menuCloseBtn');
        const expandedMenu = document.getElementById('expandedMenu');

        if(menuButton && expandedMenu) {
            menuButton.addEventListener('click', () => {
                expandedMenu.style.transform = 'translateX(0)';
            });
        }

        if(menuCloseBtn && expandedMenu) {
            menuCloseBtn.addEventListener('click', () => {
                expandedMenu.style.transform = 'translateX(100%)';
            });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discussion - My Student Club</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://www.mystudentclub.com/scripts/portal-style.css">
    <link rel="icon" type="image/x-icon" href="/assets/icon-70x70.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging-compat.js"></script>
    <style>
        .thread-container { max-width: 900px; margin: 2rem auto; padding: 1.5rem; }
        .original-post, .post-item { background: var(--surface-bg); border-radius: var(--radius-lg); padding: 1.5rem; border: 1px solid var(--border-light); margin-bottom: 1.5rem; }
        .original-post { border-left: 4px solid var(--primary-brand); box-shadow: var(--shadow-sm); }
        .post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-light); }
        .post-author { font-weight: 600; color: var(--text-primary); }
        .post-date { font-size: 0.8rem; color: var(--text-secondary); }
        .post-content { line-height: 1.7; color: var(--text-secondary); white-space: pre-wrap; word-wrap: break-word; }
        .thread-title-main { font-size: 1.75rem; font-weight: 700; margin-bottom: 1.5rem; line-height: 1.3; }
        #reply-form { margin-top: 2rem; background: var(--surface-bg); padding: 1.5rem; border-radius: var(--radius-lg); border: 1px solid var(--border-light); }
        #reply-form h3 { font-size: 1.2rem; margin-bottom: 1rem; font-weight: 600; }
        #reply-form textarea { width: 100%; min-height: 120px; padding: 1rem; border-radius: var(--radius-md); border: 1px solid var(--border-medium); font-size: 1rem; margin-bottom: 1rem; resize: vertical; }
        #reply-form textarea:focus { outline: none; border-color: var(--primary-brand); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        .back-link { display: inline-flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); text-decoration: none; margin-bottom: 1.5rem; font-weight: 500; }
        .back-link:hover { color: var(--primary-brand); }
    </style>
</head>
<body>
    <header class="site-header">
      <div class="header-container">
        <a href="/" class="brand-link">
          <img src="/assets/logo.png" alt="My Student Club" class="brand-logo">
        </a>
        <div class="nav-actions">
          <div class="auth-buttons-container"></div>
          <button id="notificationsBtn" class="icon-button notification-icon-btn" aria-label="Manage Notifications">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <span class="notification-badge" id="notificationBadge"></span>
          </button>
          <button class="icon-button menu-toggle-btn" id="menuButton" aria-label="Open menu">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <div class="expanded-menu" id="expandedMenu">
      <button class="icon-button menu-close-btn" id="menuCloseBtn" aria-label="Close menu">
          <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
      </button>
      <div class="menu-items-container">
          <a href="/ca-industrial-training-program/" class="menu-item">CA Industrial Training Program</a>
          <a href="/articleship-guarantee-program/" class="menu-item">Articleship Program</a>
          <a href="/learning-management-system/" class="menu-item" id="lms-nav-link" style="display: none;">My Courses</a>
          <a href="/ai-interview.html" class="menu-item">AI Interview Bot</a>
          <a href="/forum.html" class="menu-item">Discussion Forum</a>
          <div class="menu-item-dropdown">
              <button class="menu-item" id="resourcesDropdownBtn">
                  Resources
                  <svg class="dropdown-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
              </button>
              <div class="dropdown-content" id="resourcesDropdown">
                  <a href="/fresher.html" class="dropdown-item">CA Freshers</a>
                  <a href="/ca-industrial-training-resources.html" class="dropdown-item">CA Industrial Training</a>
                  <a href="/articleship.html" class="dropdown-item">Articleship</a>
              </div>
          </div>
      </div>
    </div>
    
    <main class="thread-container">
        <a href="/forum.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Forum</a>
        <div id="thread-content">
             <div id="loader" class="loader-container" style="display: block;"><div class="loader-spinner"></div></div>
        </div>
        <div id="posts-list"></div>
        
        <form id="reply-form" style="display: none;">
            <h3>Your Reply</h3>
            <textarea id="reply-content" required placeholder="Write your reply here..."></textarea>
            <button type="submit" class="action-button">Post Reply</button>
        </form>
        <div id="login-prompt" style="display: none; text-align: center; margin-top: 2rem; padding: 1.5rem; background: var(--neutral-bg); border-radius: var(--radius-lg);">
            <p><a href="/login.html" style="font-weight: 600; text-decoration: underline;">Log in</a> to join the discussion.</p>
        </div>
    </main>
    
    <footer class="site-footer-nav">
      <a href="/" class="footer-tab active">
        <span>Industrial Training</span>
      </a>
      <a href="/articleship.html" class="footer-tab">
        <span>Articleship</span>
      </a>
      <a href="/semi-qualified.html" class="footer-tab">
        <span>Semi Qualified</span>
      </a>
      <a href="/fresher.html" class="footer-tab">
        <span>Freshers</span>
      </a>
    </footer>

    <script type="module" src="https://www.mystudentclub.com/scripts/portal3.js"></script>
    <script type="module">
        const supabaseUrl = 'https://izsggdtdiacxdsjjncdq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6c2dnZHRkaWFjeGRzampuY2RxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1OTEzNjUsImV4cCI6MjA1NDE2NzM2NX0.FVKBJG-TmXiiYzBDjGIRBM2zg-DYxzNP--WM6q2UMt0';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        const threadContentEl = document.getElementById('thread-content');
        const postsListEl = document.getElementById('posts-list');
        const replyForm = document.getElementById('reply-form');
        const loginPrompt = document.getElementById('login-prompt');
        const threadId = new URLSearchParams(window.location.search).get('id');
        let currentUser = null;

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 60) return "just now";
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        }

        async function fetchThreadAndPosts() {
            if (!threadId) {
                threadContentEl.innerHTML = '<h2>Thread not found.</h2>';
                return;
            }

            const { data: thread, error: threadError } = await supabaseClient
                .from('forum_threads')
                .select('*')
                .eq('id', threadId)
                .single();

            if (threadError || !thread) {
                threadContentEl.innerHTML = '<h2>Error loading thread.</h2>';
                return;
            }

            document.title = `${thread.title} - My Student Club`;
            const opAuthor = thread.author_email ? thread.author_email.split('@')[0] : 'Anonymous';
            threadContentEl.innerHTML = `
                <h1 class="thread-title-main">${thread.title}</h1>
                <div class="original-post">
                    <div class="post-header">
                        <span class="post-author">${opAuthor}</span>
                        <span class="post-date">${timeAgo(thread.created_at)}</span>
                    </div>
                    <div class="post-content">${thread.content}</div>
                </div>
                <h3 style="margin-bottom: 1.5rem; font-weight: 600;">Replies</h3>
            `;

            const { data: posts, error: postsError } = await supabaseClient
                .from('forum_posts')
                .select('*')
                .eq('thread_id', threadId)
                .order('created_at', { ascending: true });

            if (postsError) {
                postsListEl.innerHTML = '<p>Error loading replies.</p>';
                return;
            }

            posts.forEach(post => {
                const postAuthor = post.author_email ? post.author_email.split('@')[0] : 'Anonymous';
                const postEl = document.createElement('div');
                postEl.className = 'post-item';
                postEl.innerHTML = `
                    <div class="post-header">
                        <span class="post-author">${postAuthor}</span>
                        <span class="post-date">${timeAgo(post.created_at)}</span>
                    </div>
                    <div class="post-content">${post.content}</div>
                `;
                postsListEl.appendChild(postEl);
            });
        }

        replyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = document.getElementById('reply-content').value.trim();
            if (!content || !currentUser) return;

            const submitBtn = replyForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Posting...';

            const { error } = await supabaseClient.from('forum_posts').insert({
                thread_id: threadId,
                content: content,
                author_id: currentUser.id,
                author_email: currentUser.email
            });

            if (error) {
                alert('Failed to post reply: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Post Reply';
            } else {
                location.reload();
            }
        });

        supabaseClient.auth.onAuthStateChange((_event, session) => {
            if (session && session.user) {
                currentUser = session.user;
                replyForm.style.display = 'block';
                loginPrompt.style.display = 'none';
            } else {
                currentUser = null;
                replyForm.style.display = 'none';
                loginPrompt.style.display = 'block';
            }
        });

        fetchThreadAndPosts();
    </script>
</body>
</html>
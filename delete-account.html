<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delete Account - My Student Club</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/scripts/portal-style.css">
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            min-height: 100vh;
            background-color: #f7fafc;
            padding: 80px 1rem 1rem;
        }

        .container {
            background-color: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 550px;
            border-top: 5px solid #ef4444;
            margin: 2rem auto;
        }

        h1 {
            margin: 0 0 0.5rem;
            color: #b91c1c;
            font-size: 1.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        p {
            margin-bottom: 1.5rem;
            color: #4b5563;
            line-height: 1.6;
        }

        strong {
            color: #1f2937;
        }

        #auth-status {
            font-style: italic;
            color: #718096;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .delete-btn {
            width: 100%;
            padding: 0.875rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
            background-color: #ef4444;
            color: white;
        }

        .delete-btn:disabled {
            background-color: #fca5a5;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .delete-btn:hover:not(:disabled) {
            background-color: #dc2626;
        }

        #result-message {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 6px;
            font-weight: 500;
            text-align: center;
            display: none;
        }

        #result-message.success {
            background-color: #d1fae5;
            color: #065f46;
        }

        #result-message.error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="header-container">
            <a href="/" class="brand-link">
                <img src="/assets/logo.png" alt="My Student Club" class="brand-logo">
            </a>
            <div class="header-actions">
                <div class="auth-buttons-container"></div>
                <button class="menu-button-style" aria-label="Open menu" id="menuButton">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <div class="expanded-menu" id="expandedMenu">
        <button class="menu-close-btn" id="menuCloseBtn">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <div class="menu-items">
            <a href="/learning-management-system/" class="menu-item" id="lms-nav-link" style="display: none;">My
                Courses</a>

            <div class="menu-item-dropdown">
                <button class="menu-item" style="width: 100%; justify-content: space-between;">
                    Mentorship Programs
                    <svg class="dropdown-icon" width="20" height="20" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div class="dropdown-content" style="display: none; padding-left: 1.5rem;">
                    <a href="/ca-fresher-training-program/" class="menu-item">CA Fresher Program</a>
                    <a href="/ca-industrial-training-program/" class="menu-item">Industrial Training Program</a>
                    <a href="/articleship-program/" class="menu-item">Articleship Program</a>
                </div>
            </div>

            <div class="menu-item-dropdown">
                <button class="menu-item" style="width: 100%; justify-content: space-between;">
                    Free Resources
                    <svg class="dropdown-icon" width="20" height="20" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div class="dropdown-content" style="display: none; padding-left: 1.5rem;">
                    <a href="/ca-fresher-training-resources.html" class="menu-item">CA Fresher</a>
                    <a href="/ca-industrial-training-resources.html" class="menu-item">Industrial Training</a>
                    <a href="/articleship.html" class="menu-item">Articleship</a>
                </div>
            </div>

            <div class="menu-item-dropdown">
                <button class="menu-item" style="width: 100%; justify-content: space-between;">
                    Tools
                    <svg class="dropdown-icon" width="20" height="20" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div class="dropdown-content" style="display: none; padding-left: 1.5rem;">
                    <a href="/cv-reviewer/" class="menu-item">AI CV Reviewer</a>
                    <a href="/ai-interview.html" class="menu-item">AI Mock Interview Bot</a>
                    <a href="/ICAI-Campus-Shortlisting-Predictor/index.html" class="menu-item">Campus Shortlisting
                        Predictor</a>
                </div>
            </div>

            <a href="/contact.html" class="menu-item">Contact Us</a>
        </div>
    </div>

    <div class="container">
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
            </svg>
            Delete Your Account
        </h1>
        <p>This action is irreversible. When you delete your account, all of your personal profile data, course
            enrollments, and application history will be permanently removed.</p>

        <div id="auth-status">Verifying your session...</div>

        <div id="delete-section" class="hidden">
            <div class="form-group">
                <label for="confirmation-text">To confirm, please type <strong>DELETE</strong> in the box below:</label>
                <input type="text" id="confirmation-text" autocomplete="off">
            </div>
            <button id="delete-account-btn" class="delete-btn" disabled>Permanently Delete My Account</button>
        </div>

        <div id="result-message"></div>
    </div>

    <script>
        const supabaseUrl = 'https://api.mystudentclub.com';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6c2dnZHRkaWFjeGRzampuY2RxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1OTEzNjUsImV4cCI6MjA1NDE2NzM2NX0.FVKBJG-TmXiiYzBDjGIRBM2zg-DYxzNP--WM6q2UMt0';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        const authStatusDiv = document.getElementById('auth-status');
        const deleteSection = document.getElementById('delete-section');
        const confirmationInput = document.getElementById('confirmation-text');
        const deleteBtn = document.getElementById('delete-account-btn');
        const resultMessage = document.getElementById('result-message');
        let currentUser = null;

        supabase.auth.onAuthStateChange((_event, session) => {
            if (session && session.user) {
                currentUser = session.user;
                authStatusDiv.textContent = `You are logged in as: ${currentUser.email}`;
                deleteSection.classList.remove('hidden');
            } else {
                currentUser = null;
                authStatusDiv.innerHTML = 'You are not logged in. Please <a href="/login.html">log in</a> to delete your account.';
                deleteSection.classList.add('hidden');
            }
        });

        confirmationInput.addEventListener('input', () => {
            deleteBtn.disabled = confirmationInput.value !== 'DELETE';
        });

        deleteBtn.addEventListener('click', async () => {
            if (!currentUser || confirmationInput.value !== 'DELETE') return;

            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Deleting...';
            resultMessage.style.display = 'none';

            try {
                const { error } = await supabase.rpc('delete_user_account');

                if (error) {
                    throw error;
                }

                resultMessage.textContent = 'Your account has been successfully deleted. You will be redirected shortly.';
                resultMessage.className = 'success';
                resultMessage.style.display = 'block';

                await supabase.auth.signOut();
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);

            } catch (error) {
                console.error('Error deleting account:', error);
                resultMessage.textContent = `Error: ${error.message || 'Could not delete your account. Please try again or contact support.'}`;
                resultMessage.className = 'error';
                resultMessage.style.display = 'block';
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'Permanently Delete My Account';
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Menu Toggle
            const menuButton = document.getElementById('menuButton');
            const expandedMenu = document.getElementById('expandedMenu');
            const menuCloseBtn = document.getElementById('menuCloseBtn');

            if (menuButton && expandedMenu) {
                menuButton.addEventListener('click', () => expandedMenu.classList.add('active'));
            }
            if (menuCloseBtn && expandedMenu) {
                menuCloseBtn.addEventListener('click', () => expandedMenu.classList.remove('active'));
            }

            // Dropdowns
            const dropdowns = document.querySelectorAll('.menu-item-dropdown button');
            dropdowns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const content = btn.nextElementSibling;
                    if (content) {
                        content.style.display = content.style.display === 'block' ? 'none' : 'block';
                        btn.classList.toggle('active');
                    }
                });
            });

            // Auth Check
            if (window.supabase) {
                // Supabase client is already initialized in the specific script below, but we can reuse the global one if available or re-init safely (though re-init is wasteful, better to check if existing client variable is accessible, but scopes might differ. Using the one from below script might be tricky due to timing. Safe to re-create or better, check if window.supabaseClient exists or similar. The script below defines `const supabase` in local scope.
                // Let's just do a simple check.
                const { data: { session } } = await supabase.auth.getSession();
                const authContainer = document.querySelector('.auth-buttons-container');
                const lmsLink = document.getElementById('lms-nav-link');

                if (authContainer) {
                    if (session) {
                        authContainer.innerHTML = '<a href="/profile.html" class="auth-icon-btn"><i class="fas fa-user"></i></a>';
                        if (lmsLink) lmsLink.style.display = 'flex';
                    } else {
                        authContainer.innerHTML = '<a href="/login.html" class="auth-icon-btn"><i class="fas fa-sign-in-alt"></i></a>';
                    }
                }
            }
        });
    </script>
</body>

</html>
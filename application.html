<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Job Open Handler</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Reduce referrer leakage -->
    <meta name="referrer" content="no-referrer" />
    <style>
      :root { color-scheme: light dark; }
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
      header { padding: 12px 16px; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; }
      .pill { padding: 4px 8px; border: 1px solid #bbb; border-radius: 999px; font-size: 12px; margin-left: 8px; }
      .wrap { padding: 16px; }
      .status { padding: 12px 14px; border-radius: 8px; background: #f5f5f5; margin-bottom: 12px; }
      .hidden { display: none; }
      iframe { width: 100%; height: calc(100vh - 80px); border: 0; background: #fff; }
      .spinner {
        width: 18px; height: 18px; border: 3px solid #ccc; border-top-color: #555; border-radius: 50%;
        animation: spin 0.9s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      code { background: #f0f0f0; padding: 2px 4px; border-radius: 4px; }
    </style>
  </head>
  <body>
    <header>
      <div>Job Open Handler</div>
      <div id="portalPill" class="pill hidden"></div>
    </header>

    <div class="wrap">
      <div id="info" class="status"></div>
      <div id="error" class="status hidden" style="background:#ffecec; color:#a00;"></div>
      <div id="aiProgress" class="status hidden"><span class="spinner"></span><span id="aiMsg">Preparing AI email…</span></div>
    </div>

    <iframe id="pageFrame" class="hidden"
            sandbox="allow-forms allow-scripts allow-popups allow-downloads"
            referrerpolicy="no-referrer"
            loading="eager">
    </iframe>

    <script>
      const AI_MAIL_ENDPOINT = "https://emailgenerator.bhansalimanan55.workers.dev/";

      const JOB_TITLE_MAP = {
        industrial: "Industrial Training",
        fresher: "CA Fresher",
        semi: "CA Semi Qualified",
        articleship: "Articleship Trainee"
      };

      const qs = new URLSearchParams(window.location.search);
      const portal = (qs.get("portal") || "").toLowerCase();
      const jobId = (qs.get("jobId") || "").trim();
      const aiMail = qs.has("aiMail");
      const company = qs.get("company") || "the company";
      const title = qs.get("title") || (JOB_TITLE_MAP[portal] || "the role");

      const infoEl = document.getElementById("info");
      const errEl = document.getElementById("error");
      const aiBox = document.getElementById("aiProgress");
      const portalPill = document.getElementById("portalPill");
      const frame = document.getElementById("pageFrame");

      function show(el) { el.classList.remove("hidden"); }
      function hide(el) { el.classList.add("hidden"); }

      function isEmail(str) {
        return /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(str);
      }

      function isHttpUrl(str) {
        try {
          const u = new URL(str);
          return u.protocol === "http:" || u.protocol === "https:";
        } catch { return false; }
      }

      function buildSubject(portalKey, companyName, roleTitle) {
        const mapped = JOB_TITLE_MAP[portalKey] || roleTitle || "the role";
        return `Application for ${mapped} at ${companyName} (Ref: My Student Club)`;
      }

      function buildMailto(toEmail, subject, body = "") {
        return `mailto:${toEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      }

      async function generateAiBody({ profile = {}, job = {} }) {
        const payload = {
          profile_data: profile,
          job_details: {
            company_name: job.company,
            job_description: job.description || "",
            job_location: job.location || "",
            job_title: job.title || ""
          }
        };
        const res = await fetch(AI_MAIL_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`AI endpoint error: ${res.status}`);
        const data = await res.json();
        return data.email_body || "";
      }

      async function handleEmailFlow(to) {
        const subject = buildSubject(portal, company, title);
        if (!aiMail) {
          infoEl.textContent = "Opening email draft…";
          window.location.href = buildMailto(to, subject, "");
          return;
        }
        show(aiBox);
        infoEl.textContent = "Generating AI email and opening draft…";
        try {
          const profileData = JSON.parse(localStorage.getItem("userProfileData") || "{}");
          const cvText = localStorage.getItem("userCVText") || "";

          const body = await generateAiBody({
            profile: { profile_data: profileData, cv_text: cvText },
            job: { company, title }
          });
          window.location.href = buildMailto(to, subject, body || "");
        } catch (e) {
          errEl.textContent = "AI email generation failed, opening a simple email draft instead.";
          show(errEl);
          window.location.href = buildMailto(to, subject, "");
        } finally {
          hide(aiBox);
        }
      }

      function handleIframeFlow(url) {
        infoEl.innerHTML = "Loading the application page in a secure viewer…";
        frame.src = url;
        show(frame);
      }

      function main() {
        if (portal) {
          portalPill.textContent = portal;
          show(portalPill);
        }

        if (!jobId) {
          errEl.textContent = "Missing jobId in query string.";
          show(errEl);
          return;
        }

        if (isEmail(jobId)) {
          infoEl.textContent = "Detected email-based application.";
          handleEmailFlow(jobId);
          return;
        }

        if (isHttpUrl(jobId)) {
          infoEl.textContent = "Opening the application in an embedded viewer.";
          handleIframeFlow(jobId);
          return;
        }

        errEl.textContent = "jobId must be an email address or a valid http/https URL.";
        show(errEl);
      }

      document.addEventListener("DOMContentLoaded", main);
    </script>
  </body>
</html>

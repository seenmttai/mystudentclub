<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Details | My Student Club LMS</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="course-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="importmap">
    {
        "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
        }
    }
    </script>
    <style>
        .logo-enhanced {
            width: 140px;
            height: auto;
            object-fit: contain;
            transition: transform 0.2s;
        }
        .logo-enhanced:hover {
            transform: scale(1.05);
        }
        .profile-dropdown-container {
            position: relative;
            cursor: pointer;
        }
        .profile-dropdown-menu {
            position: absolute;
            top: 110%;
            right: 0;
            background: white;
            border: 1px solid var(--border-color, #e2e8f0);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 220px;
            display: none;
            flex-direction: column;
            z-index: 10000;
            overflow: hidden;
            animation: fadeIn 0.2s ease-out;
        }
        .profile-dropdown-container:hover .profile-dropdown-menu {
            display: flex;
        }
        .profile-header {
            padding: 1rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        .profile-name {
            font-weight: 700;
            color: #1e293b;
            display: block;
        }
        .profile-email {
            font-size: 0.8rem;
            color: #64748b;
        }
        .dropdown-item {
            padding: 0.75rem 1rem;
            color: #475569;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
            cursor: pointer;
        }
        .dropdown-item:hover {
            background: #f1f5f9;
            color: #2563eb;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .course-tabs {
            display: flex;
            gap: 1rem;
            padding: 0 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            overflow-x: auto;
        }
        .tab-btn {
            padding: 1rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        .tab-content {
            padding: 1.5rem;
            background: white;
            min-height: 200px;
        }
        .discussion-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .comment-input-area {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .comment-input {
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
        }
        .post-btn {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            height: fit-content;
        }
        .post-btn:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }
        .comment-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .comment-item {
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        .comment-author {
            font-weight: 700;
            color: #1e293b;
        }
        .comment-date {
            color: #64748b;
        }
        .report-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 600px;
        }
        .report-textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .report-submit-btn {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            align-self: flex-start;
        }
    </style>
</head>
<body>
    <div id="app">
        <header class="glass-header">
            <div class="header-container">
                <div class="logo-container">
                    <a href="index.html">
                        <img src="https://www.mystudentclub.com/assets/logo.png" alt="My Student Club Logo" class="logo-enhanced">
                    </a>
                </div>
                <nav>
                    <div class="hamburger-menu" @click="toggleMenu">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                    <ul class="nav-links" :class="{ 'active': menuActive }">
                        <li><a href="index.html" class="nav-item">
                            <i class="fas fa-graduation-cap"></i>
                            <span>My Courses</span>
                        </a></li>
                        <li><a href="lms-resources.html" class="nav-item">
                            <i class="fas fa-book-open"></i>
                            <span>Resources</span>
                        </a></li>
                        <li><a href="https://mystudentclub.com/cv-reviewer/" class="nav-item">
                            <i class="fas fa-file-alt"></i>
                            <span>CV Review</span>
                        </a></li>
                        <li class="profile-link profile-dropdown-container">
                            <a href="#" class="nav-item profile-nav" @click.prevent>
                                <div class="profile-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <span v-if="user">{{ getUserDisplayName() }}</span>
                                <span v-else>Login</span>
                            </a>
                            <div class="profile-dropdown-menu" v-if="user">
                                <div class="profile-header">
                                    <span class="profile-name">{{ getUserDisplayName() }}</span>
                                    <span class="profile-email">{{ user.email }}</span>
                                </div>
                                <a href="https://mystudentclub.com/profile" class="dropdown-item">
                                    <i class="fas fa-user-circle"></i> My Profile
                                </a>
                                <button class="dropdown-item" @click="logout">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </button>
                            </div>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>

        <main>
            <div v-if="!isEnrolled" class="enrollment-modal">
                <div class="enrollment-content">
                    <div class="enrollment-icon">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h2>You Are Not Enrolled</h2>
                    <p>You need to be enrolled in this course to access the content.</p>
                    <div class="course-preview">
                        <img :src="course.thumbnail" :alt="course.title">
                        <h3>{{ course.title }}</h3>
                    </div>
                    <button class="enroll-btn" @click="redirectToEnroll">
                        <i class="fas fa-graduation-cap"></i>
                        Enroll Now
                    </button>
                </div>
            </div>

            <div v-else-if="loadingEnrollment" class="loading-screen">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <p>Checking enrollment status...</p>
            </div>

            <template v-else>
                <div class="course-header" :style="{
                    background: `linear-gradient(rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.55)), url('${course.thumbnail}')`,
                    backgroundSize: 'cover',
                    backgroundPosition: 'center'
                }">
                    <div class="course-header-content" style="color: white; text-shadow: 0px 1px 4px rgba(0,0,0,0.7);">
                        <h1 style="font-weight: bold;">{{ course.title }}</h1>
                        <p>{{ course.description }}</p>
                        <div class="course-meta-info">
                            <div class="meta-item" v-if="totalVideos > 0">
                                <i class="fas fa-video"></i>
                                <span>{{ totalVideos }} Sessions</span>
                            </div>
                            <div class="meta-item" v-if="loadingVideos">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Loading content...</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-chart-bar"></i>
                                <span>{{ course.progress }}% Complete</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="course-container">
                    <aside class="course-sidebar" :class="{ 'active': sidebarActive }">
                        <div class="sidebar-header">
                            <h3>Course Content</h3>
                            <button class="sidebar-close" @click="toggleSidebar"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="course-progress-container">
                            <div class="progress-bar" :style="{ width: course.progress + '%' }"></div>
                            <span>{{ course.progress }}% Complete</span>
                        </div>
                        <div class="course-modules">
                            <div v-if="loadingVideos" class="loading-content">
                                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                                <p>Loading course content...</p>
                            </div>
                            <div v-else-if="courseSections.length === 0" class="empty-content">
                                <i class="fas fa-video-slash"></i>
                                <p>No content available for this course yet.</p>
                            </div>
                            <div v-else v-for="(day, dayIndex) in courseSections" :key="day.day_number" class="course-module">
                                <div class="module-header" @click="selectVideo(day.mainVideo.id)" :class="{ 'active': isDaySelected(day), 'completed': isDayCompleted(day) }">
                                    <div class="module-title-container">
                                        <i :class="['fas', isDayCompleted(day) ? 'fa-check-circle' : 'fa-play-circle']"></i>
                                        <h4>{{ day.title }}</h4>
                                    </div>
                                    <div class="module-info" @click.stop="toggleModule(dayIndex)">
                                        <span v-if="day.mainVideo && day.mainVideo.resources.length > 0">{{ day.mainVideo.resources.length }} Resource<span v-if="day.mainVideo.resources.length !== 1">s</span></span>
                                        <i :class="['fas', day.expanded ? 'fa-chevron-up' : 'fa-chevron-down']"></i>
                                    </div>
                                </div>
                                <div class="module-content" :class="{ 'expanded': day.expanded }">
                                    <div v-if="day.mainVideo && day.mainVideo.resources.length > 0" class="sidebar-resource-list">
                                        <div v-for="(resourcesInGroup, groupName) in groupResourcesForSidebar(day.mainVideo.resources)" :key="groupName" class="sidebar-resource-group">
                                            <h5 class="sidebar-resource-group-title" v-if="groupName !== 'General Resources'">{{ groupName }}</h5>
                                            <div v-for="resource in resourcesInGroup" :key="resource.title" class="resource-item-sidebar" @click="handleResourceClick(resource)">
                                                <span class="resource-icon-sidebar"><i :class="getResourceIcon(resource.type)"></i></span>
                                                <span class="resource-title-sidebar">{{ resource.title }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <div class="course-content">
                        <div class="content-header">
                            <button class="sidebar-toggle" @click="toggleSidebar">
                                <i class="fas fa-bars"></i> Course Content
                            </button>
                        </div>
                        
                        <div class="video-container-premium" v-if="currentVideo" @mousemove="showControlsOnMove">
                            <div class="video-player-premium" v-if="videoUrl">
                                <div class="video-player-wrapper" @dblclick="handleDblClick">
                                    <video 
                                        ref="videoPlayer"
                                        :key="videoUrl" 
                                        preload="auto" 
                                        @play="isPlaying = true"
                                        @pause="isPlaying = false"
                                        @ended="markVideoCompleted" 
                                        @timeupdate="handleTimeUpdate"
                                        @loadedmetadata="handleLoadedMetadata"
                                        @waiting="handleWaiting"
                                        @playing="handlePlaying"
                                        @error="handleVideoError"
                                        @click="togglePlay"
                                        :src="videoUrl"
                                        class="custom-video-player"
                                    >
                                        Your browser does not support the video tag.
                                    </video>
                                    <div class="loading-overlay" v-if="isLoading || isBuffering">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                    <div class="seek-indicator" ref="seekIndicator">
                                        <i></i>
                                    </div>
                                </div>
                                <div class="custom-video-controls" :class="{ visible: showControls || !isPlaying }">
                                    <button @click.stop="togglePlay" class="control-btn">
                                        <i :class="['fas', isPlaying ? 'fa-pause' : 'fa-play']"></i>
                                    </button>
                                    <div class="seek-bar-container">
                                        <div class="seek-bar-track">
                                            <div class="seek-bar-fill" :style="{ width: progressPercentage + '%' }"></div>
                                        </div>
                                        <input type="range" class="seek-bar" min="0" :max="displayDuration" :value="displayCurrentTime" @mousedown="isDraggingSeekBar = true" @input="handleSeekInput" @change="applySeek" @mouseup="isDraggingSeekBar = false">
                                    </div>
                                    <div class="time-display">{{ formattedDisplayCurrentTime }} / {{ formattedDisplayDuration }}</div>
                                    <div class="volume-control">
                                        <button @click.stop="toggleMute" class="control-btn">
                                            <i :class="['fas', volumeIcon]"></i>
                                        </button>
                                        <input type="range" class="volume-slider" min="0" max="1" step="0.1" :value="volume" @input="handleVolumeChange">
                                    </div>
                                    <div class="settings-control">
                                        <button @click.stop="showSpeedMenu = !showSpeedMenu" class="control-btn">
                                            <i class="fas fa-cog"></i>
                                        </button>
                                        <div class="speed-menu" v-if="showSpeedMenu">
                                            <div v-for="rate in playbackRates" :key="rate" @click="setPlaybackRate(rate)" :class="{ active: currentPlaybackRate === rate }">
                                                {{ rate }}x
                                            </div>
                                        </div>
                                    </div>
                                    <button @click.stop="toggleFullscreenVideo" class="control-btn">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                             <div class="no-video-selected" v-else>
                                <div class="empty-state">
                                    <i class="fas fa-book-open"></i>
                                    <h2>No Video Available</h2>
                                    <p>There is no video for this session. Please check the description and resources below.</p>
                                </div>
                            </div>
                            
                            <div class="video-navigation-premium">
                                <button class="nav-button-premium prev" @click="playPreviousVideo" :disabled="!hasPreviousVideo">
                                    <i class="fas fa-arrow-left"></i> 
                                    <span>Previous Day</span>
                                </button>
                                <div class="video-progress-center">
                                    <div class="video-counter">
                                        Day {{ getCurrentDayNumber() }} of {{ courseSections.length }}
                                    </div>
                                </div>
                                <button class="nav-button-premium next" @click="playNextVideo" :disabled="!hasNextVideo">
                                    <span>Next Day</span>
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>

                            <div class="course-tabs">
                                <button class="tab-btn" :class="{ active: activeTab === 'overview' }" @click="activeTab = 'overview'">Overview</button>
                                <button class="tab-btn" :class="{ active: activeTab === 'resources' }" @click="activeTab = 'resources'" v-if="currentVideo && Object.keys(groupedResources).length > 0">Resources</button>
                                <button class="tab-btn" :class="{ active: activeTab === 'discussion' }" @click="activeTab = 'discussion'">Discussion</button>
                                <button class="tab-btn" :class="{ active: activeTab === 'report' }" @click="activeTab = 'report'">Report Problem</button>
                            </div>

                            <div class="tab-content" v-if="activeTab === 'overview'">
                                <div class="video-description-premium" v-if="currentVideo && currentVideo.description">
                                    <h3>Summary</h3>
                                    <p v-html="formattedDescription"></p>
                                </div>
                                <div v-else>
                                    <p>No description available for this session.</p>
                                </div>
                            </div>

                            <div class="tab-content" v-if="activeTab === 'resources'">
                                <div v-if="currentVideo && Object.keys(groupedResources).length > 0">
                                    <div v-for="(resourcesInGroup, groupName) in groupedResources" :key="groupName" class="resource-group">
                                        <h4 class="resource-group-title" v-if="groupName !== 'General Resources' || Object.keys(groupedResources).length > 1">{{ groupName }}</h4>
                                        <ul class="resource-list">
                                            <li v-for="resource in resourcesInGroup" :key="resource.title" class="resource-item">
                                                <span class="resource-icon"><i :class="getResourceIcon(resource.type)"></i></span>
                                                <span class="resource-title">{{ resource.title }}</span>
                                                <div class="resource-actions">
                                                    <button @click="handleResourceClick(resource)" class="resource-btn resource-btn-view">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                    <button v-if="resource.download_storage_path && resource.download_storage_path !== 'None'" @click.stop="downloadResource(resource)" class="resource-btn resource-btn-download">
                                                        <i class="fas fa-download"></i> Download
                                                    </button>
                                                    <span v-else class="resource-btn resource-btn-download disabled">
                                                        <i class="fas fa-download"></i> Download
                                                    </span>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-content" v-if="activeTab === 'discussion'">
                                <div class="discussion-container">
                                    <div class="comment-input-area">
                                        <textarea v-model="newComment" class="comment-input" placeholder="Ask a question or share your thoughts about this lecture..."></textarea>
                                        <button class="post-btn" @click="postComment" :disabled="!newComment.trim() || submittingComment">
                                            {{ submittingComment ? 'Posting...' : 'Post' }}
                                        </button>
                                    </div>
                                    <div v-if="loadingComments" class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                                    <div v-else-if="comments.length === 0" style="color: #64748b; font-style: italic;">No comments yet. Be the first to start the discussion!</div>
                                    <div v-else class="comment-list">
                                        <div v-for="comment in comments" :key="comment.id" class="comment-item">
                                            <div class="comment-header">
                                                <span class="comment-author">{{ comment.user_email.split('@')[0] }}</span>
                                                <span class="comment-date">{{ new Date(comment.created_at).toLocaleDateString() }}</span>
                                            </div>
                                            <div class="comment-body">{{ comment.content }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-content" v-if="activeTab === 'report'">
                                <div class="report-form">
                                    <h3>Report a Problem</h3>
                                    <p>Encountered an issue with this video or content? Let us know.</p>
                                    <textarea v-model="reportDescription" class="report-textarea" placeholder="Describe the issue you are facing..."></textarea>
                                    <button class="report-submit-btn" @click="submitReport" :disabled="!reportDescription.trim() || submittingReport">
                                        {{ submittingReport ? 'Submitting...' : 'Submit Report' }}
                                    </button>
                                </div>
                            </div>

                        </div>
                        
                        <div class="no-video-selected" v-else>
                            <div class="empty-state">
                                <i class="fas fa-play-circle"></i>
                                <h2>Select a Day to start learning</h2>
                                <p>Choose a Day from the course outline to begin your learning journey.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </main>

        <div id="resource-viewer-modal" :class="{ 'visible': isViewerVisible }">
            <div class="resource-viewer-content" ref="viewerContent">
                <div class="resource-viewer-header">
                    <h2 class="resource-viewer-title">{{ currentResource ? currentResource.title : 'Resource Preview' }}</h2>
                    <div>
                        <button class="resource-viewer-fullscreen-button" @click="toggleFullscreen">
                            <i :class="['fas', isFullscreen ? 'fa-compress' : 'fa-expand']"></i>
                        </button>
                        <button class="resource-viewer-close-button" @click="closeResourceViewer">×</button>
                    </div>
                </div>
                <div class="viewer-main-content">
                    <div v-if="viewerLoading" class="loading-screen">
                        <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                        <p>Loading Document...</p>
                    </div>
                    <div v-if="previewType === 'pdf'" class="pdf-canvas-container">
                        <canvas id="pdf-canvas"></canvas>
                    </div>
                    <div v-if="previewType === 'csv'" class="csv-preview-container">
                        <table class="csv-preview-table">
                            <thead v-if="csvData && csvData.header.length > 0">
                                <tr>
                                    <th v-for="(col, index) in csvData.header" :key="index">{{ col }}</th>
                                </tr>
                            </thead>
                            <tbody v-if="csvData && csvData.rows.length > 0">
                                <tr v-for="(row, rowIndex) in csvData.rows" :key="rowIndex">
                                    <td v-for="(cell, cellIndex) in row" :key="cellIndex" :title="cell">{{ cell }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="resource-viewer-controls">
                    <button v-if="previewType === 'pdf'" id="pdf-prev-page" class="viewer-nav-button" @click="goToPrevPage" :disabled="pdfCurrentPage <= 1">Previous</button>
                    <span v-if="previewType === 'pdf'" id="pdf-page-info">Page {{ pdfCurrentPage }} of {{ pdfTotalPages }}</span>
                    <button @click="downloadResource(currentResource)" class="viewer-nav-button viewer-download-btn" :disabled="!currentResource || !currentResource.download_storage_path || currentResource.download_storage_path === 'None'">Download</button>
                    <button v-if="previewType === 'pdf'" id="pdf-next-page" class="viewer-nav-button" @click="goToNextPage" :disabled="pdfCurrentPage >= pdfTotalPages">Next</button>
                </div>
            </div>
        </div>

        <footer class="footer-enhanced" v-if="isEnrolled">
            <div class="footer-content">
                <div class="footer-main">
                    <div class="footer-brand">
                        <img src="https://www.mystudentclub.com/assets/logo.png" alt="My Student Club Logo" class="logo-enhanced">
                        <h4>My Student Club</h4>
                        <p>Empowering the next generation of Chartered Accountants with world-class education and resources.</p>
                        <div class="social-links">
                            <a href="https://www.linkedin.com/company/mystudentclub" target="_blank" rel="noopener noreferrer"><i class="fab fa-linkedin"></i></a>
                            <a href="https://www.instagram.com/mystudentclub/" target="_blank" rel="noopener noreferrer"><i class="fab fa-instagram"></i></a>
                            <a href="https://www.youtube.com/@MyStudentClub" target="_blank" rel="noopener noreferrer"><i class="fab fa-youtube"></i></a>
                        </div>
                    </div>
                    <div class="footer-links">
                        <div class="footer-column">
                            <h5>Learning</h5>
                            <ul>
                                <li><a href="index.html">My Dashboard</a></li>
                                <li><a href="lms-resources.html">Resources Hub</a></li>
                                <li><a href="https://mystudentclub.com/cv-reviewer/">CV Review</a></li>
                            </ul>
                        </div>
                        <div class="footer-column">
                            <h5>Support</h5>
                            <ul>
                                <li><a href="mailto:support@mystudentclub.com">Contact Us</a></li>
                                <li><a href="https://mystudentclub.com/privacy-policy">Privacy Policy</a></li>
                                <li><a href="https://mystudentclub.com/terms">Terms of Service</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>© 2025 My Student Club LMS. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>

    <script type="module">
        import { createApp } from 'vue';
        
        const supabaseUrl = 'https://izsggdtdiacxdsjjncdq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6c2dnZHRkaWFjeGRzampuY2RxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1OTEzNjUsImV4cCI6MjA1NDE2NzM2NX0.FVKBJG-TmXiiYzBDjGIRBM2zg-DYxzNP--WM6q2UMt0';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js`;
        
        createApp({
            data() {
                return {
                    menuActive: false,
                    sidebarActive: false,
                    courseSlug: null,
                    user: null,
                    isEnrolled: false,
                    loadingEnrollment: true,
                    loadingVideos: false,
                    totalVideos: 0,
                    course: {
                        title: '',
                        description: '',
                        thumbnail: '',
                        progress: 0
                    },
                    courseSections: [],
                    currentVideoId: null,
                    activeTab: 'overview',
                    comments: [],
                    newComment: '',
                    loadingComments: false,
                    submittingComment: false,
                    reportDescription: '',
                    submittingReport: false,
                    errorLogCount: 0,
                    courses: {
                        'industrial-training-mastery': {
                            title: 'CA Industrial Training Program',
                            description: 'Master industrial training requirements for CA candidates with real-world case studies.',
                            thumbnail: 'https://mystudentclub.com/assets/courseimg-industrial.png'
                        },
                        'msc-ca-freshers-program': {
                            title: 'MSC CA Freshers Program',
                            description: 'A comprehensive program for CA freshers to kickstart their career.',
                            thumbnail: 'https://mystudentclub.com/assets/courseimg-fresher.png'
                        }
                    },
                    videoStartTimes: {
                        1: 170, 
                        2: 119, 
                        4: 26,  
                        6: 39,  
                        7: 52   
                    },
                    virtualStartTime: 0,
                    isViewerVisible: false,
                    viewerLoading: false,
                    pdfCurrentPage: 1,
                    pdfTotalPages: 1,
                    currentResource: null,
                    previewType: null,
                    csvData: null,
                    isFullscreen: false,
                    isPlaying: false,
                    currentTime: 0,
                    duration: 0,
                    volume: 1,
                    isMuted: false,
                    showControls: false,
                    controlsTimeout: null,
                    seekIndicatorTimeout: null,
                    isLoading: false,
                    isBuffering: false,
                    isDraggingSeekBar: false,
                    playbackRates: [0.5, 0.75, 1, 1.25, 1.5, 2],
                    currentPlaybackRate: 1,
                    showSpeedMenu: false,
                    retryCount: 0,
                    maxRetries: 5
                }
            },
            computed: {
                currentVideo() {
                    if (!this.currentVideoId) return null;
                    for (const section of this.courseSections) {
                        const video = section.videos.find(v => v.id === this.currentVideoId);
                        if (video) return video;
                    }
                    return null;
                },
                videoUrl() {
                    if (!this.currentVideo || !this.isEnrolled || !this.currentVideo.fileName) return '';
                    return `https://advertisement.bhansalimanan55.workers.dev/stream/${encodeURIComponent(this.currentVideo.fileName)}`;
                },
                hasPreviousVideo() {
                    return this.getAdjacentVideo('previous') !== null;
                },
                hasNextVideo() {
                    return this.getAdjacentVideo('next') !== null;
                },
                formattedDescription() {
                    if (this.currentVideo && this.currentVideo.description) {
                        return this.currentVideo.description.replace(/\n/g, '<br>');
                    }
                    return '';
                },
                groupedResources() {
                    if (!this.currentVideo || !this.currentVideo.resources || this.currentVideo.resources.length === 0) return {};
                    const groups = {};
                    this.currentVideo.resources.forEach(res => {
                        const groupKey = res.group || 'General Resources';
                        if (!groups[groupKey]) {
                            groups[groupKey] = [];
                        }
                        groups[groupKey].push(res);
                    });
                    return groups;
                },
                displayCurrentTime() {
                    return Math.max(0, this.currentTime - this.virtualStartTime);
                },
                displayDuration() {
                    return Math.max(0, this.duration - this.virtualStartTime);
                },
                formattedDisplayCurrentTime() {
                    const time = this.displayCurrentTime;
                    if (isNaN(time)) return '0:00';
                    const hours = Math.floor(time / 3600);
                    const minutes = Math.floor((time % 3600) / 60).toString().padStart(2, '0');
                    const seconds = Math.floor(time % 60).toString().padStart(2, '0');
                    if (hours > 0) {
                        return `${hours}:${minutes}:${seconds}`;
                    }
                    return `${minutes}:${seconds}`;
                },
                formattedDisplayDuration() {
                    const time = this.displayDuration;
                    if (isNaN(time) || time <= 0) return '0:00';
                    const hours = Math.floor(time / 3600);
                    const minutes = Math.floor((time % 3600) / 60).toString().padStart(2, '0');
                    const seconds = Math.floor(time % 60).toString().padStart(2, '0');
                    if (hours > 0) {
                        return `${hours}:${minutes}:${seconds}`;
                    }
                    return `${minutes}:${seconds}`;
                },
                volumeIcon() {
                    if (this.isMuted || this.volume === 0) return 'fa-volume-mute';
                    if (this.volume < 0.5) return 'fa-volume-down';
                    return 'fa-volume-up';
                },
                progressPercentage() {
                    if (this.displayDuration <= 0) return 0;
                    return (this.displayCurrentTime / this.displayDuration) * 100;
                }
            },
            methods: {
                async checkAuth() {
                    const { data: { session }, error } = await supabase.auth.getSession();
                    if (session && session.user) {
                        this.user = session.user;
                        await this.checkEnrollment();
                    } else {
                        this.user = null;
                        window.location.href = 'https://www.mystudentclub.com/login';
                    }
                },
                getUserDisplayName() {
                    if (!this.user) return 'Student';
                    return this.user.user_metadata?.full_name || this.user.email.split('@')[0];
                },
                async logout() {
                    await supabase.auth.signOut();
                    window.location.href = 'https://www.mystudentclub.com/login';
                },
                async checkEnrollment() {
                    try {
                        const { data: enrollments, error } = await supabase
                            .from('enrollment')
                            .select('course')
                            .eq('uuid', this.user.id)
                            .eq('course', this.courseSlug);

                        if (error || !enrollments || enrollments.length === 0) {
                            this.isEnrolled = false;
                        } else {
                            this.isEnrolled = true;
                            await this.loadCourseVideos();
                        }
                    } catch (error) {
                        this.isEnrolled = false;
                    } finally {
                        this.loadingEnrollment = false;
                    }
                },
                async loadCourseVideos() {
                    this.loadingVideos = true;
                    try {
                        const { data: videoMetadata, error: metadataError } = await supabase
                            .from('videos')
                            .select('video_number, title, description, day_number, resources')
                            .eq('course', this.courseSlug)
                            .order('day_number', { ascending: true })
                            .order('video_number', { ascending: true });

                        if (metadataError) throw metadataError;

                        const videosByDay = {};
                        if (videoMetadata && videoMetadata.length > 0) {
                             for (const meta of videoMetadata) {
                                try {
                                    const { data: rpcData, error: rpcError } = await supabase.rpc('get_video_link', {
                                        course_name_param: this.courseSlug,
                                        video_number_param: meta.video_number
                                    });
                                    
                                    const day = meta.day_number || 1;
                                    if (!videosByDay[day]) {
                                        videosByDay[day] = [];
                                    }
                                    videosByDay[day].push({
                                        id: meta.video_number,
                                        fileName: rpcData || null,
                                        title: meta.title || `Content for Day ${day}`,
                                        description: meta.description || '',
                                        resources: meta.resources || [],
                                        completed: false
                                    });
                                } catch (err) {
                                }
                            }
                        }
                        
                        this.courseSections = Object.keys(videosByDay).map(dayNum => {
                            const dayVideos = videosByDay[dayNum];
                            const mainVideo = dayVideos[0] || {};
                            return {
                                day_number: parseInt(dayNum),
                                title: mainVideo.title || `Day ${dayNum}`,
                                expanded: parseInt(dayNum) === 1,
                                videos: dayVideos,
                                mainVideo: mainVideo
                            };
                        }).sort((a, b) => a.day_number - b.day_number);
                        
                        this.totalVideos = videoMetadata ? videoMetadata.length : 0;
                        this.loadVideoProgress();
                    } catch (error) {
                        this.logFrontendError(error.message, error.stack, 'loadCourseVideos');
                    } finally {
                        this.loadingVideos = false;
                    }
                },
                getResourceIcon(type) {
                    const iconMap = {
                        pdf: 'fas fa-file-pdf',
                        image: 'fas fa-file-image',
                        doc: 'fas fa-file-word',
                        docx: 'fas fa-file-word',
                        txt: 'fas fa-file-alt',
                        external_link: 'fas fa-external-link-alt',
                        video: 'fas fa-file-video',
                        archive: 'fas fa-file-archive',
                        spreadsheet: 'fas fa-file-excel',
                        xlsx: 'fas fa-file-excel',
                        csv: 'fas fa-file-csv'
                    };
                    return iconMap[type ? type.toLowerCase() : ''] || 'fas fa-file';
                },
                groupResourcesForSidebar(resources) {
                    if (!resources || resources.length === 0) return {};
                    const groups = {};
                    resources.forEach(res => {
                        const groupKey = res.group || 'General Resources';
                        if (!groups[groupKey]) {
                            groups[groupKey] = [];
                        }
                        groups[groupKey].push(res);
                    });
                    return groups;
                },
                handleProfileClick() {
                    if (!this.user) {
                        window.location.href = 'https://www.mystudentclub.com/login';
                    }
                },
                redirectToEnroll() {
                    window.location.href = 'https://www.mystudentclub.com/login';
                },
                toggleMenu() {
                    this.menuActive = !this.menuActive;
                },
                toggleSidebar() {
                    this.sidebarActive = !this.sidebarActive;
                },
                toggleModule(dayIndex) {
                    this.courseSections[dayIndex].expanded = !this.courseSections[dayIndex].expanded;
                },
                selectVideo(videoId) {
                    this.retryCount = 0;
                    this.isLoading = true;
                    this.currentVideoId = videoId;
                    this.virtualStartTime = this.videoStartTimes[videoId] || 0;
                    this.activeTab = 'overview'; 
                    this.comments = []; 
                    if (window.innerWidth < 768) {
                        this.sidebarActive = false;
                    }
                    localStorage.setItem(`lastVideoId_${this.courseSlug}`, videoId);
                    this.fetchComments();
                },
                getAdjacentVideo(direction) {
                    if (!this.currentVideoId) return null;
                    const allVideos = this.courseSections.map(section => section.videos[0]).filter(Boolean);
                    const currentIndex = allVideos.findIndex(video => video.id === this.currentVideoId);
                    if (currentIndex === -1) return null;
                    if (direction === 'previous' && currentIndex > 0) {
                        return allVideos[currentIndex - 1];
                    } else if (direction === 'next' && currentIndex < allVideos.length - 1) {
                        return allVideos[currentIndex + 1];
                    }
                    return null;
                },
                playPreviousVideo() {
                    const prevVideo = this.getAdjacentVideo('previous');
                    if (prevVideo) {
                        this.selectVideo(prevVideo.id);
                    }
                },
                playNextVideo() {
                    const nextVideo = this.getAdjacentVideo('next');
                    if (nextVideo) {
                        this.selectVideo(nextVideo.id);
                    }
                },
                markVideoCompleted() {
                    if (!this.currentVideoId) return;
                    const videoToMark = this.findVideoById(this.currentVideoId);
                    if (videoToMark && !videoToMark.completed) {
                        videoToMark.completed = true;
                        this.saveVideoProgress();
                        this.updateCourseProgress();
                        this.updateLearningStreak();
                    }
                },
                findVideoById(videoId) {
                    for (const section of this.courseSections) {
                        const foundVideo = section.videos.find(v => v.id === videoId);
                        if (foundVideo) return foundVideo;
                    }
                    return null;
                },
                saveVideoProgress() {
                    const completedVideos = {};
                    this.courseSections.forEach(section => {
                        section.videos.forEach(video => {
                            if (video.completed) {
                                completedVideos[video.id] = true;
                            }
                        });
                    });
                    const existingData = localStorage.getItem(`courseVideos_${this.courseSlug}`);
                    let mergedData = {};
                    if (existingData) {
                        try {
                            mergedData = JSON.parse(existingData);
                        } catch (e) {}
                    }
                    const newData = { ...mergedData, ...completedVideos };
                    localStorage.setItem(`courseVideos_${this.courseSlug}`, JSON.stringify(newData));
                },
                loadVideoProgress() {
                    const savedVideos = localStorage.getItem(`courseVideos_${this.courseSlug}`);
                    if (savedVideos) {
                        try {
                            const completedVideos = JSON.parse(savedVideos);
                            this.courseSections.forEach(section => {
                                section.videos.forEach(video => {
                                    if (completedVideos[video.id] === true) {
                                        video.completed = true;
                                    }
                                });
                            });
                        } catch(e) {
                            console.error("Error parsing progress", e);
                        }
                    }
                    this.updateCourseProgress(); 
                    const lastVideoId = localStorage.getItem(`lastVideoId_${this.courseSlug}`);
                    if (lastVideoId && this.findVideoById(parseInt(lastVideoId))) {
                        this.selectVideo(parseInt(lastVideoId));
                    } else if (this.courseSections.length > 0 && this.courseSections[0].videos.length > 0) {
                        this.selectVideo(this.courseSections[0].videos[0].id);
                    }
                },
                updateCourseProgress() {
                    let totalCount = 0;
                    let completedCount = 0;
                    this.courseSections.forEach(section => {
                        section.videos.forEach(video => {
                            totalCount++;
                            if (video.completed) completedCount++;
                        });
                    });
                    this.course.progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                },
                updateLearningStreak() {
                    const today = new Date().toDateString();
                    const lastActivity = localStorage.getItem('lastLearningActivity');
                    if (lastActivity !== today) {
                        localStorage.setItem('lastLearningActivity', today);
                        const currentStreak = parseInt(localStorage.getItem('learningStreak') || '0');
                        localStorage.setItem('learningStreak', (currentStreak + 1).toString());
                    }
                },
                loadCourseData() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.courseSlug = urlParams.get('course');
                    if (!this.courseSlug || !this.courses[this.courseSlug]) {
                        window.location.href = 'index.html';
                        return;
                    }
                    this.course = { ...this.courses[this.courseSlug], progress: 0 };
                },
                getCurrentDayNumber() {
                    if (!this.currentVideoId) return 0;
                    const section = this.courseSections.find(s => s.videos.some(v => v.id === this.currentVideoId));
                    return section ? section.day_number : 0;
                },
                isDaySelected(day) {
                    return day.videos.some(v => v.id === this.currentVideoId);
                },
                isDayCompleted(day) {
                    return day.videos.every(v => v.completed);
                },
                async handleResourceClick(resource) {
                    if (resource.type === 'external_link' && resource.url) {
                        window.open(resource.url, '_blank');
                        return;
                    }

                    if (resource.view_storage_path && resource.view_storage_path !== 'None') {
                        const path = resource.view_storage_path.toLowerCase();
                        if (path.endsWith('.csv')) {
                            await this.openResourceViewer(resource, 'csv');
                        } else {
                            await this.openResourceViewer(resource, 'pdf');
                        }
                        return;
                    }
                    
                    this.downloadResource(resource);
                },
                async downloadResource(resource) {
                    const path = resource.download_storage_path;
                    if (!path || path === 'None') {
                        alert('No downloadable file available for this resource.');
                        return;
                    }

                    try {
                        const { data, error } = await supabase.storage
                            .from('industrial-training-mastery-resources')
                            .createSignedUrl(path, 300);

                        if (error) throw error;

                        const response = await fetch(data.signedUrl);
                        if (!response.ok) throw new Error('Network response was not ok.');
                        const blob = await response.blob();
                        const filename = path.split('/').pop() || 'download';

                        if (window.flutter_inappwebview && typeof window.flutter_inappwebview.callHandler === 'function') {
                            const reader = new FileReader();
                            reader.readAsDataURL(blob);
                            reader.onloadend = function() {
                                const base64data = reader.result;
                                const base64Content = base64data.split(',')[1];
                                window.flutter_inappwebview.callHandler('blobToBase64Handler', base64Content, filename);
                            };
                        } else {
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            a.remove();
                        }
                    } catch (err) {
                        console.error('Download error:', err);
                        alert('Could not download the file. Please try again.');
                    }
                },
                async openResourceViewer(resource, type) {
                    this.pdfDoc = null;
                    this.csvData = null;
                    this.pdfCurrentPage = 1;
                    this.pdfTotalPages = 1;
                    const canvas = document.getElementById('pdf-canvas');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }

                    this.viewerLoading = true;
                    this.isViewerVisible = true;
                    this.currentResource = resource;
                    this.previewType = type;

                    try {
                        const { data, error } = await supabase.storage
                            .from('industrial-training-mastery-resources')
                            .createSignedUrl(resource.view_storage_path, 300);

                        if (error) throw error;
                        
                        const workerUrl = 'https://pdf-proxy-viewer.bhansalimanan55.workers.dev/';
                        const proxiedUrl = `${workerUrl}?url=${encodeURIComponent(data.signedUrl)}`;

                        const response = await fetch(proxiedUrl);
                        if (!response.ok) throw new Error(`Failed to fetch from proxy: ${response.status}`);

                        if (type === 'pdf') {
                            const pdfData = await response.arrayBuffer();
                            this.pdfDoc = await pdfjsLib.getDocument(pdfData).promise;
                            this.pdfTotalPages = this.pdfDoc.numPages;
                            await this.renderPdfPage(1);
                        } else if (type === 'csv') {
                            const csvText = await response.text();
                            const lines = csvText.split('\n').filter(line => line.trim() !== '');
                            const header = lines.length > 0 ? lines[0].split(',').map(h => h.trim()) : [];
                            const rows = lines.length > 1 ? lines.slice(1).map(line => line.split(',').map(cell => cell.trim())) : [];
                            this.csvData = { header, rows };
                        }
                    } catch (err) {
                        alert("Could not load the resource for viewing.");
                        this.closeResourceViewer();
                    } finally {
                        this.viewerLoading = false;
                    }
                },
                async renderPdfPage(num) {
                    if (!this.pdfDoc) return;
                    this.pdfCurrentPage = num;
                    const page = await this.pdfDoc.getPage(num);
                    const canvas = document.getElementById('pdf-canvas');
                    const ctx = canvas.getContext('2d');
                    const viewport = page.getViewport({ scale: 1.5 });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    const renderContext = { canvasContext: ctx, viewport: viewport };
                    await page.render(renderContext).promise;
                    this.drawWatermark(canvas, ctx);
                },
                drawWatermark(canvas, ctx) {
                    const watermarkText = this.user ? this.user.email : 'MyStudentClub';
                    ctx.font = '20px Arial';
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    const x_step = 250;
                    const y_step = 150;
                    
                    ctx.save();
                    for (let y = y_step / 2; y < canvas.height; y += y_step) {
                        for (let x = x_step / 2; x < canvas.width; x += x_step) {
                            ctx.save();
                            ctx.translate(x, y);
                            ctx.rotate(-Math.PI / 4);
                            ctx.fillText(watermarkText, 0, 0);
                            ctx.restore();
                        }
                    }
                    ctx.restore();
                },
                closeResourceViewer() {
                    if (this.isFullscreen) {
                        this.toggleFullscreen();
                    }
                    this.isViewerVisible = false;
                    this.pdfDoc = null;
                    this.currentResource = null;
                    this.previewType = null;
                    this.csvData = null;
                },
                goToPrevPage() {
                    if (this.pdfCurrentPage > 1) {
                        this.renderPdfPage(this.pdfCurrentPage - 1);
                    }
                },
                goToNextPage() {
                    if (this.pdfCurrentPage < this.pdfTotalPages) {
                        this.renderPdfPage(this.pdfCurrentPage + 1);
                    }
                },
                toggleFullscreen() {
                    const elem = this.$refs.viewerContent;
                    if (!document.fullscreenElement) {
                        elem.requestFullscreen().catch(err => {
                            alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                        });
                    } else {
                        document.exitFullscreen();
                    }
                },
                togglePlay() {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        video.paused ? video.play() : video.pause();
                    }
                },
                handleTimeUpdate() {
                    const video = this.$refs.videoPlayer;
                    if (video && !this.isDraggingSeekBar) {
                        this.currentTime = video.currentTime;
                    }
                },
                handleLoadedMetadata() {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        this.duration = video.duration;
                        this.isLoading = false;
                        this.isBuffering = false;
                        this.retryCount = 0;

                        if (this.virtualStartTime > 0 && video.currentTime < this.virtualStartTime) {
                            video.currentTime = this.virtualStartTime;
                        }
                    }
                },
                handleWaiting() {
                    this.isBuffering = true;
                },
                handlePlaying() {
                    this.isBuffering = false;
                },
                handleVideoError() {
                    this.isLoading = false;
                    this.isBuffering = false;
                    this.attemptReload();
                },
                attemptReload() {
                    if (this.retryCount < this.maxRetries) {
                        this.retryCount++;
                        const delay = Math.pow(2, this.retryCount) * 1000;
                        setTimeout(() => {
                            const video = this.$refs.videoPlayer;
                            if (video) {
                                this.isLoading = true;
                                const currentTime = video.currentTime;
                                video.load();
                                video.play().then(() => {
                                    video.currentTime = currentTime;
                                }).catch(() => {});
                            }
                        }, delay);
                    } else {
                        alert("Failed to load the video after multiple attempts. Please check your connection or try again later.");
                    }
                },
                handleSeekInput(event) {
                    this.isDraggingSeekBar = true;
                    const displayTime = parseFloat(event.target.value);
                    this.currentTime = displayTime + this.virtualStartTime;
                },
                applySeek(event) {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        const seekTime = parseFloat(event.target.value);
                        video.currentTime = seekTime + this.virtualStartTime;
                    }
                    this.isDraggingSeekBar = false;
                },
                toggleMute() {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        video.muted = !video.muted;
                        this.isMuted = video.muted;
                    }
                },
                handleVolumeChange(event) {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        const newVolume = event.target.value;
                        video.volume = newVolume;
                        this.volume = newVolume;
                        if (newVolume > 0) {
                            video.muted = false;
                            this.isMuted = false;
                        }
                    }
                },
                toggleFullscreenVideo() {
                    const playerContainer = this.$refs.videoPlayer.parentElement.parentElement;
                    if (!document.fullscreenElement) {
                        playerContainer.requestFullscreen().catch(err => {
                            alert(`Error enabling full-screen mode: ${err.message}`);
                        });
                    } else {
                        document.exitFullscreen();
                    }
                },
                handleDblClick(event) {
                    const video = this.$refs.videoPlayer;
                    if (!video) return;
                    const rect = video.getBoundingClientRect();
                    const clickX = event.clientX - rect.left;
                    if (clickX < rect.width * 0.4) {
                        video.currentTime = Math.max(0, video.currentTime - 10);
                        this.showSeekIndicator('backward');
                    } else if (clickX > rect.width * 0.6) {
                        video.currentTime = Math.min(video.duration, video.currentTime + 10);
                        this.showSeekIndicator('forward');
                    }
                },
                handleKeydown(event) {
                    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    const video = this.$refs.videoPlayer;
                    if (!video) return;
                    switch (event.key) {
                        case 'ArrowLeft':
                            event.preventDefault();
                            video.currentTime = Math.max(0, video.currentTime - 10);
                            this.showSeekIndicator('backward');
                            break;
                        case 'ArrowRight':
                            event.preventDefault();
                            video.currentTime = Math.min(video.duration, video.currentTime + 10);
                            this.showSeekIndicator('forward');
                            break;
                        case ' ':
                            event.preventDefault();
                            this.togglePlay();
                            break;
                    }
                },
                showSeekIndicator(direction) {
                    const indicator = this.$refs.seekIndicator;
                    const icon = indicator.querySelector('i');
                    if (!indicator || !icon) return;
                    icon.className = `fas fa-fast-${direction}`;
                    indicator.classList.add('show', direction);
                    if (this.seekIndicatorTimeout) {
                        clearTimeout(this.seekIndicatorTimeout);
                    }
                    this.seekIndicatorTimeout = setTimeout(() => {
                        indicator.classList.remove('show', 'forward', 'backward');
                    }, 500);
                },
                showControlsOnMove() {
                    this.showControls = true;
                    if (this.controlsTimeout) {
                        clearTimeout(this.controlsTimeout);
                    }
                    if (this.isPlaying) {
                        this.controlsTimeout = setTimeout(() => {
                            this.showControls = false;
                        }, 3000);
                    }
                },
                setPlaybackRate(rate) {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        video.playbackRate = rate;
                        this.currentPlaybackRate = rate;
                        this.showSpeedMenu = false;
                    }
                },
                async fetchComments() {
                    if (!this.currentVideoId) return;
                    this.loadingComments = true;
                    try {
                        const { data, error } = await supabase
                            .from('video_comments')
                            .select('*')
                            .eq('course_slug', this.courseSlug)
                            .eq('video_id', this.currentVideoId.toString())
                            .order('created_at', { ascending: false });
                        
                        if (error) throw error;
                        this.comments = data || [];
                    } catch (error) {
                        console.error('Error fetching comments:', error);
                    } finally {
                        this.loadingComments = false;
                    }
                },
                async postComment() {
                    if (!this.newComment.trim() || !this.user) return;
                    this.submittingComment = true;
                    try {
                        const { data, error } = await supabase
                            .from('video_comments')
                            .insert({
                                course_slug: this.courseSlug,
                                video_id: this.currentVideoId.toString(),
                                user_id: this.user.id,
                                user_email: this.user.email,
                                content: this.newComment.trim()
                            })
                            .select();
                        
                        if (error) throw error;
                        if (data && data.length > 0) {
                            this.comments.unshift(data[0]);
                            this.newComment = '';
                        }
                    } catch (error) {
                        alert('Failed to post comment. Please try again.');
                        console.error(error);
                    } finally {
                        this.submittingComment = false;
                    }
                },
                async submitReport() {
                    if (!this.reportDescription.trim() || !this.user) return;
                    this.submittingReport = true;
                    try {
                        const { error } = await supabase
                            .from('course_reports')
                            .insert({
                                user_id: this.user.id,
                                course_slug: this.courseSlug,
                                description: this.reportDescription,
                                page_url: window.location.href
                            });
                        
                        if (error) throw error;
                        alert('Report submitted successfully. We will look into it.');
                        this.reportDescription = '';
                        this.activeTab = 'overview';
                    } catch (error) {
                        alert('Failed to submit report.');
                        console.error(error);
                    } finally {
                        this.submittingReport = false;
                    }
                },
                async logFrontendError(message, stack, source) {
                    if (this.errorLogCount >= 6) return;
                    this.errorLogCount++;
                    try {
                        const { error } = await supabase
                            .from('frontend_errors')
                            .insert({
                                user_id: this.user ? this.user.id : null,
                                error_message: message,
                                stack_trace: stack,
                                url: window.location.href,
                                user_agent: navigator.userAgent
                            });
                    } catch (e) {
                        console.error("Failed to log error to DB", e);
                    }
                }
            },
            async mounted() {
                const self = this;
                window.onerror = function(msg, url, line, col, error) {
                    self.logFrontendError(msg, error ? error.stack : `Line: ${line}, Col: ${col}`, url);
                    return false;
                };

                this.pdfDoc = null; 
                this.loadCourseData();
                await this.checkAuth();
                
                supabase.auth.onAuthStateChange(async (_event, session) => {
                    if (session && session.user) {
                        this.user = session.user;
                        if (!this.isEnrolled) {
                            await this.checkEnrollment();
                        }
                    } else {
                        this.user = null;
                        window.location.href = 'https://www.mystudentclub.com/login';
                    }
                });
                
                document.addEventListener('fullscreenchange', () => {
                    this.isFullscreen = !!document.fullscreenElement;
                });
                document.addEventListener('keydown', this.handleKeydown);
            },
            beforeUnmount() {
                document.removeEventListener('keydown', this.handleKeydown);
            }
        }).mount('#app');
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Details | My Student Club LMS</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="course-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="importmap">
    {
        "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
        }
    }
    </script>
</head>
<body>
    <div id="app">
        <header class="glass-header">
            <div class="header-container">
                <div class="logo-container">
                    <img src="https://www.mystudentclub.com/assets/logo.png" alt="My Student Club Logo" class="logo">
                </div>
                <nav>
                    <div class="hamburger-menu" @click="toggleMenu">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                    <ul class="nav-links" :class="{ 'active': menuActive }">
                        <li><a href="index.html" class="nav-item">
                            <i class="fas fa-graduation-cap"></i>
                            <span>Courses</span>
                        </a></li>
                        <li><a href="resources.html" class="nav-item">
                            <i class="fas fa-book-open"></i>
                            <span>Resources</span>
                        </a></li>
                        <li><a href="cv-submission.html" class="nav-item">
                            <i class="fas fa-file-alt"></i>
                            <span>CV Review</span>
                        </a></li>
                        <li class="profile-link">
                            <a href="#" class="nav-item profile-nav" @click="handleProfileClick">
                                <div class="profile-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <span v-if="user">{{ user.email.split('@')[0] }}</span>
                                <span v-else>Login</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>

        <main>
            <div v-if="!isEnrolled && !loadingEnrollment" class="enrollment-modal">
                <div class="enrollment-content">
                    <div class="enrollment-icon">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h2>You Are Not Enrolled</h2>
                    <p>You need to be enrolled in this course to access the content.</p>
                    <div class="course-preview">
                        <img :src="course.thumbnail" :alt="course.title">
                        <h3>{{ course.title }}</h3>
                    </div>
                    <button class="enroll-btn" @click="redirectToEnroll">
                        <i class="fas fa-graduation-cap"></i>
                        Enroll Now
                    </button>
                </div>
            </div>

            <div v-else-if="loadingEnrollment || loadingInitialVideoList" class="loading-screen">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <p v-if="loadingEnrollment">Checking enrollment status...</p>
                <p v-if="loadingInitialVideoList">Loading course videos...</p>
            </div>

            <template v-else>
                <div class="course-header" :style="{ 'background-image': `linear-gradient(rgba(44, 62, 80, 0.85), rgba(44, 62, 80, 0.85)), url(${course.thumbnail})` }">
                    <div class="course-header-content">
                        <h1>{{ course.title }}</h1>
                        <p>{{ course.description }}</p>
                        <div class="course-meta-info">
                            <div class="meta-item" v-if="totalDiscoveredVideos > 0">
                                <i class="fas fa-video"></i>
                                <span>{{ totalDiscoveredVideos }} Videos</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-chart-bar"></i>
                                <span>{{ courseProgress }}% Complete</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="course-container">
                    <aside class="course-sidebar" :class="{ 'active': sidebarActive }">
                        <div class="sidebar-header">
                            <h3>Course Content</h3>
                            <button class="sidebar-close" @click="toggleSidebar"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="course-progress-container">
                            <div class="progress-bar" :style="{ width: courseProgress + '%' }"></div>
                            <span>{{ courseProgress }}% Complete</span>
                        </div>
                        <div class="course-modules">
                             <div v-if="videoListForSidebar.length === 0 && !loadingInitialVideoList" class="empty-content">
                                <i class="fas fa-video-slash"></i>
                                <p>No videos found for this course or you are not enrolled.</p>
                            </div>
                            <div v-else class="course-module">
                                <div class="module-header" @click="moduleExpanded = !moduleExpanded">
                                    <h4>{{ course.title || 'Course Videos' }}</h4>
                                    <div class="module-info">
                                        <span>{{ totalDiscoveredVideos }} Videos</span>
                                        <i :class="['fas', moduleExpanded ? 'fa-chevron-up' : 'fa-chevron-down']"></i>
                                    </div>
                                </div>
                                <div class="module-content" :class="{ 'expanded': moduleExpanded }">
                                    <div v-for="video in videoListForSidebar" :key="video.id"
                                        class="video-item"
                                        :class="{ 'active': currentVideoId === video.id, 'completed': video.completed }"
                                        @click="selectVideo(video.id)">
                                        <div class="video-status">
                                            <i v-if="video.completed" class="fas fa-check-circle"></i>
                                            <i v-else-if="currentVideoId === video.id" class="fas fa-play-circle"></i>
                                            <i v-else class="far fa-circle"></i>
                                        </div>
                                        <div class="video-details">
                                            <p>{{ video.title }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <div class="course-content">
                        <div class="content-header">
                            <button class="sidebar-toggle" @click="toggleSidebar">
                                <i class="fas fa-bars"></i> Course Content
                            </button>
                        </div>
                        
                        <div class="video-container" v-if="currentVideoId && !loadingVideoUrl">
                            <h2>{{ currentVideoTitle }}</h2>
                            <div class="video-player">
                                <video :key="currentVideoUrl" controls preload="metadata" @ended="markVideoCompleted" controlsList="nodownload">
                                    <source :src="currentVideoUrl" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            <div class="video-navigation">
                                <button class="nav-button prev" @click="playPreviousVideo" :disabled="!hasPreviousVideo">
                                    <i class="fas fa-arrow-left"></i> Previous
                                </button>
                                <button class="nav-button next" @click="playNextVideo" :disabled="!hasNextVideo">
                                    Next <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                         <div v-else-if="loadingVideoUrl" class="loading-screen">
                            <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                            <p>Loading video...</p>
                        </div>
                        <div class="no-video-selected" v-else-if="!currentVideoId && videoListForSidebar.length > 0">
                            <div class="empty-state">
                                <i class="fas fa-play-circle"></i>
                                <h2>Select a video to start learning</h2>
                                <p>Choose a video from the course outline to begin your learning journey.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </main>

        <footer class="footer-enhanced" v-if="isEnrolled">
            <div class="footer-content">
                <div class="footer-main">
                    <div class="footer-brand">
                        <img src="https://www.mystudentclub.com/assets/logo.png" alt="My Student Club Logo">
                        <h4>My Student Club</h4>
                        <p>Empowering the next generation of Chartered Accountants with world-class education and resources.</p>
                        <div class="social-links">
                            <a href="#"><i class="fab fa-facebook"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-linkedin"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                            <a href="#"><i class="fab fa-youtube"></i></a>
                        </div>
                    </div>
                    <div class="footer-links">
                        <div class="footer-column">
                            <h5>Learning</h5>
                            <ul>
                                <li><a href="index.html">All Courses</a></li>
                                <li><a href="resources.html">Resources</a></li>
                                <li><a href="#">Certifications</a></li>
                                <li><a href="#">Contact Us</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>© 2025 My Student Club LMS. All rights reserved.</p>
                    <div class="footer-badges">
                        <span class="badge"> Top Rated Platform</span>
                        <span class="badge"> Almost 100% Placement</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script type="module">
        import { createApp } from 'vue';
        
        const supabaseUrl = 'https://izsggdtdiacxdsjjncdq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6c2dnZHRkaWFjeGRzampuY2RxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1OTEzNjUsImV4cCI6MjA1NDE2NzM2NX0.FVKBJG-TmXiiYzBDjGIRBM2zg-DYxzNP--WM6q2UMt0';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        createApp({
            data() {
                return {
                    menuActive: false,
                    sidebarActive: window.innerWidth >= 768,
                    courseSlug: null,
                    user: null,
                    isEnrolled: false,
                    loadingEnrollment: true,
                    loadingInitialVideoList: false,
                    loadingVideoUrl: false,
                    moduleExpanded: true,
                    course: {
                        title: '',
                        description: '',
                        thumbnail: ''
                    },
                    videoListForSidebar: [],
                    totalDiscoveredVideos: 0,
                    currentVideoId: null,
                    currentVideoUrl: '',
                    courses: {
                        'industrial-training-mastery': {
                            title: 'Industrial Training Mastery Program',
                            description: 'Master industrial training requirements for CA candidates with real-world case studies.',
                            thumbnail: 'https://mystudentclub.com/assets/industrial-course-main.png'
                        },
                        'articleship-excellence': {
                            title: 'Articleship Excellence Program',
                            description: 'Enhance your articleship journey with essential skills and best practices.',
                            thumbnail: 'https://mystudentclub.com/assets/articleship-course-main.png'
                        },
                        'ca-fresher-launchpad': {
                            title: 'CA Fresher Launchpad',
                            description: 'Transition from student to professional with this comprehensive guide for new CAs.',
                            thumbnail: 'https://mystudentclub.com/assets/fresher-course-main.png'
                        },
                        'power-bi-data-wizard': {
                            title: 'Power BI Data Wizard Course',
                            description: 'Transform financial data into powerful insights using Power BI.',
                            thumbnail: 'https://mystudentclub.com/assets/powerbi-course-main.png'
                        },
                        'financial-modelling-pro': {
                            title: 'Financial Modeling Pro Certification',
                            description: 'Build sophisticated financial models for business valuation and forecasting.',
                            thumbnail: 'https://mystudentclub.com/assets/financialmastery-course-main.png'
                        }
                    }
                }
            },
            computed: {
                currentVideoTitle() {
                    return this.currentVideoId ? `Video ${this.currentVideoId}` : 'Select a video';
                },
                courseProgress() {
                    if (this.totalDiscoveredVideos === 0) return 0;
                    const completedCount = this.videoListForSidebar.filter(v => v.completed).length;
                    return Math.round((completedCount / this.totalDiscoveredVideos) * 100);
                },
                hasPreviousVideo() {
                    return this.currentVideoId && this.currentVideoId > 1;
                },
                hasNextVideo() {
                    return this.currentVideoId && this.currentVideoId < this.totalDiscoveredVideos;
                }
            },
            methods: {
                async checkAuth() {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session && session.user) {
                        this.user = session.user;
                        await this.checkEnrollment();
                    } else {
                        this.user = null;
                        window.location.href = 'https://www.mystudentclub.com/login';
                    }
                },
                async checkEnrollment() {
                    this.loadingEnrollment = true;
                    try {
                        const { data, error } = await supabase
                            .from('enrollment')
                            .select('id')
                            .eq('user_id', this.user.id)
                            .eq('course_slug', this.courseSlug)
                            .maybeSingle();

                        if (error) throw error;
                        this.isEnrolled = !!data;
                        
                        if (this.isEnrolled) {
                            await this.discoverTotalVideosAndPopulateSidebar();
                        }
                    } catch (error) {
                        console.error('Error checking enrollment:', error);
                        this.isEnrolled = false;
                    } finally {
                        this.loadingEnrollment = false;
                    }
                },
                async discoverTotalVideosAndPopulateSidebar() {
                    this.loadingInitialVideoList = true;
                    this.videoListForSidebar = [];
                    this.totalDiscoveredVideos = 0;
                    let videoNumber = 1;
                    const MAX_VIDEOS_TO_CHECK = 100;

                    try {
                        while (videoNumber <= MAX_VIDEOS_TO_CHECK) {
                            const { data: rpcData, error: rpcError } = await supabase.rpc('get_video_link', {
                                course_name_param: this.courseSlug,
                                video_number_param: videoNumber
                            });

                            if (rpcError || !rpcData) {
                                break; 
                            }
                            
                            this.videoListForSidebar.push({
                                id: videoNumber,
                                title: `Video ${videoNumber}`,
                                completed: false 
                            });
                            this.totalDiscoveredVideos++;
                            videoNumber++;
                        }
                        this.loadVideoProgressState();
                        
                        const lastVideoId = localStorage.getItem(`lastVideoId_${this.courseSlug}`);
                        if (lastVideoId && this.videoListForSidebar.some(v => v.id === parseInt(lastVideoId))) {
                           await this.selectVideo(parseInt(lastVideoId));
                        } else if (this.videoListForSidebar.length > 0) {
                           await this.selectVideo(this.videoListForSidebar[0].id);
                        }

                    } catch (error) {
                        console.error("Error discovering videos:", error);
                    } finally {
                        this.loadingInitialVideoList = false;
                    }
                },
                async selectVideo(videoNumber) {
                    this.currentVideoId = videoNumber;
                    this.loadingVideoUrl = true;
                    this.currentVideoUrl = '';
                    try {
                        const { data: r2Filename, error: rpcError } = await supabase.rpc('get_video_link', {
                            course_name_param: this.courseSlug,
                            video_number_param: videoNumber
                        });

                        if (rpcError || !r2Filename) {
                            throw new Error(rpcError?.message || "Failed to get video link from RPC");
                        }
                        
                        const encodedFilename = encodeURIComponent(r2Filename);
                        this.currentVideoUrl = `https://advertisement.bhansalimanan55.workers.dev/stream/${encodedFilename}?secret=YOUR_SECRET_VALUE`;

                        if (window.innerWidth < 768) {
                            this.sidebarActive = false;
                        }
                        localStorage.setItem(`lastVideoId_${this.courseSlug}`, videoNumber);

                    } catch (error) {
                        console.error(`Error selecting video ${videoNumber}:`, error);
                        alert(`Could not load video ${videoNumber}. Please try again.`);
                        this.currentVideoUrl = '';
                    } finally {
                        this.loadingVideoUrl = false;
                    }
                },
                markVideoCompleted() {
                    const video = this.videoListForSidebar.find(v => v.id === this.currentVideoId);
                    if (video && !video.completed) {
                        video.completed = true;
                        this.saveVideoProgressState();
                    }
                },
                saveVideoProgressState() {
                    const progress = {};
                    this.videoListForSidebar.forEach(v => {
                        progress[v.id] = v.completed;
                    });
                    localStorage.setItem(`courseCompletion_${this.courseSlug}_${this.user.id}`, JSON.stringify(progress));
                },
                loadVideoProgressState() {
                    const savedProgress = localStorage.getItem(`courseCompletion_${this.courseSlug}_${this.user.id}`);
                    if (savedProgress) {
                        const completedStatus = JSON.parse(savedProgress);
                        this.videoListForSidebar.forEach(v => {
                            if (completedStatus[v.id] !== undefined) {
                                v.completed = completedStatus[v.id];
                            }
                        });
                    }
                },
                playPreviousVideo() {
                    if (this.hasPreviousVideo) {
                        this.selectVideo(this.currentVideoId - 1);
                    }
                },
                playNextVideo() {
                    if (this.hasNextVideo) {
                        this.selectVideo(this.currentVideoId + 1);
                    }
                },
                handleProfileClick() {
                    if (!this.user) {
                        window.location.href = 'https://www.mystudentclub.com/login';
                    }
                },
                redirectToEnroll() {
                    window.location.href = 'https://www.mystudentclub.com/login';
                },
                toggleMenu() {
                    this.menuActive = !this.menuActive;
                },
                toggleSidebar() {
                    this.sidebarActive = !this.sidebarActive;
                },
                loadCourseData() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.courseSlug = urlParams.get('course');
                    
                    if (!this.courseSlug || !this.courses[this.courseSlug]) {
                        window.location.href = 'index.html';
                        return;
                    }
                    this.course = { ...this.courses[this.courseSlug] };
                }
            },
            async mounted() {
                this.loadCourseData();
                await this.checkAuth();
                
                supabase.auth.onAuthStateChange(async (_event, session) => {
                    if (session && session.user) {
                        this.user = session.user;
                        if (!this.isEnrolled && this.courseSlug) {
                            await this.checkEnrollment();
                        }
                    } else {
                        this.user = null;
                        window.location.href = 'https://www.mystudentclub.com/login';
                    }
                });
                
                document.addEventListener('click', (event) => {
                    const sidebar = document.querySelector('.course-sidebar');
                    const sidebarToggle = document.querySelector('.sidebar-toggle');
                    
                    if (sidebar && sidebarToggle && 
                        !sidebar.contains(event.target) && 
                        !sidebarToggle.contains(event.target) &&
                        this.sidebarActive && 
                        window.innerWidth < 768) {
                        this.sidebarActive = false;
                    }
                });
                 window.addEventListener('resize', () => {
                    if (window.innerWidth >= 768) {
                        this.sidebarActive = true;
                    } else {
                        this.sidebarActive = false;
                    }
                });
            }
        }).mount('#app');
    </script>
</body>
</html>
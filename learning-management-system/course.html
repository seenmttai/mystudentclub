<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Details | My Student Club LMS</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="course-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="importmap">
    {
        "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
        }
    }
    </script>
</head>
<body>
    <div id="app">
        <header class="glass-header">
            <div class="header-container">
                <div class="logo-container">
                    <img src="https://www.mystudentclub.com/assets/logo.png" alt="My Student Club Logo" class="logo">
                </div>
                <nav>
                    <div class="hamburger-menu" @click="toggleMenu">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                    <ul class="nav-links" :class="{ 'active': menuActive }">
                        <li><a href="index.html" class="nav-item">
                            <i class="fas fa-graduation-cap"></i>
                            <span>Courses</span>
                        </a></li>
                        <li><a href="resources.html" class="nav-item">
                            <i class="fas fa-book-open"></i>
                            <span>Resources</span>
                        </a></li>
                        <li><a href="cv-submission.html" class="nav-item">
                            <i class="fas fa-file-alt"></i>
                            <span>CV Review</span>
                        </a></li>
                        <li class="profile-link">
                            <a href="#" class="nav-item profile-nav" @click="handleProfileClick">
                                <div class="profile-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <span v-if="user">{{ user.email.split('@')[0] }}</span>
                                <span v-else>Login</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>

        <main>
            <div v-if="!isEnrolled" class="enrollment-modal">
                <div class="enrollment-content">
                    <div class="enrollment-icon">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h2>You Are Not Enrolled</h2>
                    <p>You need to be enrolled in this course to access the content.</p>
                    <div class="course-preview">
                        <img :src="course.thumbnail" :alt="course.title">
                        <h3>{{ course.title }}</h3>
                    </div>
                    <button class="enroll-btn" @click="redirectToEnroll">
                        <i class="fas fa-graduation-cap"></i>
                        Enroll Now
                    </button>
                </div>
            </div>

            <div v-else-if="loadingEnrollment" class="loading-screen">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <p>Checking enrollment status...</p>
            </div>

            <template v-else>
                <div class="course-header" :style="{
                    background: `linear-gradient(rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.55)), url('${course.thumbnail}')`,
                    backgroundSize: 'cover',
                    backgroundPosition: 'center'
                }">
                    <div class="course-header-content" style="color: white; text-shadow: 0px 1px 4px rgba(0,0,0,0.7);">
                        <h1 style="font-weight: bold;">{{ course.title }}</h1>
                        <p>{{ course.description }}</p>
                        <div class="course-meta-info">
                            <div class="meta-item" v-if="totalVideos > 0">
                                <i class="fas fa-video"></i>
                                <span>{{ totalVideos }} Sessions</span>
                            </div>
                            <div class="meta-item" v-if="loadingVideos">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Loading content...</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-chart-bar"></i>
                                <span>{{ course.progress }}% Complete</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="course-container">
                    <aside class="course-sidebar" :class="{ 'active': sidebarActive }">
                        <div class="sidebar-header">
                            <h3>Course Content</h3>
                            <button class="sidebar-close" @click="toggleSidebar"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="course-progress-container">
                            <div class="progress-bar" :style="{ width: course.progress + '%' }"></div>
                            <span>{{ course.progress }}% Complete</span>
                        </div>
                        <div class="course-modules">
                            <div v-if="loadingVideos" class="loading-content">
                                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                                <p>Loading course content...</p>
                            </div>
                            <div v-else-if="courseSections.length === 0" class="empty-content">
                                <i class="fas fa-video-slash"></i>
                                <p>No content available for this course yet.</p>
                            </div>
                            <div v-else v-for="(day, dayIndex) in courseSections" :key="day.day_number" class="course-module">
                                <div class="module-header" @click="selectVideo(day.mainVideo.id)" :class="{ 'active': isDaySelected(day), 'completed': isDayCompleted(day) }">
                                    <div class="module-title-container">
                                        <i :class="['fas', isDayCompleted(day) ? 'fa-check-circle' : 'fa-play-circle']"></i>
                                        <h4>{{ day.title }}</h4>
                                    </div>
                                    <div class="module-info" @click.stop="toggleModule(dayIndex)">
                                        <span v-if="day.mainVideo && day.mainVideo.resources.length > 0">{{ day.mainVideo.resources.length }} Resource<span v-if="day.mainVideo.resources.length !== 1">s</span></span>
                                        <i :class="['fas', day.expanded ? 'fa-chevron-up' : 'fa-chevron-down']"></i>
                                    </div>
                                </div>
                                <div class="module-content" :class="{ 'expanded': day.expanded }">
                                    <div v-if="day.mainVideo && day.mainVideo.resources.length > 0" class="sidebar-resource-list">
                                        <div v-for="(resourcesInGroup, groupName) in groupResourcesForSidebar(day.mainVideo.resources)" :key="groupName" class="sidebar-resource-group">
                                            <h5 class="sidebar-resource-group-title" v-if="groupName !== 'General Resources'">{{ groupName }}</h5>
                                            <div v-for="resource in resourcesInGroup" :key="resource.title" class="resource-item-sidebar" @click="handleResourceClick(resource)">
                                                <span class="resource-icon-sidebar"><i :class="getResourceIcon(resource.type)"></i></span>
                                                <span class="resource-title-sidebar">{{ resource.title }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <div class="course-content">
                        <div class="content-header">
                            <button class="sidebar-toggle" @click="toggleSidebar">
                                <i class="fas fa-bars"></i> Course Content
                            </button>
                        </div>
                        
                        <div class="video-container-premium" v-if="currentVideo" @mousemove="showControlsOnMove">
                            <div class="video-player-premium" v-if="videoUrl">
                                <div class="video-player-wrapper" @dblclick="handleDblClick">
                                    <video 
                                        ref="videoPlayer"
                                        :key="videoUrl" 
                                        preload="auto" 
                                        @play="isPlaying = true"
                                        @pause="isPlaying = false"
                                        @ended="markVideoCompleted" 
                                        @timeupdate="handleTimeUpdate"
                                        @loadedmetadata="handleLoadedMetadata"
                                        @waiting="handleWaiting"
                                        @playing="handlePlaying"
                                        @error="handleVideoError"
                                        @click="togglePlay"
                                        :src="videoUrl"
                                        class="custom-video-player"
                                    >
                                        Your browser does not support the video tag.
                                    </video>
                                    <div class="loading-overlay" v-if="isLoading || isBuffering">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                    <div class="seek-indicator" ref="seekIndicator">
                                        <i></i>
                                    </div>
                                </div>
                                <div class="custom-video-controls" :class="{ visible: showControls || !isPlaying }">
                                    <button @click.stop="togglePlay" class="control-btn">
                                        <i :class="['fas', isPlaying ? 'fa-pause' : 'fa-play']"></i>
                                    </button>
                                    <div class="seek-bar-container">
                                        <div class="seek-bar-track">
                                            <div class="seek-bar-fill" :style="{ width: progressPercentage + '%' }"></div>
                                        </div>
                                        <input type="range" class="seek-bar" min="0" :max="duration" :value="currentTime" @mousedown="isDraggingSeekBar = true" @input="handleSeekInput" @change="applySeek" @mouseup="isDraggingSeekBar = false">
                                    </div>
                                    <div class="time-display">{{ formattedCurrentTime }} / {{ formattedDuration }}</div>
                                    <div class="volume-control">
                                        <button @click.stop="toggleMute" class="control-btn">
                                            <i :class="['fas', volumeIcon]"></i>
                                        </button>
                                        <input type="range" class="volume-slider" min="0" max="1" step="0.1" :value="volume" @input="handleVolumeChange">
                                    </div>
                                    <div class="settings-control">
                                        <button @click.stop="showSpeedMenu = !showSpeedMenu" class="control-btn">
                                            <i class="fas fa-cog"></i>
                                        </button>
                                        <div class="speed-menu" v-if="showSpeedMenu">
                                            <div v-for="rate in playbackRates" :key="rate" @click="setPlaybackRate(rate)" :class="{ active: currentPlaybackRate === rate }">
                                                {{ rate }}x
                                            </div>
                                        </div>
                                    </div>
                                    <button @click.stop="toggleFullscreenVideo" class="control-btn">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                             <div class="no-video-selected" v-else>
                                <div class="empty-state">
                                    <i class="fas fa-video-slash"></i>
                                    <h2>No Video Available</h2>
                                    <p>There is no primary video for this session. Please check the resources below.</p>
                                </div>
                            </div>
                            
                            <div class="video-navigation-premium">
                                <button class="nav-button-premium prev" @click="playPreviousVideo" :disabled="!hasPreviousVideo">
                                    <i class="fas fa-arrow-left"></i> 
                                    <span>Previous Day</span>
                                </button>
                                <div class="video-progress-center">
                                    <div class="video-counter">
                                        Day {{ getCurrentDayNumber() }} of {{ courseSections.length }}
                                    </div>
                                </div>
                                <button class="nav-button-premium next" @click="playNextVideo" :disabled="!hasNextVideo">
                                    <span>Next Day</span>
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                             <div class="video-description-premium" v-if="currentVideo && currentVideo.description">
                                <h3>Description</h3>
                                <p v-html="formattedDescription"></p>
                            </div>
                            <div class="video-resources-premium" v-if="currentVideo && Object.keys(groupedResources).length > 0">
                                <h3>Resources</h3>
                                <div v-for="(resourcesInGroup, groupName) in groupedResources" :key="groupName" class="resource-group">
                                    <h4 class="resource-group-title" v-if="groupName !== 'General Resources' || Object.keys(groupedResources).length > 1">{{ groupName }}</h4>
                                    <ul class="resource-list">
                                        <li v-for="resource in resourcesInGroup" :key="resource.title" class="resource-item">
                                            <span class="resource-icon"><i :class="getResourceIcon(resource.type)"></i></span>
                                            <span class="resource-title">{{ resource.title }}</span>
                                            <div class="resource-actions">
                                                <button @click="handleResourceClick(resource)" class="resource-btn resource-btn-view">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                                <button v-if="resource.download_storage_path && resource.download_storage_path !== 'None'" @click.stop="downloadResource(resource)" class="resource-btn resource-btn-download">
                                                    <i class="fas fa-download"></i> Download
                                                </button>
                                                <span v-else class="resource-btn resource-btn-download disabled">
                                                    <i class="fas fa-download"></i> Download
                                                </span>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="no-video-selected" v-else>
                            <div class="empty-state">
                                <i class="fas fa-play-circle"></i>
                                <h2>Select a Day to start learning</h2>
                                <p>Choose a Day from the course outline to begin your learning journey.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </main>

        <div id="resource-viewer-modal" :class="{ 'visible': isViewerVisible }">
            <div class="resource-viewer-content" ref="viewerContent">
                <div class="resource-viewer-header">
                    <h2 class="resource-viewer-title">{{ currentResource ? currentResource.title : 'Resource Preview' }}</h2>
                    <div>
                        <button class="resource-viewer-fullscreen-button" @click="toggleFullscreen">
                            <i :class="['fas', isFullscreen ? 'fa-compress' : 'fa-expand']"></i>
                        </button>
                        <button class="resource-viewer-close-button" @click="closeResourceViewer">Ã—</button>
                    </div>
                </div>
                <div class="viewer-main-content">
                    <div v-if="viewerLoading" class="loading-screen">
                        <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                        <p>Loading Document...</p>
                    </div>
                    <div v-if="previewType === 'pdf'" class="pdf-canvas-container">
                        <canvas id="pdf-canvas"></canvas>
                    </div>
                    <div v-if="previewType === 'csv'" class="csv-preview-container">
                        <table class="csv-preview-table">
                            <thead v-if="csvData && csvData.header.length > 0">
                                <tr>
                                    <th v-for="(col, index) in csvData.header" :key="index">{{ col }}</th>
                                </tr>
                            </thead>
                            <tbody v-if="csvData && csvData.rows.length > 0">
                                <tr v-for="(row, rowIndex) in csvData.rows" :key="rowIndex">
                                    <td v-for="(cell, cellIndex) in row" :key="cellIndex" :title="cell">{{ cell }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="resource-viewer-controls">
                    <button v-if="previewType === 'pdf'" id="pdf-prev-page" class="viewer-nav-button" @click="goToPrevPage" :disabled="pdfCurrentPage <= 1">Previous</button>
                    <span v-if="previewType === 'pdf'" id="pdf-page-info">Page {{ pdfCurrentPage }} of {{ pdfTotalPages }}</span>
                    <button @click="downloadResource(currentResource)" class="viewer-nav-button viewer-download-btn" :disabled="!currentResource || !currentResource.download_storage_path || currentResource.download_storage_path === 'None'">Download</button>
                    <button v-if="previewType === 'pdf'" id="pdf-next-page" class="viewer-nav-button" @click="goToNextPage" :disabled="pdfCurrentPage >= pdfTotalPages">Next</button>
                </div>
            </div>
        </div>

        <footer class="footer-enhanced" v-if="isEnrolled">
            <div class="footer-content">
                <div class="footer-main">
                    <div class="footer-brand">
                        <img src="https://www.mystudentclub.com/assets/logo.png" alt="My Student Club Logo">
                        <h4>My Student Club</h4>
                        <p>Empowering the next generation of Chartered Accountants with world-class education and resources.</p>
                        <div class="social-links">
                            <a href="#"><i class="fab fa-facebook"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-linkedin"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                            <a href="#"><i class="fab fa-youtube"></i></a>
                        </div>
                    </div>
                    <div class="footer-links">
                        <div class="footer-column">
                            <h5>Learning</h5>
                            <ul>
                                <li><a href="index.html">All Courses</a></li>
                                <li><a href="resources.html">Resources</a></li>
                                <li><a href="#">Certifications</a></li>
                                <li><a href="#">Contact Us</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p> 2025 My Student Club LMS. All rights reserved.</p>
                    <div class="footer-badges">
                        <span class="badge"> Top Rated Platform</span>
                        <span class="badge"> Almost 100% Placement</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script type="module">
        import { createApp } from 'vue';
        
        const supabaseUrl = 'https://izsggdtdiacxdsjjncdq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6c2dnZHRkaWFjeGRzampuY2RxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1OTEzNjUsImV4cCI6MjA1NDE2NzM2NX0.FVKBJG-TmXiiYzBDjGIRBM2zg-DYxzNP--WM6q2UMt0';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js`;
        
        createApp({
            data() {
                return {
                    menuActive: false,
                    sidebarActive: false,
                    courseSlug: null,
                    user: null,
                    isEnrolled: false,
                    loadingEnrollment: true,
                    loadingVideos: false,
                    totalVideos: 0,
                    course: {
                        title: '',
                        description: '',
                        thumbnail: '',
                        progress: 0
                    },
                    courseSections: [],
                    currentVideoId: null,
                    courses: {
                        'industrial-training-mastery': {
                            title: 'Industrial Training Mastery Program',
                            description: 'Master industrial training requirements for CA candidates with real-world case studies.',
                            thumbnail: 'https://mystudentclub.com/assets/it-guarantee-thumbnail.svg'
                        }
                    },
                    isViewerVisible: false,
                    viewerLoading: false,
                    pdfCurrentPage: 1,
                    pdfTotalPages: 1,
                    currentResource: null,
                    previewType: null,
                    csvData: null,
                    isFullscreen: false,
                    isPlaying: false,
                    currentTime: 0,
                    duration: 0,
                    volume: 1,
                    isMuted: false,
                    showControls: false,
                    controlsTimeout: null,
                    seekIndicatorTimeout: null,
                    isLoading: false,
                    isBuffering: false,
                    isDraggingSeekBar: false,
                    playbackRates: [0.5, 0.75, 1, 1.25, 1.5, 2],
                    currentPlaybackRate: 1,
                    showSpeedMenu: false,
                    retryCount: 0,
                    maxRetries: 5
                }
            },
            computed: {
                currentVideo() {
                    if (!this.currentVideoId) return null;
                    for (const section of this.courseSections) {
                        const video = section.videos.find(v => v.id === this.currentVideoId);
                        if (video) return video;
                    }
                    return null;
                },
                videoUrl() {
                    if (!this.currentVideo || !this.isEnrolled || !this.currentVideo.fileName) return '';
                    return `https://advertisement.bhansalimanan55.workers.dev/stream/${encodeURIComponent(this.currentVideo.fileName)}`;
                },
                hasPreviousVideo() {
                    return this.getAdjacentVideo('previous') !== null;
                },
                hasNextVideo() {
                    return this.getAdjacentVideo('next') !== null;
                },
                formattedDescription() {
                    if (this.currentVideo && this.currentVideo.description) {
                        return this.currentVideo.description.replace(/\n/g, '<br>');
                    }
                    return '';
                },
                groupedResources() {
                    if (!this.currentVideo || !this.currentVideo.resources || this.currentVideo.resources.length === 0) return {};
                    const groups = {};
                    this.currentVideo.resources.forEach(res => {
                        const groupKey = res.group || 'General Resources';
                        if (!groups[groupKey]) {
                            groups[groupKey] = [];
                        }
                        groups[groupKey].push(res);
                    });
                    return groups;
                },
                formattedCurrentTime() {
                    if (isNaN(this.currentTime)) return '0:00';
                    const hours = Math.floor(this.currentTime / 3600);
                    const minutes = Math.floor((this.currentTime % 3600) / 60).toString().padStart(2, '0');
                    const seconds = Math.floor(this.currentTime % 60).toString().padStart(2, '0');
                    if (hours > 0) {
                        return `${hours}:${minutes}:${seconds}`;
                    }
                    return `${minutes}:${seconds}`;
                },
                formattedDuration() {
                    if (isNaN(this.duration) || this.duration === 0) return '0:00';
                    const hours = Math.floor(this.duration / 3600);
                    const minutes = Math.floor((this.duration % 3600) / 60).toString().padStart(2, '0');
                    const seconds = Math.floor(this.duration % 60).toString().padStart(2, '0');
                    if (hours > 0) {
                        return `${hours}:${minutes}:${seconds}`;
                    }
                    return `${minutes}:${seconds}`;
                },
                volumeIcon() {
                    if (this.isMuted || this.volume === 0) return 'fa-volume-mute';
                    if (this.volume < 0.5) return 'fa-volume-down';
                    return 'fa-volume-up';
                },
                progressPercentage() {
                    if (this.duration === 0) return 0;
                    return (this.currentTime / this.duration) * 100;
                }
            },
            methods: {
                async checkAuth() {
                    const { data: { session }, error } = await supabase.auth.getSession();
                    if (session && session.user) {
                        this.user = session.user;
                        await this.checkEnrollment();
                    } else {
                        this.user = null;
                        window.location.href = 'https://www.mystudentclub.com/login';
                    }
                },
                async checkEnrollment() {
                    try {
                        this.isEnrolled = true;
                        this.loadingEnrollment = false;
                        if (this.isEnrolled) {
                            await this.loadCourseVideos();
                        }
                    } catch (error) {
                        this.isEnrolled = false;
                        this.loadingEnrollment = false;
                    }
                },
                async loadCourseVideos() {
                    this.loadingVideos = true;
                    try {
                        const { data: videoMetadata, error: metadataError } = await supabase
                            .from('videos')
                            .select('video_number, title, description, day_number, resources')
                            .eq('course', this.courseSlug)
                            .order('day_number', { ascending: true })
                            .order('video_number', { ascending: true });

                        if (metadataError) throw metadataError;

                        const videosByDay = {};
                        if (videoMetadata && videoMetadata.length > 0) {
                             for (const meta of videoMetadata) {
                                try {
                                    const { data: rpcData, error: rpcError } = await supabase.rpc('get_video_link', {
                                        course_name_param: this.courseSlug,
                                        video_number_param: meta.video_number
                                    });
                                    
                                    const day = meta.day_number || 1;
                                    if (!videosByDay[day]) {
                                        videosByDay[day] = [];
                                    }
                                    videosByDay[day].push({
                                        id: meta.video_number,
                                        fileName: rpcData || null,
                                        title: meta.title || `Content for Day ${day}`,
                                        description: meta.description || '',
                                        resources: meta.resources || [],
                                        completed: false
                                    });
                                } catch (err) {
                                }
                            }
                        }
                        
                        this.courseSections = Object.keys(videosByDay).map(dayNum => {
                            const dayVideos = videosByDay[dayNum];
                            const mainVideo = dayVideos[0] || {};
                            return {
                                day_number: parseInt(dayNum),
                                title: mainVideo.title || `Day ${dayNum}`,
                                expanded: parseInt(dayNum) === 1,
                                videos: dayVideos,
                                mainVideo: mainVideo
                            };
                        }).sort((a, b) => a.day_number - b.day_number);
                        
                        this.totalVideos = videoMetadata ? videoMetadata.length : 0;
                        this.loadVideoProgress();
                    } catch (error) {
                    } finally {
                        this.loadingVideos = false;
                    }
                },
                getResourceIcon(type) {
                    const iconMap = {
                        pdf: 'fas fa-file-pdf',
                        image: 'fas fa-file-image',
                        doc: 'fas fa-file-word',
                        docx: 'fas fa-file-word',
                        txt: 'fas fa-file-alt',
                        external_link: 'fas fa-external-link-alt',
                        video: 'fas fa-file-video',
                        archive: 'fas fa-file-archive',
                        spreadsheet: 'fas fa-file-excel',
                        xlsx: 'fas fa-file-excel',
                        csv: 'fas fa-file-csv'
                    };
                    return iconMap[type.toLowerCase()] || 'fas fa-file';
                },
                groupResourcesForSidebar(resources) {
                    if (!resources || resources.length === 0) return {};
                    const groups = {};
                    resources.forEach(res => {
                        const groupKey = res.group || 'General Resources';
                        if (!groups[groupKey]) {
                            groups[groupKey] = [];
                        }
                        groups[groupKey].push(res);
                    });
                    return groups;
                },
                handleProfileClick() {
                    if (!this.user) {
                        window.location.href = 'https://www.mystudentclub.com/login';
                    }
                },
                redirectToEnroll() {
                    window.location.href = 'https://www.mystudentclub.com/login';
                },
                toggleMenu() {
                    this.menuActive = !this.menuActive;
                },
                toggleSidebar() {
                    this.sidebarActive = !this.sidebarActive;
                },
                toggleModule(dayIndex) {
                    this.courseSections[dayIndex].expanded = !this.courseSections[dayIndex].expanded;
                },
                selectVideo(videoId) {
                    this.retryCount = 0;
                    this.isLoading = true;
                    this.currentVideoId = videoId;
                    if (window.innerWidth < 768) {
                        this.sidebarActive = false;
                    }
                    localStorage.setItem(`lastVideoId_${this.courseSlug}`, videoId);
                },
                getAdjacentVideo(direction) {
                    if (!this.currentVideoId) return null;
                    const allVideos = this.courseSections.map(section => section.videos[0]).filter(Boolean);
                    const currentIndex = allVideos.findIndex(video => video.id === this.currentVideoId);
                    if (currentIndex === -1) return null;
                    if (direction === 'previous' && currentIndex > 0) {
                        return allVideos[currentIndex - 1];
                    } else if (direction === 'next' && currentIndex < allVideos.length - 1) {
                        return allVideos[currentIndex + 1];
                    }
                    return null;
                },
                playPreviousVideo() {
                    const prevVideo = this.getAdjacentVideo('previous');
                    if (prevVideo) {
                        this.selectVideo(prevVideo.id);
                    }
                },
                playNextVideo() {
                    const nextVideo = this.getAdjacentVideo('next');
                    if (nextVideo) {
                        this.selectVideo(nextVideo.id);
                    }
                },
                markVideoCompleted() {
                    if (!this.currentVideoId) return;
                    const videoToMark = this.findVideoById(this.currentVideoId);
                    if (videoToMark && !videoToMark.completed) {
                        videoToMark.completed = true;
                        this.saveVideoProgress();
                        this.updateCourseProgress();
                        this.updateLearningStreak();
                    }
                },
                findVideoById(videoId) {
                    for (const section of this.courseSections) {
                        const foundVideo = section.videos.find(v => v.id === videoId);
                        if (foundVideo) return foundVideo;
                    }
                    return null;
                },
                saveVideoProgress() {
                    const completedVideos = {};
                    this.courseSections.forEach(section => {
                        section.videos.forEach(video => {
                            completedVideos[video.id] = video.completed;
                        });
                    });
                    localStorage.setItem(`courseVideos_${this.courseSlug}`, JSON.stringify(completedVideos));
                },
                loadVideoProgress() {
                    const savedVideos = localStorage.getItem(`courseVideos_${this.courseSlug}`);
                    if (savedVideos) {
                        const completedVideos = JSON.parse(savedVideos);
                        this.courseSections.forEach(section => {
                            section.videos.forEach(video => {
                                if (completedVideos[video.id] !== undefined) {
                                     video.completed = completedVideos[video.id];
                                }
                            });
                        });
                    }
                    this.updateCourseProgress(); 
                    const lastVideoId = localStorage.getItem(`lastVideoId_${this.courseSlug}`);
                    if (lastVideoId && this.findVideoById(parseInt(lastVideoId))) {
                        this.currentVideoId = parseInt(lastVideoId);
                    } else if (this.courseSections.length > 0 && this.courseSections[0].videos.length > 0) {
                        this.currentVideoId = this.courseSections[0].videos[0].id;
                    }
                },
                updateCourseProgress() {
                    let totalCount = 0;
                    let completedCount = 0;
                    this.courseSections.forEach(section => {
                        section.videos.forEach(video => {
                            totalCount++;
                            if (video.completed) completedCount++;
                        });
                    });
                    this.course.progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                },
                updateLearningStreak() {
                    const today = new Date().toDateString();
                    const lastActivity = localStorage.getItem('lastLearningActivity');
                    if (lastActivity !== today) {
                        localStorage.setItem('lastLearningActivity', today);
                        const currentStreak = parseInt(localStorage.getItem('learningStreak') || '0');
                        localStorage.setItem('learningStreak', (currentStreak + 1).toString());
                    }
                },
                loadCourseData() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.courseSlug = urlParams.get('course');
                    if (!this.courseSlug || !this.courses[this.courseSlug]) {
                        window.location.href = 'index.html';
                        return;
                    }
                    this.course = { ...this.courses[this.courseSlug], progress: 0 };
                },
                getCurrentDayNumber() {
                    if (!this.currentVideoId) return 0;
                    const section = this.courseSections.find(s => s.videos.some(v => v.id === this.currentVideoId));
                    return section ? section.day_number : 0;
                },
                getTotalVideos() {
                    return this.courseSections.length;
                },
                isDaySelected(day) {
                    return day.videos.some(v => v.id === this.currentVideoId);
                },
                isDayCompleted(day) {
                    return day.videos.every(v => v.completed);
                },
                async handleResourceClick(resource) {
                    if (resource.type === 'external_link' && resource.url) {
                        window.open(resource.url, '_blank');
                        return;
                    }

                    if (resource.view_storage_path && resource.view_storage_path !== 'None') {
                        const path = resource.view_storage_path.toLowerCase();
                        if (path.endsWith('.csv')) {
                            await this.openResourceViewer(resource, 'csv');
                        } else {
                            await this.openResourceViewer(resource, 'pdf');
                        }
                        return;
                    }
                    
                    this.downloadResource(resource);
                },
                async downloadResource(resource) {
                    if (!resource || !resource.download_storage_path || resource.download_storage_path === 'None') {
                        alert('No downloadable file available for this resource.');
                        return;
                    }

                    try {
                        const { data, error } = await supabase.storage
                            .from('industrial-training-mastery-resources')
                            .createSignedUrl(resource.download_storage_path, 300);

                        if (error) throw error;
                        
                        const response = await fetch(data.signedUrl);
                        if (!response.ok) throw new Error('Network response was not ok.');
                        const blob = await response.blob();
                        
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = resource.download_storage_path.split('/').pop() || 'download';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    } catch (err) {
                        alert('Could not download the file. Please try again.');
                    }
                },
                async openResourceViewer(resource, type) {
                    this.pdfDoc = null;
                    this.csvData = null;
                    this.pdfCurrentPage = 1;
                    this.pdfTotalPages = 1;
                    const canvas = document.getElementById('pdf-canvas');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }

                    this.viewerLoading = true;
                    this.isViewerVisible = true;
                    this.currentResource = resource;
                    this.previewType = type;

                    try {
                        const { data, error } = await supabase.storage
                            .from('industrial-training-mastery-resources')
                            .createSignedUrl(resource.view_storage_path, 300);

                        if (error) throw error;
                        
                        const workerUrl = 'https://pdf-proxy-viewer.bhansalimanan55.workers.dev/';
                        const proxiedUrl = `${workerUrl}?url=${encodeURIComponent(data.signedUrl)}`;

                        const response = await fetch(proxiedUrl);
                        if (!response.ok) throw new Error(`Failed to fetch from proxy: ${response.status}`);

                        if (type === 'pdf') {
                            const pdfData = await response.arrayBuffer();
                            this.pdfDoc = await pdfjsLib.getDocument(pdfData).promise;
                            this.pdfTotalPages = this.pdfDoc.numPages;
                            await this.renderPdfPage(1);
                        } else if (type === 'csv') {
                            const csvText = await response.text();
                            const lines = csvText.split('\n').filter(line => line.trim() !== '');
                            const header = lines.length > 0 ? lines[0].split(',').map(h => h.trim()) : [];
                            const rows = lines.length > 1 ? lines.slice(1).map(line => line.split(',').map(cell => cell.trim())) : [];
                            this.csvData = { header, rows };
                        }
                    } catch (err) {
                        console.error("Resource viewer error:", err);
                        alert("Could not load the resource for viewing.");
                        this.closeResourceViewer();
                    } finally {
                        this.viewerLoading = false;
                    }
                },
                async renderPdfPage(num) {
                    if (!this.pdfDoc) return;
                    this.pdfCurrentPage = num;
                    const page = await this.pdfDoc.getPage(num);
                    const canvas = document.getElementById('pdf-canvas');
                    const ctx = canvas.getContext('2d');
                    const viewport = page.getViewport({ scale: 1.5 });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    const renderContext = { canvasContext: ctx, viewport: viewport };
                    await page.render(renderContext).promise;
                    this.drawWatermark(canvas, ctx);
                },
                drawWatermark(canvas, ctx) {
                    const watermarkText = this.user ? this.user.email : 'MyStudentClub';
                    ctx.font = '20px Arial';
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    const x_step = 250;
                    const y_step = 150;
                    
                    ctx.save();
                    for (let y = y_step / 2; y < canvas.height; y += y_step) {
                        for (let x = x_step / 2; x < canvas.width; x += x_step) {
                            ctx.save();
                            ctx.translate(x, y);
                            ctx.rotate(-Math.PI / 4);
                            ctx.fillText(watermarkText, 0, 0);
                            ctx.restore();
                        }
                    }
                    ctx.restore();
                },
                closeResourceViewer() {
                    if (this.isFullscreen) {
                        this.toggleFullscreen();
                    }
                    this.isViewerVisible = false;
                    this.pdfDoc = null;
                    this.currentResource = null;
                    this.previewType = null;
                    this.csvData = null;
                },
                goToPrevPage() {
                    if (this.pdfCurrentPage > 1) {
                        this.renderPdfPage(this.pdfCurrentPage - 1);
                    }
                },
                goToNextPage() {
                    if (this.pdfCurrentPage < this.pdfTotalPages) {
                        this.renderPdfPage(this.pdfCurrentPage + 1);
                    }
                },
                toggleFullscreen() {
                    const elem = this.$refs.viewerContent;
                    if (!document.fullscreenElement) {
                        elem.requestFullscreen().catch(err => {
                            alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                        });
                    } else {
                        document.exitFullscreen();
                    }
                },
                togglePlay() {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        video.paused ? video.play() : video.pause();
                    }
                },
                handleTimeUpdate() {
                    const video = this.$refs.videoPlayer;
                    if (video && !this.isDraggingSeekBar) {
                        this.currentTime = video.currentTime;
                    }
                },
                handleLoadedMetadata() {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        this.duration = video.duration;
                        this.isLoading = false;
                        this.isBuffering = false;
                        this.retryCount = 0;
                    }
                },
                handleWaiting() {
                    this.isBuffering = true;
                },
                handlePlaying() {
                    this.isBuffering = false;
                },
                handleVideoError() {
                    this.isLoading = false;
                    this.isBuffering = false;
                    this.attemptReload();
                },
                attemptReload() {
                    if (this.retryCount < this.maxRetries) {
                        this.retryCount++;
                        const delay = Math.pow(2, this.retryCount) * 1000;
                        setTimeout(() => {
                            const video = this.$refs.videoPlayer;
                            if (video) {
                                this.isLoading = true;
                                const currentTime = video.currentTime;
                                video.load();
                                video.play().then(() => {
                                    video.currentTime = currentTime;
                                }).catch(() => {});
                            }
                        }, delay);
                    } else {
                        alert("Failed to load the video after multiple attempts. Please check your connection or try again later.");
                    }
                },
                handleSeekInput(event) {
                    this.isDraggingSeekBar = true;
                    this.currentTime = parseFloat(event.target.value);
                },
                applySeek(event) {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        const seekTime = parseFloat(event.target.value);
                        video.currentTime = seekTime;
                    }
                    this.isDraggingSeekBar = false;
                },
                toggleMute() {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        video.muted = !video.muted;
                        this.isMuted = video.muted;
                    }
                },
                handleVolumeChange(event) {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        const newVolume = event.target.value;
                        video.volume = newVolume;
                        this.volume = newVolume;
                        if (newVolume > 0) {
                            video.muted = false;
                            this.isMuted = false;
                        }
                    }
                },
                toggleFullscreenVideo() {
                    const playerContainer = this.$refs.videoPlayer.parentElement.parentElement;
                    if (!document.fullscreenElement) {
                        playerContainer.requestFullscreen().catch(err => {
                            alert(`Error enabling full-screen mode: ${err.message}`);
                        });
                    } else {
                        document.exitFullscreen();
                    }
                },
                handleDblClick(event) {
                    const video = this.$refs.videoPlayer;
                    if (!video) return;
                    const rect = video.getBoundingClientRect();
                    const clickX = event.clientX - rect.left;
                    if (clickX < rect.width * 0.4) {
                        video.currentTime = Math.max(0, video.currentTime - 10);
                        this.showSeekIndicator('backward');
                    } else if (clickX > rect.width * 0.6) {
                        video.currentTime = Math.min(video.duration, video.currentTime + 10);
                        this.showSeekIndicator('forward');
                    }
                },
                handleKeydown(event) {
                    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    const video = this.$refs.videoPlayer;
                    if (!video) return;
                    switch (event.key) {
                        case 'ArrowLeft':
                            event.preventDefault();
                            video.currentTime = Math.max(0, video.currentTime - 10);
                            this.showSeekIndicator('backward');
                            break;
                        case 'ArrowRight':
                            event.preventDefault();
                            video.currentTime = Math.min(video.duration, video.currentTime + 10);
                            this.showSeekIndicator('forward');
                            break;
                        case ' ':
                            event.preventDefault();
                            this.togglePlay();
                            break;
                    }
                },
                showSeekIndicator(direction) {
                    const indicator = this.$refs.seekIndicator;
                    const icon = indicator.querySelector('i');
                    if (!indicator || !icon) return;
                    icon.className = `fas fa-fast-${direction}`;
                    indicator.classList.add('show', direction);
                    if (this.seekIndicatorTimeout) {
                        clearTimeout(this.seekIndicatorTimeout);
                    }
                    this.seekIndicatorTimeout = setTimeout(() => {
                        indicator.classList.remove('show', 'forward', 'backward');
                    }, 500);
                },
                showControlsOnMove() {
                    this.showControls = true;
                    if (this.controlsTimeout) {
                        clearTimeout(this.controlsTimeout);
                    }
                    if (this.isPlaying) {
                        this.controlsTimeout = setTimeout(() => {
                            this.showControls = false;
                        }, 3000);
                    }
                },
                setPlaybackRate(rate) {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        video.playbackRate = rate;
                        this.currentPlaybackRate = rate;
                        this.showSpeedMenu = false;
                    }
                }
            },
            async mounted() {
                this.pdfDoc = null; 
                this.loadCourseData();
                await this.checkAuth();
                supabase.auth.onAuthStateChange(async (_event, session) => {
                    if (session && session.user) {
                        this.user = session.user;
                        if (!this.isEnrolled) {
                            await this.checkEnrollment();
                        }
                    } else {
                        this.user = null;
                        window.location.href = 'https://www.mystudentclub.com/login';
                    }
                });
                document.addEventListener('fullscreenchange', () => {
                    this.isFullscreen = !!document.fullscreenElement;
                });
                document.addEventListener('keydown', this.handleKeydown);
            },
            beforeUnmount() {
                document.removeEventListener('keydown', this.handleKeydown);
            }
        }).mount('#app');
    </script>
</body>
</html>
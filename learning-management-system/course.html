<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Details | My Student Club LMS</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="course-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .logo-enhanced {
            width: 140px;
            height: auto;
            object-fit: contain;
            transition: transform 0.2s;
        }

        .logo-enhanced:hover {
            transform: scale(1.05);
        }

        .profile-dropdown-container {
            position: relative;
            cursor: pointer;
        }

        .profile-dropdown-menu {
            position: absolute;
            top: 110%;
            right: 0;
            background: white;
            border: 1px solid var(--border-color, #e2e8f0);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 220px;
            display: none;
            flex-direction: column;
            z-index: 10000;
            overflow: hidden;
            animation: fadeIn 0.2s ease-out;
        }

        .profile-dropdown-container:hover .profile-dropdown-menu {
            display: flex;
        }

        .profile-header {
            padding: 1rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .profile-name {
            font-weight: 700;
            color: #1e293b;
            display: block;
        }

        .profile-email {
            font-size: 0.8rem;
            color: #64748b;
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            color: #475569;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: #f1f5f9;
            color: #2563eb;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .course-tabs {
            display: flex;
            gap: 1rem;
            padding: 0 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 1rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .tab-content {
            padding: 1.5rem;
            background: white;
            min-height: 200px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .discussion-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .comment-input-area {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .comment-input {
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
        }

        .post-btn {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            height: fit-content;
        }

        .post-btn:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }

        .comment-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .comment-item {
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .comment-author {
            font-weight: 700;
            color: #1e293b;
        }

        .comment-date {
            color: #64748b;
        }

        .report-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 600px;
        }

        .report-textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .report-submit-btn {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            align-self: flex-start;
        }
    </style>
</head>

<body>
    <div id="app">
        <header class="glass-header">
            <div class="header-container">
                <div class="logo-container">
                    <a href="index.html">
                        <img src="https://www.mystudentclub.com/assets/logo.png" alt="My Student Club Logo"
                            class="logo-enhanced">
                    </a>
                </div>
                <nav>
                    <div class="hamburger-menu" id="hamburger-menu">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                    <ul class="nav-links" id="nav-links">
                        <li><a href="index.html" class="nav-item"><i class="fas fa-graduation-cap"></i><span>My
                                    Courses</span></a></li>
                        <li><a href="lms-resources.html" class="nav-item"><i
                                    class="fas fa-book-open"></i><span>Resources</span></a></li>
                        <li><a href="https://mystudentclub.com/cv-reviewer/" class="nav-item"><i
                                    class="fas fa-file-alt"></i><span>CV Review</span></a></li>
                        <li class="profile-link profile-dropdown-container">
                            <a href="#" class="nav-item profile-nav">
                                <div class="profile-avatar"><i class="fas fa-user"></i></div>
                                <span id="user-display-name">Login</span>
                            </a>
                            <div class="profile-dropdown-menu" id="profile-dropdown">
                                <div class="profile-header">
                                    <span class="profile-name" id="profile-dropdown-name"></span>
                                    <span class="profile-email" id="profile-dropdown-email"></span>
                                </div>
                                <a href="https://mystudentclub.com/profile" class="dropdown-item"><i
                                        class="fas fa-user-circle"></i> My Profile</a>
                                <button class="dropdown-item" id="logout-button"><i class="fas fa-sign-out-alt"></i>
                                    Logout</button>
                            </div>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>

        <main>
            <div id="enrollment-modal" class="enrollment-modal" style="display: none;">
                <div class="enrollment-content">
                    <div class="enrollment-icon"><i class="fas fa-lock"></i></div>
                    <h2>You Are Not Enrolled</h2>
                    <p>You need to be enrolled in this course to access the content.</p>
                    <div class="course-preview">
                        <img id="enroll-course-thumbnail" src="" alt="">
                        <h3 id="enroll-course-title"></h3>
                    </div>
                    <button class="enroll-btn" id="enroll-redirect-btn"><i class="fas fa-graduation-cap"></i> Enroll
                        Now</button>
                </div>
            </div>

            <div id="loading-enrollment-screen" class="loading-screen">
                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                <p>Checking enrollment status...</p>
            </div>

            <div id="course-page-content" style="display: none;">
                <div class="course-header" id="course-header-banner">
                    <div class="course-header-content" style="color: white; text-shadow: 0px 1px 4px rgba(0,0,0,0.7);">
                        <h1 style="font-weight: bold;" id="course-title"></h1>
                        <p id="course-description"></p>
                        <div class="course-meta-info">
                            <div class="meta-item" id="total-videos-meta" style="display: none;">
                                <i class="fas fa-video"></i>
                                <span id="total-videos-count"></span>
                            </div>
                            <div class="meta-item" id="loading-videos-meta">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Loading content...</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-chart-bar"></i>
                                <span id="course-progress-meta">0% Complete</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="course-container">
                    <aside class="course-sidebar" id="course-sidebar">
                        <div class="sidebar-header">
                            <h3>Course Content</h3>
                            <button class="sidebar-close" id="sidebar-close-btn"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="course-progress-container">
                            <div class="progress-bar" id="sidebar-progress-bar" style="width: 0%;"></div>
                            <span id="sidebar-progress-text">0% Complete</span>
                        </div>
                        <div class="course-modules" id="course-modules-container">
                            <div id="loading-videos-sidebar" class="loading-content">
                                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                                <p>Loading course content...</p>
                            </div>
                        </div>
                    </aside>

                    <div class="course-content">
                        <div class="content-header">
                            <button class="sidebar-toggle" id="sidebar-toggle-btn"><i class="fas fa-bars"></i> Course
                                Content</button>
                        </div>

                        <div id="video-section-container" class="video-container-premium" style="display: none;">
                            <div id="video-player-container" class="video-player-premium">
                                <div class="video-player-wrapper">
                                    <video id="video-player" preload="auto" class="custom-video-player">Your browser
                                        does not support the video tag.</video>
                                    <div class="loading-overlay" id="video-loading-overlay"><i
                                            class="fas fa-spinner fa-spin"></i></div>
                                    <div class="seek-indicator" id="seek-indicator"><i></i></div>
                                </div>
                                <div class="custom-video-controls" id="video-controls">
                                    <button id="play-pause-btn" class="control-btn"><i class="fas fa-play"></i></button>
                                    <div class="seek-bar-container">
                                        <div class="seek-bar-track">
                                            <div id="seek-bar-fill" class="seek-bar-fill"></div>
                                        </div>
                                        <input type="range" id="seek-bar" class="seek-bar" min="0" value="0">
                                    </div>
                                    <div id="time-display" class="time-display">00:00 / 00:00</div>
                                    <div class="volume-control">
                                        <button id="mute-btn" class="control-btn"><i id="volume-icon"
                                                class="fas fa-volume-up"></i></button>
                                        <input type="range" id="volume-slider" class="volume-slider" min="0" max="1"
                                            step="0.1" value="1">
                                    </div>
                                    <div class="settings-control">
                                        <button id="settings-btn" class="control-btn"><i
                                                class="fas fa-cog"></i></button>
                                        <div class="speed-menu" id="speed-menu" style="display: none;"></div>
                                    </div>
                                    <button id="fullscreen-btn" class="control-btn"><i
                                            class="fas fa-expand"></i></button>
                                </div>
                            </div>
                            <div class="no-video-selected" id="no-video-message-player" style="display: none;">
                                <div class="empty-state">
                                    <i class="fas fa-book-open"></i>
                                    <h2>No Video Available</h2>
                                    <p>There is no video for this session. Please check the description and resources
                                        below.</p>
                                </div>
                            </div>

                            <div class="video-navigation-premium">
                                <button class="nav-button-premium prev" id="prev-video-btn"><i
                                        class="fas fa-arrow-left"></i> <span>Previous Day</span></button>
                                <div class="video-progress-center">
                                    <div class="video-counter" id="video-counter"></div>
                                </div>
                                <button class="nav-button-premium next" id="next-video-btn"><span>Next Day</span> <i
                                        class="fas fa-arrow-right"></i></button>
                            </div>

                            <div class="course-tabs" id="course-tabs-container"></div>

                            <div id="tab-content-overview" class="tab-content"></div>
                            <div id="tab-content-resources" class="tab-content"></div>
                            <div id="tab-content-discussion" class="tab-content">
                                <div class="discussion-container">
                                    <div class="comment-input-area">
                                        <textarea id="new-comment-input" class="comment-input"
                                            placeholder="Ask a question or share your thoughts about this lecture..."></textarea>
                                        <button class="post-btn" id="post-comment-btn">Post</button>
                                    </div>
                                    <div id="comments-loader" class="loading-spinner" style="display: none;"><i
                                            class="fas fa-spinner fa-spin"></i></div>
                                    <div id="comment-list-container" class="comment-list"></div>
                                </div>
                            </div>
                            <div id="tab-content-report" class="tab-content">
                                <div class="report-form">
                                    <h3>Report a Problem</h3>
                                    <p>Encountered an issue with this video or content? Let us know.</p>
                                    <textarea id="report-description-input" class="report-textarea"
                                        placeholder="Describe the issue you are facing..."></textarea>
                                    <button class="report-submit-btn" id="submit-report-btn">Submit Report</button>
                                </div>
                            </div>

                        </div>

                        <div class="no-video-selected" id="no-video-selected-placeholder">
                            <div class="empty-state">
                                <i class="fas fa-play-circle"></i>
                                <h2>Select a Day to start learning</h2>
                                <p>Choose a Day from the course outline to begin your learning journey.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div id="resource-viewer-modal">
            <div class="resource-viewer-content" id="viewer-content">
                <div class="resource-viewer-header">
                    <h2 class="resource-viewer-title" id="resource-viewer-title">Resource Preview</h2>
                    <div>
                        <button class="resource-viewer-fullscreen-button" id="viewer-fullscreen-btn"><i
                                class="fas fa-expand"></i></button>
                        <button class="resource-viewer-close-button" id="viewer-close-btn">×</button>
                    </div>
                </div>
                <div class="viewer-main-content">
                    <div id="viewer-loading-screen" class="loading-screen" style="display: none;">
                        <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                        <p>Loading Document...</p>
                    </div>
                    <div id="pdf-viewer-container" class="pdf-canvas-container" style="display: none;"><canvas
                            id="pdf-canvas"></canvas></div>
                    <div id="csv-viewer-container" class="csv-preview-container" style="display: none;">
                        <table class="csv-preview-table"></table>
                    </div>
                </div>
                <div class="resource-viewer-controls">
                    <button id="pdf-prev-page" class="viewer-nav-button">Previous</button>
                    <span id="pdf-page-info"></span>
                    <button id="viewer-download-btn" class="viewer-nav-button viewer-download-btn">Download</button>
                    <button id="pdf-next-page" class="viewer-nav-button">Next</button>
                </div>
            </div>
        </div>

        <footer id="footer" class="footer-enhanced" style="display: none;">
            <div class="footer-content">
                <div class="footer-main">
                    <div class="footer-brand">
                        <img src="https://www.mystudentclub.com/assets/logo.png" alt="My Student Club Logo"
                            class="logo-enhanced">
                        <h4>My Student Club</h4>
                        <p>Empowering the next generation of Chartered Accountants with world-class education and
                            resources.</p>
                        <div class="social-links">
                            <a href="https://www.linkedin.com/company/mystudentclub" target="_blank"
                                rel="noopener noreferrer"><i class="fab fa-linkedin"></i></a>
                            <a href="https://www.instagram.com/mystudentclub/" target="_blank"
                                rel="noopener noreferrer"><i class="fab fa-instagram"></i></a>
                            <a href="https://www.youtube.com/@MyStudentClub" target="_blank"
                                rel="noopener noreferrer"><i class="fab fa-youtube"></i></a>
                        </div>
                    </div>
                    <div class="footer-links">
                        <div class="footer-column">
                            <h5>Learning</h5>
                            <ul>
                                <li><a href="index.html">My Dashboard</a></li>
                                <li><a href="lms-resources.html">Resources Hub</a></li>
                                <li><a href="https://mystudentclub.com/cv-reviewer/">CV Review</a></li>
                            </ul>
                        </div>
                        <div class="footer-column">
                            <h5>Support</h5>
                            <ul>
                                <li><a href="mailto:support@mystudentclub.com">Contact Us</a></li>
                                <li><a href="https://mystudentclub.com/privacy-policy">Privacy Policy</a></li>
                                <li><a href="https://mystudentclub.com/terms">Terms of Service</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>© 2025 My Student Club LMS. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const supabaseUrl = 'https://izsggdtdiacxdsjjncdq.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6c2dnZHRkaWFjeGRzampuY2RxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1OTEzNjUsImV4cCI6MjA1NDE2NzM2NX0.FVKBJG-TmXiiYzBDjGIRBM2zg-DYxzNP--WM6q2UMt0';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js`;

            let state = {
                menuActive: false, sidebarActive: false, courseSlug: null, user: null, isEnrolled: false,
                course: { title: '', description: '', thumbnail: '', progress: 0 }, courseSections: [],
                currentVideoId: null, activeTab: 'overview', comments: [],
                errorLogCount: 0,
                videoStartTimes: { 1: 170, 2: 119, 4: 26, 6: 39, 7: 52 },
                currentResource: null, previewType: null, isViewerVisible: false, pdfDoc: null,
                pdfCurrentPage: 1, pdfTotalPages: 1, isFullscreen: false, isPlaying: false,
                controlsTimeout: null, seekIndicatorTimeout: null, retryCount: 0, maxRetries: 5, isDraggingSeekBar: false
            };

            const courses = {
                'industrial-training-mastery': {
                    title: 'CA Industrial Training Program',
                    description: 'Master industrial training requirements for CA candidates with real-world case studies.',
                    thumbnail: 'https://mystudentclub.com/assets/courseimg-industrial.png'
                },
                'msc-ca-freshers-program': {
                    title: 'MSC CA Freshers Program',
                    description: 'A comprehensive program for CA freshers to kickstart their career.',
                    thumbnail: 'https://mystudentclub.com/assets/courseimg-fresher.png'
                }
            };

            const DOMElements = {
                app: document.getElementById('app'),
                hamburgerMenu: document.getElementById('hamburger-menu'),
                navLinks: document.getElementById('nav-links'),
                userDisplayName: document.getElementById('user-display-name'),
                profileDropdown: document.getElementById('profile-dropdown'),
                profileDropdownName: document.getElementById('profile-dropdown-name'),
                profileDropdownEmail: document.getElementById('profile-dropdown-email'),
                logoutButton: document.getElementById('logout-button'),
                enrollmentModal: document.getElementById('enrollment-modal'),
                enrollCourseThumbnail: document.getElementById('enroll-course-thumbnail'),
                enrollCourseTitle: document.getElementById('enroll-course-title'),
                enrollRedirectBtn: document.getElementById('enroll-redirect-btn'),
                loadingEnrollmentScreen: document.getElementById('loading-enrollment-screen'),
                coursePageContent: document.getElementById('course-page-content'),
                courseHeaderBanner: document.getElementById('course-header-banner'),
                courseTitle: document.getElementById('course-title'),
                courseDescription: document.getElementById('course-description'),
                totalVideosMeta: document.getElementById('total-videos-meta'),
                totalVideosCount: document.getElementById('total-videos-count'),
                loadingVideosMeta: document.getElementById('loading-videos-meta'),
                courseProgressMeta: document.getElementById('course-progress-meta'),
                courseSidebar: document.getElementById('course-sidebar'),
                sidebarCloseBtn: document.getElementById('sidebar-close-btn'),
                sidebarProgressBar: document.getElementById('sidebar-progress-bar'),
                sidebarProgressText: document.getElementById('sidebar-progress-text'),
                courseModulesContainer: document.getElementById('course-modules-container'),
                loadingVideosSidebar: document.getElementById('loading-videos-sidebar'),
                sidebarToggleBtn: document.getElementById('sidebar-toggle-btn'),
                videoSectionContainer: document.getElementById('video-section-container'),
                noVideoSelectedPlaceholder: document.getElementById('no-video-selected-placeholder'),
                videoPlayerContainer: document.getElementById('video-player-container'),
                videoPlayer: document.getElementById('video-player'),
                videoLoadingOverlay: document.getElementById('video-loading-overlay'),
                seekIndicator: document.getElementById('seek-indicator'),
                videoControls: document.getElementById('video-controls'),
                playPauseBtn: document.getElementById('play-pause-btn'),
                seekBar: document.getElementById('seek-bar'),
                seekBarFill: document.getElementById('seek-bar-fill'),
                timeDisplay: document.getElementById('time-display'),
                muteBtn: document.getElementById('mute-btn'),
                volumeIcon: document.getElementById('volume-icon'),
                volumeSlider: document.getElementById('volume-slider'),
                settingsBtn: document.getElementById('settings-btn'),
                speedMenu: document.getElementById('speed-menu'),
                fullscreenBtn: document.getElementById('fullscreen-btn'),
                noVideoMessagePlayer: document.getElementById('no-video-message-player'),
                prevVideoBtn: document.getElementById('prev-video-btn'),
                nextVideoBtn: document.getElementById('next-video-btn'),
                videoCounter: document.getElementById('video-counter'),
                courseTabsContainer: document.getElementById('course-tabs-container'),
                tabContents: {
                    overview: document.getElementById('tab-content-overview'),
                    resources: document.getElementById('tab-content-resources'),
                    discussion: document.getElementById('tab-content-discussion'),
                    report: document.getElementById('tab-content-report')
                },
                newCommentInput: document.getElementById('new-comment-input'),
                postCommentBtn: document.getElementById('post-comment-btn'),
                commentsLoader: document.getElementById('comments-loader'),
                commentListContainer: document.getElementById('comment-list-container'),
                reportDescriptionInput: document.getElementById('report-description-input'),
                submitReportBtn: document.getElementById('submit-report-btn'),
                resourceViewerModal: document.getElementById('resource-viewer-modal'),
                viewerContent: document.getElementById('viewer-content'),
                resourceViewerTitle: document.getElementById('resource-viewer-title'),
                viewerFullscreenBtn: document.getElementById('viewer-fullscreen-btn'),
                viewerCloseBtn: document.getElementById('viewer-close-btn'),
                viewerLoadingScreen: document.getElementById('viewer-loading-screen'),
                pdfViewerContainer: document.getElementById('pdf-viewer-container'),
                csvViewerContainer: document.getElementById('csv-viewer-container'),
                pdfCanvas: document.getElementById('pdf-canvas'),
                pdfPrevPage: document.getElementById('pdf-prev-page'),
                pdfNextPage: document.getElementById('pdf-next-page'),
                pdfPageInfo: document.getElementById('pdf-page-info'),
                viewerDownloadBtn: document.getElementById('viewer-download-btn'),
                footer: document.getElementById('footer')
            };

            const getResourceIcon = (type) => {
                const iconMap = {
                    pdf: 'fas fa-file-pdf', image: 'fas fa-file-image', doc: 'fas fa-file-word',
                    docx: 'fas fa-file-word', txt: 'fas fa-file-alt', external_link: 'fas fa-external-link-alt',
                    video: 'fas fa-file-video', archive: 'fas fa-file-archive', spreadsheet: 'fas fa-file-excel',
                    xlsx: 'fas fa-file-excel', csv: 'fas fa-file-csv'
                };
                return iconMap[type ? type.toLowerCase() : ''] || 'fas fa-file';
            };

            const updateLearningStreak = () => {
                const today = new Date().toDateString();
                const lastActivity = localStorage.getItem('lastLearningActivity');
                if (lastActivity !== today) {
                    localStorage.setItem('lastLearningActivity', today);
                    const currentStreak = parseInt(localStorage.getItem('learningStreak') || '0');
                    localStorage.setItem('learningStreak', (currentStreak + 1).toString());
                }
            };

            const findVideoById = (videoId) => {
                for (const section of state.courseSections) {
                    const foundVideo = section.videos.find(v => v.id === videoId);
                    if (foundVideo) return foundVideo;
                }
                return null;
            };

            const updateCourseProgress = () => {
                let totalCount = 0;
                let completedCount = 0;
                state.courseSections.forEach(section => {
                    section.videos.forEach(video => {
                        totalCount++;
                        if (video.completed) completedCount++;
                    });
                });
                const progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                state.course.progress = progress;
                DOMElements.courseProgressMeta.textContent = `${progress}% Complete`;
                DOMElements.sidebarProgressText.textContent = `${progress}% Complete`;
                DOMElements.sidebarProgressBar.style.width = `${progress}%`;
            };

            const saveVideoProgress = () => {
                const completedVideos = {};
                state.courseSections.forEach(section => {
                    section.videos.forEach(video => {
                        if (video.completed) {
                            completedVideos[video.id] = true;
                        }
                    });
                });
                const existingData = localStorage.getItem(`courseVideos_${state.courseSlug}`);
                let mergedData = {};
                if (existingData) {
                    try {
                        mergedData = JSON.parse(existingData);
                    } catch (e) { }
                }
                const newData = { ...mergedData, ...completedVideos };
                localStorage.setItem(`courseVideos_${state.courseSlug}`, JSON.stringify(newData));
            };

            const markVideoCompleted = () => {
                if (!state.currentVideoId) return;
                const videoToMark = findVideoById(state.currentVideoId);
                if (videoToMark && !videoToMark.completed) {
                    videoToMark.completed = true;
                    saveVideoProgress();
                    updateCourseProgress();
                    updateLearningStreak();
                    renderCourseModules();
                }
            };

            const renderCourseModules = () => {
                DOMElements.courseModulesContainer.innerHTML = '';
                if (state.courseSections.length === 0) {
                    DOMElements.courseModulesContainer.innerHTML = `
                        <div class="empty-content">
                            <i class="fas fa-video-slash"></i>
                            <p>No content available for this course yet.</p>
                        </div>`;
                    return;
                }

                state.courseSections.forEach((day, dayIndex) => {
                    const isDayCompleted = day.videos.every(v => v.completed);
                    const isDaySelected = day.videos.some(v => v.id === state.currentVideoId);
                    const moduleDiv = document.createElement('div');
                    moduleDiv.className = 'course-module';

                    let resourcesHTML = '';
                    if (day.mainVideo && day.mainVideo.resources.length > 0) {
                        const groups = {};
                        day.mainVideo.resources.forEach(res => {
                            const groupKey = res.group || 'General Resources';
                            if (!groups[groupKey]) groups[groupKey] = [];
                            groups[groupKey].push(res);
                        });

                        for (const groupName in groups) {
                            if (groupName !== 'General Resources') {
                                resourcesHTML += `<h5 class="sidebar-resource-group-title">${groupName}</h5>`;
                            }
                            groups[groupName].forEach(resource => {
                                resourcesHTML += `
                                    <div class="resource-item-sidebar" data-resource='${JSON.stringify(resource)}'>
                                        <span class="resource-icon-sidebar"><i class="${getResourceIcon(resource.type)}"></i></span>
                                        <span class="resource-title-sidebar">${resource.title}</span>
                                    </div>`;
                            });
                        }
                    }

                    moduleDiv.innerHTML = `
                        <div class="module-header ${isDaySelected ? 'active' : ''} ${isDayCompleted ? 'completed' : ''}" data-video-id="${day.mainVideo.id}">
                            <div class="module-title-container">
                                <i class="fas ${isDayCompleted ? 'fa-check-circle' : 'fa-play-circle'}"></i>
                                <h4>${day.title}</h4>
                            </div>
                            <div class="module-info" data-day-index="${dayIndex}">
                                ${day.mainVideo && day.mainVideo.resources.length > 0 ? `<span>${day.mainVideo.resources.length} Resource${day.mainVideo.resources.length !== 1 ? 's' : ''}</span>` : ''}
                                <i class="fas ${day.expanded ? 'fa-chevron-up' : 'fa-chevron-down'}"></i>
                            </div>
                        </div>
                        <div class="module-content ${day.expanded ? 'expanded' : ''}">
                            <div class="sidebar-resource-list">${resourcesHTML}</div>
                        </div>
                    `;
                    DOMElements.courseModulesContainer.appendChild(moduleDiv);
                });

                DOMElements.courseModulesContainer.querySelectorAll('.module-header').forEach(el => {
                    el.addEventListener('click', (e) => {
                        selectVideo(parseInt(el.dataset.videoId));
                    });
                });

                DOMElements.courseModulesContainer.querySelectorAll('.module-info').forEach(el => {
                    el.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const dayIndex = parseInt(el.dataset.dayIndex);
                        state.courseSections[dayIndex].expanded = !state.courseSections[dayIndex].expanded;
                        renderCourseModules();
                    });
                });

                DOMElements.courseModulesContainer.querySelectorAll('.resource-item-sidebar').forEach(el => {
                    el.addEventListener('click', () => handleResourceClick(JSON.parse(el.dataset.resource)));
                });
            };

            const loadVideoProgress = () => {
                const savedVideos = localStorage.getItem(`courseVideos_${state.courseSlug}`);
                if (savedVideos) {
                    try {
                        const completedVideos = JSON.parse(savedVideos);
                        state.courseSections.forEach(section => {
                            section.videos.forEach(video => {
                                if (completedVideos[video.id] === true) video.completed = true;
                            });
                        });
                    } catch (e) { console.error("Error parsing progress", e); }
                }
                updateCourseProgress();
                const lastVideoId = localStorage.getItem(`lastVideoId_${state.courseSlug}`);
                if (lastVideoId && findVideoById(parseInt(lastVideoId))) {
                    selectVideo(parseInt(lastVideoId));
                } else if (state.courseSections.length > 0 && state.courseSections[0].videos.length > 0) {
                    selectVideo(state.courseSections[0].videos[0].id);
                }
            };

            const logFrontendError = async (message, stack, source) => {
                if (state.errorLogCount >= 6) return;
                state.errorLogCount++;

                const contextData = JSON.stringify({
                    course: state.courseSlug,
                    videoId: state.currentVideoId,
                    screen: `${window.screen.width}x${window.screen.height}`
                });

                try {
                    await supabase
                        .from('frontend_errors')
                        .insert({
                            user_id: state.user ? state.user.id : null,
                            error_message: `Source: ${source} | Message: ${message || 'Unknown Error'} | Context: ${contextData}`,
                            stack_trace: stack || 'No Stack Trace',
                            url: window.location.href,
                            user_agent: navigator.userAgent
                        });
                } catch (e) {
                    console.error('Error logging to Supabase:', e);
                }
            };

            const loadCourseVideos = async () => {
                DOMElements.loadingVideosMeta.style.display = 'flex';
                DOMElements.loadingVideosSidebar.style.display = 'block';
                try {
                    const { data: videoMetadata, error: metadataError } = await supabase
                        .from('videos').select('video_number, title, description, day_number, resources')
                        .eq('course', state.courseSlug).order('day_number', { ascending: true })
                        .order('video_number', { ascending: true });

                    if (metadataError) throw metadataError;

                    const videosByDay = {};
                    if (videoMetadata && videoMetadata.length > 0) {
                        for (const meta of videoMetadata) {
                            try {
                                const { data: rpcData, error: rpcError } = await supabase.rpc('get_video_link', {
                                    course_name_param: state.courseSlug,
                                    video_number_param: meta.video_number
                                });

                                const day = meta.day_number || 1;
                                if (!videosByDay[day]) videosByDay[day] = [];
                                videosByDay[day].push({
                                    id: meta.video_number, fileName: rpcData || null,
                                    title: meta.title || `Content for Day ${day}`,
                                    description: meta.description || '', resources: meta.resources || [], completed: false
                                });
                            } catch (err) { }
                        }
                    }

                    state.courseSections = Object.keys(videosByDay).map(dayNum => {
                        const dayVideos = videosByDay[dayNum];
                        const mainVideo = dayVideos[0] || {};
                        return {
                            day_number: parseInt(dayNum), title: mainVideo.title || `Day ${dayNum}`,
                            expanded: parseInt(dayNum) === 1, videos: dayVideos, mainVideo: mainVideo
                        };
                    }).sort((a, b) => a.day_number - b.day_number);

                    const totalVideos = videoMetadata ? videoMetadata.length : 0;
                    if (totalVideos > 0) {
                        DOMElements.totalVideosCount.textContent = `${totalVideos} Sessions`;
                        DOMElements.totalVideosMeta.style.display = 'flex';
                    }
                    loadVideoProgress();
                    renderCourseModules();
                } catch (error) {
                    logFrontendError(error.message, error.stack, 'loadCourseVideos');
                } finally {
                    DOMElements.loadingVideosMeta.style.display = 'none';
                    DOMElements.loadingVideosSidebar.style.display = 'none';
                }
            };

            const checkEnrollment = async () => {
                try {
                    const { data: enrollments, error } = await supabase
                        .from('enrollment').select('course').eq('uuid', state.user.id).eq('course', state.courseSlug);
                    if (error || !enrollments || enrollments.length === 0) {
                        state.isEnrolled = false;
                        DOMElements.enrollmentModal.style.display = 'flex';
                    } else {
                        state.isEnrolled = true;
                        DOMElements.coursePageContent.style.display = 'block';
                        DOMElements.footer.style.display = 'block';
                        await loadCourseVideos();
                    }
                } catch (error) {
                    state.isEnrolled = false;
                    DOMElements.enrollmentModal.style.display = 'flex';
                } finally {
                    DOMElements.loadingEnrollmentScreen.style.display = 'none';
                }
            };

            const checkAuth = async () => {
                const { data: { session } } = await supabase.auth.getSession();
            };

            const fetchComments = async () => {
                if (!state.currentVideoId) return;
                DOMElements.commentsLoader.style.display = 'block';
                DOMElements.commentListContainer.innerHTML = '';
                try {
                    const { data, error } = await supabase.from('video_comments').select('*')
                        .eq('course_slug', state.courseSlug).eq('video_id', state.currentVideoId.toString())
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    state.comments = data || [];
                    if (state.comments.length === 0) {
                        DOMElements.commentListContainer.innerHTML = `<div style="color: #64748b; font-style: italic;">No comments yet. Be the first to start the discussion!</div>`;
                    } else {
                        state.comments.forEach(comment => {
                            const commentEl = document.createElement('div');
                            commentEl.className = 'comment-item';
                            commentEl.innerHTML = `
                                <div class="comment-header">
                                    <span class="comment-author">${comment.user_email.split('@')[0]}</span>
                                    <span class="comment-date">${new Date(comment.created_at).toLocaleDateString()}</span>
                                </div>
                                <div class="comment-body">${comment.content}</div>`;
                            DOMElements.commentListContainer.appendChild(commentEl);
                        });
                    }
                } catch (error) {
                    console.error('Error fetching comments:', error);
                } finally {
                    DOMElements.commentsLoader.style.display = 'none';
                }
            };

            const selectVideo = (videoId) => {
                state.retryCount = 0;
                DOMElements.videoLoadingOverlay.style.display = 'flex';
                state.currentVideoId = videoId;

                DOMElements.noVideoSelectedPlaceholder.style.display = 'none';
                DOMElements.videoSectionContainer.style.display = 'block';

                const currentVideo = findVideoById(videoId);

                if (currentVideo && currentVideo.fileName) {
                    DOMElements.videoPlayerContainer.style.display = 'block';
                    DOMElements.noVideoMessagePlayer.style.display = 'none';
                    DOMElements.videoPlayer.src = `https://advertisement.bhansalimanan55.workers.dev/stream/${encodeURIComponent(currentVideo.fileName)}`;
                    DOMElements.videoPlayer.load();
                } else {
                    DOMElements.videoPlayerContainer.style.display = 'none';
                    DOMElements.noVideoMessagePlayer.style.display = 'block';
                }

                setActiveTab('overview');
                renderTabsAndContent();

                if (window.innerWidth < 768) {
                    DOMElements.courseSidebar.classList.remove('active');
                }
                localStorage.setItem(`lastVideoId_${state.courseSlug}`, videoId);
                fetchComments();
                updateNavButtons();
                updateVideoCounter();
                renderCourseModules();
            };

            const renderTabsAndContent = () => {
                const currentVideo = findVideoById(state.currentVideoId);
                if (!currentVideo) return;

                DOMElements.courseTabsContainer.innerHTML = '';
                const tabs = ['overview', 'resources', 'discussion', 'report'];
                tabs.forEach(tabId => {
                    const btn = document.createElement('button');
                    btn.className = 'tab-btn';
                    btn.textContent = tabId.charAt(0).toUpperCase() + tabId.slice(1);
                    btn.dataset.tab = tabId;

                    if (tabId === 'resources' && (!currentVideo.resources || currentVideo.resources.length === 0)) {
                        return;
                    }

                    if (tabId === state.activeTab) {
                        btn.classList.add('active');
                    }
                    btn.addEventListener('click', () => setActiveTab(tabId));
                    DOMElements.courseTabsContainer.appendChild(btn);
                });

                DOMElements.tabContents.overview.innerHTML = currentVideo.description ? `<h3>Summary</h3><p>${currentVideo.description.replace(/\n/g, '<br>')}</p>` : '<p>No description available for this session.</p>';

                DOMElements.tabContents.resources.innerHTML = '';
                if (currentVideo.resources && currentVideo.resources.length > 0) {
                    const groups = {};
                    currentVideo.resources.forEach(res => {
                        const groupKey = res.group || 'General Resources';
                        if (!groups[groupKey]) groups[groupKey] = [];
                        groups[groupKey].push(res);
                    });

                    let resourcesHTML = '';
                    for (const groupName in groups) {
                        resourcesHTML += `<div class="resource-group">`;
                        if (groupName !== 'General Resources' || Object.keys(groups).length > 1) {
                            resourcesHTML += `<h4 class="resource-group-title">${groupName}</h4>`;
                        }
                        resourcesHTML += `<ul class="resource-list">`;
                        groups[groupName].forEach(resource => {
                            resourcesHTML += `
                                <li class="resource-item">
                                    <span class="resource-icon"><i class="${getResourceIcon(resource.type)}"></i></span>
                                    <span class="resource-title">${resource.title}</span>
                                    <div class="resource-actions">
                                        <button class="resource-btn resource-btn-view" data-resource='${JSON.stringify(resource)}'><i class="fas fa-eye"></i> View</button>
                                        ${resource.download_storage_path && resource.download_storage_path !== 'None' ?
                                    `<button class="resource-btn resource-btn-download" data-resource='${JSON.stringify(resource)}'><i class="fas fa-download"></i> Download</button>` :
                                    `<span class="resource-btn resource-btn-download disabled"><i class="fas fa-download"></i> Download</span>`
                                }
                                    </div>
                                </li>`;
                        });
                        resourcesHTML += `</ul></div>`;
                    }
                    DOMElements.tabContents.resources.innerHTML = resourcesHTML;

                    DOMElements.tabContents.resources.querySelectorAll('.resource-btn-view').forEach(btn => {
                        btn.addEventListener('click', () => handleResourceClick(JSON.parse(btn.dataset.resource)));
                    });
                    DOMElements.tabContents.resources.querySelectorAll('.resource-btn-download').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            downloadResource(JSON.parse(btn.dataset.resource));
                        });
                    });
                }
            };

            const setActiveTab = (tabId) => {
                state.activeTab = tabId;
                DOMElements.courseTabsContainer.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabId);
                });
                Object.keys(DOMElements.tabContents).forEach(key => {
                    DOMElements.tabContents[key].style.display = key === tabId ? 'block' : 'none';
                });
            };

            const getAdjacentVideo = (direction) => {
                if (!state.currentVideoId) return null;
                const allVideos = state.courseSections.map(section => section.videos[0]).filter(Boolean);
                const currentIndex = allVideos.findIndex(video => video.id === state.currentVideoId);
                if (currentIndex === -1) return null;
                if (direction === 'previous' && currentIndex > 0) return allVideos[currentIndex - 1];
                if (direction === 'next' && currentIndex < allVideos.length - 1) return allVideos[currentIndex + 1];
                return null;
            };

            const updateNavButtons = () => {
                DOMElements.prevVideoBtn.disabled = getAdjacentVideo('previous') === null;
                DOMElements.nextVideoBtn.disabled = getAdjacentVideo('next') === null;
            };

            const updateVideoCounter = () => {
                if (!state.currentVideoId) {
                    DOMElements.videoCounter.textContent = '';
                    return;
                }
                const section = state.courseSections.find(s => s.videos.some(v => v.id === state.currentVideoId));
                if (section) {
                    DOMElements.videoCounter.textContent = `Day ${section.day_number} of ${state.courseSections.length}`;
                }
            };

            const handleResourceClick = async (resource) => {
                if (resource.type === 'external_link' && resource.url) {
                    window.open(resource.url, '_blank');
                    return;
                }
                if (resource.view_storage_path && resource.view_storage_path !== 'None') {
                    const path = resource.view_storage_path.toLowerCase();
                    if (path.endsWith('.csv')) await openResourceViewer(resource, 'csv');
                    else await openResourceViewer(resource, 'pdf');
                    return;
                }
                downloadResource(resource);
            };

            const downloadResource = async (resource) => {
                const path = resource.download_storage_path;
                if (!path || path === 'None') {
                    alert('No downloadable file available for this resource.');
                    return;
                }
                try {
                    const { data, error } = await supabase.storage.from('industrial-training-mastery-resources').createSignedUrl(path, 300);
                    if (error) throw error;
                    const response = await fetch(data.signedUrl);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const blob = await response.blob();
                    const filename = path.split('/').pop() || 'download';
                    if (window.flutter_inappwebview && typeof window.flutter_inappwebview.callHandler === 'function') {
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = function () {
                            const base64Content = reader.result.split(',')[1];
                            window.flutter_inappwebview.callHandler('blobToBase64Handler', base64Content, filename);
                        };
                    } else {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url; a.download = filename;
                        document.body.appendChild(a); a.click();
                        window.URL.revokeObjectURL(url); a.remove();
                    }
                } catch (err) {
                    console.error('Download error:', err);
                    alert('Could not download the file. Please try again.');
                }
            };

            const openResourceViewer = async (resource, type) => {
                state.pdfDoc = null; state.csvData = null; state.pdfCurrentPage = 1; state.pdfTotalPages = 1;
                const ctx = DOMElements.pdfCanvas.getContext('2d');
                ctx.clearRect(0, 0, DOMElements.pdfCanvas.width, DOMElements.pdfCanvas.height);

                DOMElements.viewerLoadingScreen.style.display = 'flex';
                DOMElements.resourceViewerModal.classList.add('visible');
                state.currentResource = resource;
                state.previewType = type;
                DOMElements.resourceViewerTitle.textContent = resource.title;

                DOMElements.pdfViewerContainer.style.display = 'none';
                DOMElements.csvViewerContainer.style.display = 'none';

                try {
                    const { data, error } = await supabase.storage.from('industrial-training-mastery-resources').createSignedUrl(resource.view_storage_path, 300);
                    if (error) throw error;
                    const response = await fetch(`https://pdf-proxy-viewer.bhansalimanan55.workers.dev/?url=${encodeURIComponent(data.signedUrl)}`);
                    if (!response.ok) throw new Error(`Failed to fetch from proxy: ${response.status}`);

                    if (type === 'pdf') {
                        const pdfData = await response.arrayBuffer();
                        state.pdfDoc = await pdfjsLib.getDocument(pdfData).promise;
                        state.pdfTotalPages = state.pdfDoc.numPages;
                        DOMElements.pdfViewerContainer.style.display = 'block';
                        await renderPdfPage(1);
                    } else if (type === 'csv') {
                        const csvText = await response.text();
                        const lines = csvText.split('\n').filter(line => line.trim() !== '');
                        const header = lines.length > 0 ? lines[0].split(',').map(h => h.trim()) : [];
                        const rows = lines.length > 1 ? lines.slice(1).map(line => line.split(',').map(cell => cell.trim())) : [];

                        const table = DOMElements.csvViewerContainer.querySelector('table');
                        table.innerHTML = `
                            <thead><tr>${header.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                            <tbody>${rows.map(row => `<tr>${row.map(cell => `<td title="${cell}">${cell}</td>`).join('')}</tr>`).join('')}</tbody>
                        `;
                        DOMElements.csvViewerContainer.style.display = 'block';
                    }
                } catch (err) {
                    alert("Could not load the resource for viewing.");
                    closeResourceViewer();
                } finally {
                    DOMElements.viewerLoadingScreen.style.display = 'none';
                }
            };

            const renderPdfPage = async (num) => {
                if (!state.pdfDoc) return;
                state.pdfCurrentPage = num;
                const page = await state.pdfDoc.getPage(num);
                const canvas = DOMElements.pdfCanvas;
                const ctx = canvas.getContext('2d');
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                drawWatermark(canvas, ctx);

                DOMElements.pdfPageInfo.textContent = `Page ${state.pdfCurrentPage} of ${state.pdfTotalPages}`;
                DOMElements.pdfPrevPage.disabled = state.pdfCurrentPage <= 1;
                DOMElements.pdfNextPage.disabled = state.pdfCurrentPage >= state.pdfTotalPages;
            };

            const drawWatermark = (canvas, ctx) => {
                const watermarkText = state.user ? state.user.email : 'MyStudentClub';
                ctx.font = '20px Arial'; ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                const x_step = 250, y_step = 150;
                ctx.save();
                for (let y = y_step / 2; y < canvas.height; y += y_step) {
                    for (let x = x_step / 2; x < canvas.width; x += x_step) {
                        ctx.save(); ctx.translate(x, y); ctx.rotate(-Math.PI / 4);
                        ctx.fillText(watermarkText, 0, 0); ctx.restore();
                    }
                }
                ctx.restore();
            };

            const closeResourceViewer = () => {
                if (state.isFullscreen) toggleFullscreen();
                DOMElements.resourceViewerModal.classList.remove('visible');
                state.pdfDoc = null; state.currentResource = null; state.previewType = null;
            };

            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    DOMElements.viewerContent.requestFullscreen().catch(err => {
                        alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                    });
                } else {
                    document.exitFullscreen();
                }
            };

            const formatTime = (timeInSeconds) => {
                if (isNaN(timeInSeconds)) return '00:00';
                const time = Math.max(0, timeInSeconds);
                const hours = Math.floor(time / 3600);
                const minutes = Math.floor((time % 3600) / 60).toString().padStart(2, '0');
                const seconds = Math.floor(time % 60).toString().padStart(2, '0');
                return hours > 0 ? `${hours}:${minutes}:${seconds}` : `${minutes}:${seconds}`;
            };

            const attemptReload = () => {
                if (state.retryCount < state.maxRetries) {
                    state.retryCount++;
                    const delay = Math.pow(2, state.retryCount) * 1000;
                    setTimeout(() => {
                        DOMElements.videoLoadingOverlay.style.display = 'flex';
                        const currentTime = DOMElements.videoPlayer.currentTime;
                        DOMElements.videoPlayer.load();
                        DOMElements.videoPlayer.play().then(() => {
                            DOMElements.videoPlayer.currentTime = currentTime;
                        }).catch(() => { });
                    }, delay);
                } else {
                    alert("Failed to load the video after multiple attempts. Please check your connection or try again later.");
                }
            };

            const showSeekIndicator = (direction) => {
                const icon = DOMElements.seekIndicator.querySelector('i');
                if (!icon) return;
                icon.className = `fas fa-fast-${direction}`;
                DOMElements.seekIndicator.classList.add('show', direction);
                if (state.seekIndicatorTimeout) clearTimeout(state.seekIndicatorTimeout);
                state.seekIndicatorTimeout = setTimeout(() => {
                    DOMElements.seekIndicator.classList.remove('show', 'forward', 'backward');
                }, 500);
            };

            const showControlsOnMove = () => {
                DOMElements.videoControls.classList.add('visible');
                if (state.controlsTimeout) clearTimeout(state.controlsTimeout);
                if (state.isPlaying) {
                    state.controlsTimeout = setTimeout(() => {
                        DOMElements.videoControls.classList.remove('visible');
                    }, 3000);
                }
            };

            const updateVolumeIcon = () => {
                const video = DOMElements.videoPlayer;
                if (video.muted || video.volume === 0) DOMElements.volumeIcon.className = 'fas fa-volume-mute';
                else if (video.volume < 0.5) DOMElements.volumeIcon.className = 'fas fa-volume-down';
                else DOMElements.volumeIcon.className = 'fas fa-volume-up';
            };

            const setupEventListeners = () => {
                DOMElements.hamburgerMenu.addEventListener('click', () => DOMElements.navLinks.classList.toggle('active'));
                DOMElements.logoutButton.addEventListener('click', async () => {
                    await supabase.auth.signOut();
                    window.location.href = 'https://www.mystudentclub.com/login';
                });
                DOMElements.enrollRedirectBtn.addEventListener('click', () => window.location.href = 'https://www.mystudentclub.com/login');
                DOMElements.sidebarToggleBtn.addEventListener('click', () => DOMElements.courseSidebar.classList.add('active'));
                DOMElements.sidebarCloseBtn.addEventListener('click', () => DOMElements.courseSidebar.classList.remove('active'));

                DOMElements.prevVideoBtn.addEventListener('click', () => { const v = getAdjacentVideo('previous'); if (v) selectVideo(v.id); });
                DOMElements.nextVideoBtn.addEventListener('click', () => { const v = getAdjacentVideo('next'); if (v) selectVideo(v.id); });

                DOMElements.postCommentBtn.addEventListener('click', async () => {
                    const content = DOMElements.newCommentInput.value.trim();
                    if (!content || !state.user) return;
                    DOMElements.postCommentBtn.disabled = true; DOMElements.postCommentBtn.textContent = 'Posting...';
                    try {
                        const { data, error } = await supabase.from('video_comments').insert({
                            course_slug: state.courseSlug, video_id: state.currentVideoId.toString(),
                            user_id: state.user.id, user_email: state.user.email, content: content
                        }).select();
                        if (error) throw error;
                        DOMElements.newCommentInput.value = '';
                        await fetchComments();
                    } catch (error) {
                        alert('Failed to post comment. Please try again.');
                    } finally {
                        DOMElements.postCommentBtn.disabled = false; DOMElements.postCommentBtn.textContent = 'Post';
                    }
                });

                DOMElements.submitReportBtn.addEventListener('click', async () => {
                    const description = DOMElements.reportDescriptionInput.value.trim();
                    if (!description || !state.user) return;
                    DOMElements.submitReportBtn.disabled = true; DOMElements.submitReportBtn.textContent = 'Submitting...';
                    try {
                        const { error } = await supabase.from('course_reports').insert({
                            user_id: state.user.id, course_slug: state.courseSlug, description, page_url: window.location.href
                        });
                        if (error) throw error;
                        alert('Report submitted successfully. We will look into it.');
                        DOMElements.reportDescriptionInput.value = '';
                        setActiveTab('overview');
                    } catch (error) {
                        alert('Failed to submit report.');
                    } finally {
                        DOMElements.submitReportBtn.disabled = false; DOMElements.submitReportBtn.textContent = 'Submit Report';
                    }
                });

                DOMElements.viewerCloseBtn.addEventListener('click', closeResourceViewer);
                DOMElements.viewerFullscreenBtn.addEventListener('click', toggleFullscreen);
                DOMElements.pdfPrevPage.addEventListener('click', () => { if (state.pdfCurrentPage > 1) renderPdfPage(state.pdfCurrentPage - 1); });
                DOMElements.pdfNextPage.addEventListener('click', () => { if (state.pdfCurrentPage < state.pdfTotalPages) renderPdfPage(state.pdfCurrentPage + 1); });
                DOMElements.viewerDownloadBtn.addEventListener('click', () => { if (state.currentResource) downloadResource(state.currentResource) });

                const video = DOMElements.videoPlayer;
                video.addEventListener('play', () => { state.isPlaying = true; DOMElements.playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>'; });
                video.addEventListener('pause', () => { state.isPlaying = false; DOMElements.playPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; DOMElements.videoControls.classList.add('visible'); });
                video.addEventListener('ended', markVideoCompleted);
                video.addEventListener('timeupdate', () => {
                    if (state.isDraggingSeekBar) return;
                    const virtualStartTime = state.videoStartTimes[state.currentVideoId] || 0;
                    const displayCurrentTime = Math.max(0, video.currentTime - virtualStartTime);
                    const displayDuration = Math.max(0, video.duration - virtualStartTime);
                    if (displayDuration > 0) {
                        const progressPercentage = (displayCurrentTime / displayDuration) * 100;
                        DOMElements.seekBar.value = displayCurrentTime;
                        DOMElements.seekBarFill.style.width = `${progressPercentage}%`;
                    }
                    DOMElements.timeDisplay.textContent = `${formatTime(displayCurrentTime)} / ${formatTime(displayDuration)}`;
                });
                video.addEventListener('loadedmetadata', () => {
                    DOMElements.videoLoadingOverlay.style.display = 'none';
                    state.retryCount = 0;
                    const virtualStartTime = state.videoStartTimes[state.currentVideoId] || 0;
                    const displayDuration = Math.max(0, video.duration - virtualStartTime);
                    DOMElements.seekBar.max = displayDuration;
                    if (virtualStartTime > 0 && video.currentTime < virtualStartTime) video.currentTime = virtualStartTime;
                });
                video.addEventListener('waiting', () => DOMElements.videoLoadingOverlay.style.display = 'flex');
                video.addEventListener('playing', () => DOMElements.videoLoadingOverlay.style.display = 'none');
                video.addEventListener('error', () => { DOMElements.videoLoadingOverlay.style.display = 'none'; attemptReload(); });
                video.parentElement.addEventListener('click', () => video.paused ? video.play() : video.pause());
                video.parentElement.addEventListener('dblclick', (e) => {
                    const rect = video.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    if (clickX < rect.width * 0.4) { video.currentTime -= 10; showSeekIndicator('backward'); }
                    else if (clickX > rect.width * 0.6) { video.currentTime += 10; showSeekIndicator('forward'); }
                });

                DOMElements.playPauseBtn.addEventListener('click', (e) => { e.stopPropagation(); video.paused ? video.play() : video.pause(); });
                DOMElements.seekBar.addEventListener('input', (e) => {
                    state.isDraggingSeekBar = true;
                    const virtualStartTime = state.videoStartTimes[state.currentVideoId] || 0;
                    const displayTime = parseFloat(e.target.value);
                    const displayDuration = parseFloat(DOMElements.seekBar.max);
                    if (displayDuration > 0) DOMElements.seekBarFill.style.width = `${(displayTime / displayDuration) * 100}%`;
                    DOMElements.timeDisplay.textContent = `${formatTime(displayTime)} / ${formatTime(displayDuration)}`;
                });
                DOMElements.seekBar.addEventListener('change', (e) => {
                    const virtualStartTime = state.videoStartTimes[state.currentVideoId] || 0;
                    video.currentTime = parseFloat(e.target.value) + virtualStartTime;
                    state.isDraggingSeekBar = false;
                });
                DOMElements.muteBtn.addEventListener('click', (e) => { e.stopPropagation(); video.muted = !video.muted; updateVolumeIcon(); });
                DOMElements.volumeSlider.addEventListener('input', (e) => { video.volume = e.target.value; video.muted = e.target.value == 0; updateVolumeIcon(); });
                DOMElements.fullscreenBtn.addEventListener('click', (e) => { e.stopPropagation(); DOMElements.videoPlayerContainer.requestFullscreen(); });
                DOMElements.settingsBtn.addEventListener('click', (e) => { e.stopPropagation(); DOMElements.speedMenu.style.display = DOMElements.speedMenu.style.display === 'none' ? 'block' : 'none'; });
                DOMElements.videoPlayerContainer.addEventListener('mousemove', showControlsOnMove);

                const playbackRates = [0.5, 0.75, 1, 1.25, 1.5, 2];
                playbackRates.forEach(rate => {
                    const div = document.createElement('div');
                    div.textContent = `${rate}x`;
                    div.addEventListener('click', () => { video.playbackRate = rate; DOMElements.speedMenu.style.display = 'none'; renderSpeedMenu(rate); });
                    DOMElements.speedMenu.appendChild(div);
                });
                const renderSpeedMenu = (activeRate) => {
                    DOMElements.speedMenu.querySelectorAll('div').forEach(el => el.classList.toggle('active', parseFloat(el.textContent) === activeRate));
                };
                renderSpeedMenu(1);

                document.addEventListener('fullscreenchange', () => { state.isFullscreen = !!document.fullscreenElement; });
                document.addEventListener('keydown', (e) => {
                    if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
                    if (!state.currentVideoId) return;
                    switch (e.key) {
                        case ' ': e.preventDefault(); video.paused ? video.play() : video.pause(); break;
                        case 'ArrowLeft': e.preventDefault(); video.currentTime -= 10; showSeekIndicator('backward'); break;
                        case 'ArrowRight': e.preventDefault(); video.currentTime += 10; showSeekIndicator('forward'); break;
                    }
                });

                window.onerror = (msg, url, line, col, error) => logFrontendError(msg, error ? error.stack : `Line: ${line}, Col: ${col}`, url);
                window.addEventListener('unhandledrejection', (event) => {
                    let errorMessage = 'Unhandled Promise Rejection';
                    let errorStack = '';
                    if (event.reason) {
                        errorMessage = event.reason.message || (typeof event.reason === 'string' ? event.reason : JSON.stringify(event.reason));
                        errorStack = event.reason.stack || '';
                    }
                    logFrontendError(errorMessage, errorStack, 'Promise Rejection');
                });
            };

            const init = async () => {
                const urlParams = new URLSearchParams(window.location.search);
                state.courseSlug = urlParams.get('course');
                if (!state.courseSlug || !courses[state.courseSlug]) {
                    window.location.href = 'index.html';
                    return;
                }
                state.course = { ...courses[state.courseSlug], progress: 0 };

                DOMElements.courseTitle.textContent = state.course.title;
                DOMElements.courseDescription.textContent = state.course.description;
                DOMElements.courseHeaderBanner.style.background = `linear-gradient(rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.55)), url('${state.course.thumbnail}')`;
                DOMElements.courseHeaderBanner.style.backgroundSize = 'cover';
                DOMElements.courseHeaderBanner.style.backgroundPosition = 'center';

                DOMElements.enrollCourseTitle.textContent = state.course.title;
                DOMElements.enrollCourseThumbnail.src = state.course.thumbnail;

                setupEventListeners();
                await checkAuth();

                supabase.auth.onAuthStateChange(async (_event, session) => {
                    if (!session || !session.user) {
                        window.location.href = 'https://www.mystudentclub.com/login';
                    } else if (state.user?.id !== session.user.id) {
                        state.user = session.user;
                        if (!state.isEnrolled) await checkEnrollment();
                    }
                });
            };

            init();
        });
    </script>
</body>

</html>
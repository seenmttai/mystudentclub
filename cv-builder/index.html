<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CA CV Maker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Driver.js for Guided Tour -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css" />
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <link rel="stylesheet" href="cv-styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
        integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body class="view-editor">

    <div id="toast">Changes saved</div>

    <!-- LEFT PANEL -->
    <div class="editor">
        <div class="editor-header">
            <div class="brand-row">
                <div class="app-logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    CA CV Maker
                    <span class="beta-badge">Beta</span>
                </div>
                <div style="display: flex; gap: 6px;">
                    <button class="btn-icon" onclick="startTour()" title="Take a quick tour"
                        style="background: #f0f4ff; border-color: var(--primary-light);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary)"
                            stroke-width="2.5">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                            <circle cx="12" cy="17" r="0.5" fill="currentColor"></circle>
                        </svg>
                        <span style="color: var(--primary);">Help</span>
                    </button>
                    <button class="btn-icon btn-magic" onclick="generateAI()" title="Auto-improve with AI">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                            </path>
                        </svg>
                        AI Enhance
                    </button>
                </div>
            </div>

            <div class="action-bar">
                <button class="btn-icon" onclick="startReviewFromPreview()"
                    style="color: var(--primary); border-color: var(--primary-light); background: #f0f9ff;">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                        </path>
                    </svg>
                    AI Review
                </button>
                <button class="btn-icon" onclick="printCV()">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M6 9V2h12v7"></path>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                        <rect x="6" y="14" width="12" height="8"></rect>
                    </svg>
                    PDF
                </button>
                <button class="btn-icon" onclick="document.getElementById('file-upload').click()">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    Import
                </button>
                <button class="btn-icon btn-primary" onclick="manualSave()">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M5 5v14a1 1 0 0 0 1 1h12"></path>
                        <path d="M5 5h11l3 3v12a1 1 0 0 1-1 1H6"></path>
                        <path d="M9 9h6v4H9z"></path>
                    </svg>
                    Save
                </button>
                <button class="btn-icon" style="color: #ef4444; border-color: #fecaca; margin-left: auto;"
                    onclick="resetData()">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Reset
                </button>

            </div>

            <input type="file" id="file-upload" accept="image/*,application/pdf" style="display:none"
                onchange="handleImageUpload(this)">

            <div class="progress-track" title="Completion">
                <div class="progress-fill" id="progress-fill" style="width: 10%"></div>
            </div>

            <div class="history-strip" id="history-strip">
                <div class="history-header">Your CV versions</div>
                <div class="history-list" id="history-list">
                    <div class="history-empty">Snapshots will appear here as you edit.</div>
                </div>
            </div>
        </div>

        <div class="editor-content">

            <details open>
                <summary>Personal Details</summary>
                <div class="section-body">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" class="form-control" id="inp-name" placeholder="e.g. Padam Bhansali"
                            oninput="updateCV()" spellcheck="false">
                    </div>
                    <div class="form-group" data-section="tagline">
                        <label>Tagline / Current Role</label>
                        <input type="text" class="form-control" id="inp-tagline" placeholder="e.g. CA Final | Flipkart"
                            oninput="updateCV()">
                    </div>
                    <div class="form-group" data-section="contact">
                        <label>Contact Info</label>
                        <input type="text" class="form-control" id="inp-contact"
                            placeholder="+91 98765 43210 | email@me.com | linkedin.com/in/user" oninput="updateCV()">
                    </div>
                    <div class="form-group" data-section="phone">
                        <label>Phone</label>
                        <input type="text" class="form-control" id="inp-phone" placeholder="+91 98765 43210"
                            oninput="updateCV()">
                    </div>
                    <div class="form-group" data-section="email">
                        <label>Email</label>
                        <input type="email" class="form-control" id="inp-email" placeholder="yourname@email.com"
                            oninput="updateCV()">
                    </div>
                    <div class="form-group" data-section="linkedin">
                        <label>LinkedIn</label>
                        <input type="text" class="form-control" id="inp-linkedin" placeholder="linkedin.com/in/yourname"
                            oninput="updateCV()">
                    </div>

                    <!-- Social Links Section -->
                    <div class="form-group" style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;">
                        <label>Social Links / Portfolio</label>
                        <div id="social-links-container"></div>
                        <button class="btn-dashed" onclick="addSocialLink()">+ Add Link</button>
                    </div>
                </div>
            </details>

            <details data-section="summary">
                <summary>Career Objective</summary>
                <div class="section-body">
                    <div class="form-group">
                        <div
                            style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
                            <label style="margin-bottom:0;">Objective / Summary</label>
                            <button type="button" class="btn-mini" onclick="aiRefineSummary()"
                                title="Let AI polish this section">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path
                                        d="M12 3l2.09 4.26L19 8l-3.5 3.4L16.18 17 12 14.8 7.82 17 9 11.4 5 8l4.91-.74L12 3z">
                                    </path>
                                </svg>
                                AI refine
                            </button>
                        </div>
                        <textarea class="form-control" id="inp-summary"
                            placeholder="Brief summary of your professional goals..." oninput="updateCV()"
                            maxlength="500"></textarea>
                        <div class="char-counter" id="summary-counter">0/500</div>
                    </div>
                </div>
            </details>

            <details open>
                <summary>
                    <span>Education</span>
                    <button class="chip" onclick="prefillCAEducation(event)"
                        style="font-size:10px; padding:4px 8px;">Auto-fill CA Path</button>
                </summary>
                <div class="section-body">
                    <div id="edu-container"></div>
                    <button class="btn-dashed" onclick="addEducation()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Education
                    </button>
                </div>
            </details>

            <details open>
                <summary>Experience / Articleship</summary>
                <div class="section-body">
                    <div id="exp-container"></div>
                    <button class="btn-dashed" onclick="addExperience()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Experience
                    </button>
                </div>
            </details>

            <details data-section="projects">
                <summary>Projects</summary>
                <div class="section-body">
                    <div id="proj-container"></div>
                    <button class="btn-dashed" onclick="addProject()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Project
                    </button>
                </div>
            </details>

            <details data-section="certifications">
                <summary>Certifications</summary>
                <div class="section-body">
                    <div id="cert-container"></div>
                    <button class="btn-dashed" onclick="addCertification()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Certification
                    </button>
                </div>
            </details>

            <details data-section="achievements">
                <summary>Achievements & Awards</summary>
                <div class="section-body">
                    <div id="ach-container"></div>
                    <button class="btn-dashed" onclick="addListItem('achievements')">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Achievement
                    </button>
                </div>
            </details>

            <details data-section="leadership">
                <summary>Leadership</summary>
                <div class="section-body">
                    <div id="lead-container"></div>
                    <button class="btn-dashed" onclick="addListItem('leadership')">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Leadership Role
                    </button>
                </div>
            </details>

            <details data-section="interests">
                <summary>Interests & Hobbies</summary>
                <div class="section-body">
                    <div id="int-container"></div>
                    <button class="btn-dashed" onclick="addListItem('interests')">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Interest
                    </button>
                </div>
            </details>

            <details data-section="skills">
                <summary>Skills</summary>
                <div class="section-body">
                    <div class="chip-container" id="skills-chips"></div>
                    <div class="form-group">
                        <div
                            style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
                            <label style="margin-bottom:0;">Skills Overview</label>
                            <button type="button" class="btn-mini" onclick="aiRefineSkills()"
                                title="Let AI refine your skills wording">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path
                                        d="M12 3l2.09 4.26L19 8l-3.5 3.4L16.18 17 12 14.8 7.82 17 9 11.4 5 8l4.91-.74L12 3z">
                                    </path>
                                </svg>
                                AI refine
                            </button>
                        </div>
                        <textarea class="form-control" id="inp-skills" placeholder="List your key skills..."
                            oninput="updateCV()" maxlength="300"></textarea>
                        <div class="char-counter" id="skills-counter">0/300</div>
                    </div>
                </div>
            </details>

            <!-- Spacer for mobile nav -->
            <div style="height: 40px;"></div>
        </div>
    </div>

    <div class="resize-handle" id="resize-handle"></div>

    <!-- RIGHT PANEL -->
    <div class="preview">
        <div class="template-floater" onclick="toggleTemplateSidebar(true)" style="cursor: pointer;">
            <span class="template-label">Template</span>
            <span id="current-template-name" style="font-size: 13px; font-weight: 600; color: var(--text-main);">Modern
                Serif</span>
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M6 9l6 6 6-6" />
            </svg>
        </div>

        <!-- Hidden dropdown for legacy compatibility -->
        <select id="template-select" style="display: none;" onchange="changeTemplate()">
            <option value="cv1.html">Modern Serif</option>
            <option value="cv2.html">Classic Blue</option>
            <option value="cv3.html">Grid Layout</option>
            <option value="cv4.html">Professional</option>
            <option value="cv5.html">Corporate</option>
            <option value="cv6.html">Minimalist</option>
            <option value="cv7.html">Compact</option>
            <option value="cv8.html">Bold Modern</option>
            <option value="cv9.html">Executive</option>
        </select>

        <div class="preview-wrapper">
            <iframe id="cv-frame" src="cv1.html"></iframe>
            <div id="ai-spinner" class="loading-overlay">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- MOBILE NAV -->
    <!-- REVIEWER PANEL -->
    <div id="reviewer-overlay" class="reviewer-overlay">
        <div class="reviewer-container">
            <div class="reviewer-header-bar">
                <div class="brand-row" style="margin:0">
                    <div class="app-logo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" style="color:var(--primary)">
                            <path
                                d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                            </path>
                        </svg>
                        AI CV Reviewer
                    </div>
                </div>
                <button class="btn-icon" onclick="toggleReviewer(false)">Close</button>
            </div>

            <div class="reviewer-body">
                <!-- HERO -->
                <div id="heroSection" class="hero-section">
                    <h2>Optimize your CV</h2>
                    <p>Upload your resume PDF to get instant, AI-powered feedback on structure, keywords, and impact.
                    </p>
                </div>

                <!-- UPLOAD -->
                <div id="uploadSection" class="upload-section">
                    <div id="dropArea" class="drop-area">
                        <span class="icon-cloud">☁️</span>
                        <p>Drag & drop your PDF here</p>
                        <p class="sub-text">or click to browse</p>
                        <button id="browseButton" class="btn-primary">Browse Files</button>
                    </div>
                    <input type="file" id="fileInput" hidden accept=".pdf">
                </div>

                <!-- PREVIEW -->
                <div id="previewArea" class="preview-area" style="display:none;">
                    <div id="previewThumbnail" class="preview-thumb"></div>
                    <div class="file-info">
                        <span id="fileName">filename.pdf</span>
                        <span id="fileSize" class="text-muted">0 KB</span>
                    </div>
                    <div class="preview-actions">
                        <button id="removeFileBtn" class="btn-icon"
                            style="color:var(--danger); border-color:var(--border-color);">Remove</button>
                        <button id="proceedToReviewBtn" class="btn-primary" disabled>Analyze CV</button>
                    </div>
                </div>

                <!-- LOADING -->
                <div id="loadingSection" class="loading-section" style="display:none; text-align:center; padding:40px;">
                    <div class="spinner" style="margin:0 auto 20px;"></div>
                    <p id="loadingProgressText" style="font-weight:600; color:var(--text-main);">Analyzing...</p>
                </div>

                <!-- RESULTS -->
                <div id="resultsSection" class="results-section" style="display:none;">
                    <!-- Score -->
                    <div class="score-section">
                        <h3 class="score-section-title">Overall Score</h3>
                        <div class="score-container">
                            <svg class="score-chart" viewBox="0 0 36 36">
                                <defs>
                                    <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" stop-color="#818cf8" />
                                        <stop offset="100%" stop-color="#4f46e5" />
                                    </linearGradient>
                                </defs>
                                <path class="score-bg"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831">
                                </path>
                                <path id="scoreProgress" class="score-progress" stroke-dasharray="0, 100"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831">
                                </path>
                            </svg>
                            <div id="scoreText" class="score-value">0</div>
                        </div>
                        <div class="score-label">out of 100</div>
                    </div>
                    <div id="scoreJustification" class="score-notes"></div>

                    <!-- Tabs -->
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="analysis">Analysis</button>
                        <button class="tab-btn" data-tab="history">History</button>
                        <button class="tab-btn" data-tab="leaderboard">Leaderboard</button>
                    </div>

                    <!-- Analysis Tab -->
                    <div id="tab-analysis" class="tab-content active">
                        <div id="tipsSection">
                            <!-- Dynamic Sections -->
                            <div id="recruiterTipsSection" class="review-card">
                                <div class="section-header">Recruiter Tips <span class="toggle-icon">▼</span></div>
                                <div class="content-area"></div>
                            </div>
                            <div id="measurableResultsSection" class="review-card">
                                <div class="section-header">Measurable Results <span class="toggle-icon">▼</span></div>
                                <div class="content-area"></div>
                            </div>
                            <div id="phrasesSuggestionsSection" class="review-card">
                                <div class="section-header">Phrase Suggestions <span class="toggle-icon">▼</span></div>
                                <div class="content-area"></div>
                            </div>
                            <div id="hardSkillsSection" class="review-card">
                                <div class="section-header">Hard Skills <span class="toggle-icon">▼</span></div>
                                <div class="content-area"></div>
                            </div>
                            <div id="softSkillsSection" class="review-card">
                                <div class="section-header">Soft Skills <span class="toggle-icon">▼</span></div>
                                <div class="content-area"></div>
                            </div>
                            <div id="actionVerbsSection" class="review-card">
                                <div class="section-header">Action Verbs <span class="toggle-icon">▼</span></div>
                                <div class="content-area"></div>
                            </div>
                            <div id="grammarCheckSection" class="review-card">
                                <div class="section-header">Grammar Check <span class="toggle-icon">▼</span></div>
                                <div class="content-area"></div>
                            </div>
                            <div id="formattingSection" class="review-card">
                                <div class="section-header">Formatting <span class="toggle-icon">▼</span></div>
                                <div class="content-area"></div>
                            </div>
                            <div id="educationSection" class="review-card">
                                <div class="section-header">Education <span class="toggle-icon">▼</span></div>
                                <div class="content-area"></div>
                            </div>
                            <div id="articleshipSection" class="review-card">
                                <div class="section-header">Articleship <span class="toggle-icon">▼</span></div>
                                <div class="content-area"></div>
                            </div>
                            <div id="interviewQuestionsSection" class="review-card">
                                <div class="section-header">Interview Prep <span class="toggle-icon">▼</span></div>
                                <div class="content-area"></div>
                            </div>
                            <div id="finalRecommendationsSection" class="review-card">
                                <div class="section-header">Final Verdict <span class="toggle-icon">▼</span></div>
                                <div class="content-area"></div>
                            </div>
                        </div>
                    </div>

                    <!-- History Tab -->
                    <div id="tab-history" class="tab-content">
                        <div id="historyContent"></div>
                        <div id="historyDetailContent" style="display:none; margin-top:20px;"></div>
                    </div>

                    <!-- Leaderboard Tab -->
                    <div id="tab-leaderboard" class="tab-content">
                        <div id="leaderboardContent"></div>
                    </div>

                    <!-- Actions -->
                    <div class="reviewer-footer">
                        <button id="startOverBtn" class="btn-secondary">Analyze Another</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-nav">
        <div class="nav-tab active" onclick="switchTab('editor')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            <span>Edit</span>
        </div>
        <div class="nav-tab" onclick="switchTab('reviewer')" style="color:var(--primary);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path
                    d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                </path>
            </svg>
            <span>Review</span>
        </div>
        <div class="nav-tab" onclick="switchTab('preview')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
            <span>Preview</span>
        </div>
    </div>

    <!-- REVIEWER LOGIC -->
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        // Note: pdfjsLib is loaded via dynamic import below

        // Configuration
        const SUPABASE_URL = 'https://api.mystudentclub.com';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6c2dnZHRkaWFjeGRzampuY2RxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1OTEzNjUsImV4cCI6MjA1NDE2NzM2NX0.FVKBJG-TmXiiYzBDjGIRBM2zg-DYxzNP--WM6q2UMt0';

        let supabase = null;
        let userId = null;
        let authUser = null;
        let selectedFile = null;
        let pdfImages = [];
        let analysisResultText = null;

        // UI Elements
        const els = {};

        function initReviewer() {
            // Map Elements
            ['heroSection', 'uploadSection', 'dropArea', 'fileInput', 'browseButton', 'previewArea', 'previewThumbnail',
                'fileName', 'fileSize', 'removeFileBtn', 'proceedToReviewBtn', 'loadingSection', 'resultsSection',
                'scoreText', 'scoreProgress', 'scoreJustification', 'tipsSection', 'historyContent', 'leaderboardContent',
                'downloadReportBtn', 'startOverBtn'].forEach(id => els[id] = document.getElementById(id));

            // Listeners
            if (els.browseButton) els.browseButton.onclick = () => els.fileInput.click();
            if (els.fileInput) els.fileInput.onchange = handleFileSelect;
            if (els.dropArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => els.dropArea.addEventListener(e, preventDefaults, false));
                ['dragenter', 'dragover'].forEach(e => els.dropArea.addEventListener(e, () => els.dropArea.classList.add('dragover'), false));
                ['dragleave', 'drop'].forEach(e => els.dropArea.addEventListener(e, () => els.dropArea.classList.remove('dragover'), false));
                els.dropArea.addEventListener('drop', handleDrop, false);
            }
            if (els.removeFileBtn) els.removeFileBtn.onclick = resetUpload;
            if (els.proceedToReviewBtn) els.proceedToReviewBtn.onclick = analyzeCv;
            if (els.startOverBtn) els.startOverBtn.onclick = resetToUploadStage;

            // Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    const tabId = btn.dataset.tab;
                    document.getElementById('tab-' + tabId).classList.add('active');
                    if (tabId === 'history') loadHistory();
                    if (tabId === 'leaderboard') loadLeaderboard();
                };
            });

            // Collapsible Sections
            document.getElementById('tipsSection').addEventListener('click', (e) => {
                const header = e.target.closest('.section-header');
                if (header) {
                    const card = header.closest('.review-card');
                    card.classList.toggle('open');
                }
            });

            setupUserId();
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY, { global: { headers: { 'x-msc-user-id': userId } } });
        }

        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        function handleDrop(e) { handleFile(e.dataTransfer.files[0]); }
        function handleFileSelect(e) { handleFile(e.target.files[0]); }

        function setupUserId() {
            userId = localStorage.getItem('msc_cv_reviewer_uuid');
            if (!userId) {
                userId = crypto.randomUUID();
                localStorage.setItem('msc_cv_reviewer_uuid', userId);
            }
        }

        async function handleFile(file) {
            if (!file || file.type !== 'application/pdf') return alert('Please upload a PDF.');
            selectedFile = file;
            els.fileName.innerText = file.name;
            els.fileSize.innerText = (file.size / 1024).toFixed(1) + ' KB';

            els.dropArea.parentElement.style.display = 'none'; // Hide upload section
            els.previewArea.style.display = 'block';
            els.previewThumbnail.innerHTML = '<div style="padding:20px; text-align:center;">Loading Preview...</div>';

            try {
                const pdfjsLib = await import('https://esm.sh/pdfjs-dist@4.8.69');
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://esm.sh/pdfjs-dist@4.8.69/build/pdf.worker.min.js';

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 0.5 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                await page.render({ canvasContext: context, viewport }).promise;

                els.previewThumbnail.innerHTML = '';
                els.previewThumbnail.appendChild(canvas);

                // Convert to images for API
                pdfImages = [];
                for (let i = 1; i <= Math.min(pdf.numPages, 3); i++) {
                    const p = await pdf.getPage(i);
                    const v = p.getViewport({ scale: 1.5 });
                    const c = document.createElement('canvas');
                    c.width = v.width; c.height = v.height;
                    await p.render({ canvasContext: c.getContext('2d'), viewport: v }).promise;
                    pdfImages.push(c.toDataURL('image/jpeg', 0.8).split(',')[1]);
                }

                els.proceedToReviewBtn.disabled = false;
            } catch (e) {
                alert('Error processing PDF: ' + e.message);
                resetUpload();
            }
        }

        function resetUpload() {
            selectedFile = null;
            pdfImages = [];
            els.fileInput.value = '';
            els.previewArea.style.display = 'none';
            els.uploadSection.style.display = 'block';
            els.proceedToReviewBtn.disabled = true;
        }

        function resetToUploadStage() {
            resetUpload();
            els.resultsSection.style.display = 'none';
            els.heroSection.style.display = 'block';
        }

        async function analyzeCv() {
            if (!pdfImages.length) return;
            els.heroSection.style.display = 'none';
            els.uploadSection.style.display = 'none';
            els.previewArea.style.display = 'none';
            els.loadingSection.style.display = 'block';

            try {
                const res = await fetch('https://cv-reviewer.bhansalimanan55.workers.dev/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Domain': 'Finance', 'X-Specialization': 'Audit' },
                    body: JSON.stringify({ images: pdfImages })
                });

                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'Analysis failed');

                analysisResultText = data.response;
                processResults(analysisResultText);
                saveReview(analysisResultText);

                els.loadingSection.style.display = 'none';
                els.resultsSection.style.display = 'block';
            } catch (e) {
                alert(e.message);
                resetToUploadStage();
            }
        }

        function processResults(text) {
            const score = parseScore(text);
            animateScore(score);

            // Map sections
            const sections = {
                '<<<RECRUITER_TIPS>>>': 'recruiterTipsSection',
                '<<<MEASURABLE_RESULTS>>>': 'measurableResultsSection',
                '<<<PHRASES_SUGGESTIONS>>>': 'phrasesSuggestionsSection',
                '<<<HARD_SKILLS>>>': 'hardSkillsSection',
                '<<<SOFT_SKILLS>>>': 'softSkillsSection',
                '<<<ACTION_VERBS>>>': 'actionVerbsSection',
                '<<<GRAMMAR_CHECK>>>': 'grammarCheckSection',
                '<<<FORMATTING_READABILITY>>>': 'formattingSection',
                '<<<EDUCATION_QUALIFICATION>>>': 'educationSection',
                '<<<ARTICLESHIP_EXPERIENCE>>>': 'articleshipSection',
                '<<<INTERVIEW_QUESTIONS>>>': 'interviewQuestionsSection',
                '<<<FINAL_RECOMMENDATIONS>>>': 'finalRecommendationsSection'
            };

            for (const [marker, id] of Object.entries(sections)) {
                const endMarker = marker.replace('<<<', '<<<END_');
                const content = extractSection(text, marker, endMarker);
                const container = document.getElementById(id).querySelector('.content-area');

                // Special handling for sections with <<POINT>> markers
                if (marker === '<<<MEASURABLE_RESULTS>>>' || marker === '<<<PHRASES_SUGGESTIONS>>>') {
                    container.innerHTML = formatPointSection(content);
                } else {
                    container.innerHTML = formatText(content);
                }
            }

            // Notes
            const just = extractSection(text, '<<<OVERALL_SCORE>>>', '<<<END_OVERALL_SCORE>>>');
            const justMatch = just?.match(/Justification:\s*(.*)/is);
            els.scoreJustification.innerHTML = formatText(justMatch ? justMatch[1] : 'Analysis complete.');
        }

        function extractSection(text, start, end) {
            const s = text.indexOf(start);
            if (s === -1) return null;
            const e = text.indexOf(end, s);
            return text.substring(s + start.length, e === -1 ? undefined : e).trim();
        }

        function parseScore(text) {
            const m = text.match(/Score:\s*([\d.]+)\/100/i) || text.match(/Overall Score:\s*([\d.]+)/i);
            return m ? parseFloat(m[1]) : 0;
        }

        // Special formatter for sections with <<POINT>> markers (Measurable Results, Phrases Suggestions)
        function formatPointSection(content) {
            if (!content) return '<p class="text-muted italic">No specific feedback.</p>';

            // Split by <<END_POINT>> or --- delimiters
            const points = content.split(/<<END_POINT>>|---/);
            let html = '';

            points.forEach((point) => {
                if (!point.trim()) return;

                // Remove <<POINT>> marker
                point = point.replace(/<<POINT>>/g, '').trim();
                if (!point) return;

                // Extract Original quote
                const originalMatch = point.match(/Original:\s*"([\s\S]+?)"/i);
                // Extract Critique
                const critiqueMatch = point.match(/Critique:\s*([\s\S]+?)(?=Rewrite Suggestion \d+:|$)/i);

                html += `<div class="feedback-point" style="border: 1px solid var(--border-color); border-radius: 10px; padding: 16px; margin-bottom: 16px; background: #fafbfc;">`;

                if (originalMatch && originalMatch[1]) {
                    html += `<div style="margin-bottom: 12px;">
                        <span style="font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Original</span>
                        <div style="margin-top: 4px; padding: 10px 12px; background: #fff; border: 1px solid var(--border-color); border-radius: 6px; font-style: italic; color: var(--text-main); line-height: 1.5;">"${originalMatch[1].trim()}"</div>
                    </div>`;
                }

                if (critiqueMatch && critiqueMatch[1]) {
                    const critiqueText = critiqueMatch[1].trim();
                    html += `<div style="margin-bottom: 12px;">
                        <span style="font-size: 10px; font-weight: 700; color: var(--danger); text-transform: uppercase; letter-spacing: 0.5px;">Critique</span>
                        <div style="margin-top: 4px; color: var(--text-main); line-height: 1.6;">${formatCritiqueText(critiqueText)}</div>
                    </div>`;
                }

                // Extract all rewrite suggestions
                const allSuggestions = [...point.matchAll(/Rewrite Suggestion (\d+):\s*([\s\S]+?)(?=Rewrite Suggestion \d+:|$)/gi)];

                if (allSuggestions.length > 0) {
                    html += `<div>
                        <span style="font-size: 10px; font-weight: 700; color: var(--success); text-transform: uppercase; letter-spacing: 0.5px;">Rewrite Suggestions</span>
                        <div style="margin-top: 8px;">`;

                    allSuggestions.forEach((match, idx) => {
                        const suggestionText = match[2].trim();
                        if (suggestionText) {
                            html += `<div style="display: flex; gap: 10px; margin-bottom: 8px; padding: 10px 12px; background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.15); border-radius: 6px;">
                                <span style="flex-shrink: 0; width: 22px; height: 22px; background: var(--success); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700;">${idx + 1}</span>
                                <div style="color: var(--text-main); line-height: 1.5;">${escapeHtml(suggestionText)}</div>
                            </div>`;
                        }
                    });

                    html += `</div></div>`;
                }

                html += `</div>`;
            });

            return html || '<p class="text-muted italic">No specific feedback.</p>';
        }

        function formatCritiqueText(text) {
            // Escape HTML and format
            let html = escapeHtml(text);
            // Convert line breaks
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }


        function formatText(md) {
            if (!md) return '<p class="text-muted italic">No specific feedback.</p>';

            // STEP 1: Pre-process raw text before HTML conversion
            let processedText = md;

            // Replace asterisks at the start of lines with bullet points
            processedText = processedText.replace(/^\* /gm, '• ');
            processedText = processedText.replace(/\n\* /g, '\n• ');

            // The model often returns long paragraphs. Break them into bullet-friendly lines:
            // 1) After sentence boundaries (., ?, !) followed by a capital letter → new bullet
            processedText = processedText.replace(/([.!?])\s+(?=[A-Z])/g, '$1\n• ');
            // 2) After ISSUE markers when explanation continues
            processedText = processedText.replace(/(\[ISSUE(?:\s*-\s*SEVERITY:\s*(?:Critical|High|Moderate|Low))?[^\]]*\])\.?\s+([A-Z])/gi, '$1\n• $2');
            // 3) Convert inline numbered items (1. 2. 3. etc.) to bullet points
            // First, handle patterns like "text. 1. more" or "text 1. more" - any " N. " pattern
            processedText = processedText.replace(/\s+(\d+)\.\s+/g, '\n ');
            // Also handle numbered items at the very start of text
            processedText = processedText.replace(/^(\d+)\.\s+/gm, '');

            // STEP 2: Convert to HTML with escaping and markdown
            let html = processedText
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`([^`]+)`/g, '<code class="bg-gray-200 px-1 rounded text-sm">$1</code>')
                .replace(/(\r\n|\n|\r)/g, '<br>');

            // STEP 3: Replace markers with styled elements
            // Replace [GOOD] with styled checkmark
            html = html.replace(/\[GOOD\]/g, '<span class="highlight-good" title="Good point">✓</span>');

            // Replace [ISSUE] with styled X (without severity)
            html = html.replace(/\[ISSUE\](?!\s*-\s*SEVERITY)/g, '<span class="highlight-issue" title="Area for improvement">✗</span>');

            // Replace [ISSUE - SEVERITY: Level] with compact severity badges
            html = html.replace(/\[ISSUE\s*-\s*SEVERITY:\s*(Critical|High|Moderate|Low)(?:[^\]]*)\]/gi, (match, severity) => {
                const level = severity.toLowerCase();
                return `<span class="highlight-issue" title="Issue">✗</span><span class="severity-badge severity-${level}">${severity}</span>`;
            });

            // STEP 4: Format section labels: "**Label:**" pattern
            html = html.replace(/<br>\s*\*\*([^*:]+):\*\*/g, '</p><h4 class="feedback-label">$1:</h4><p>');
            html = html.replace(/^\*\*([^*:]+):\*\*/gm, '<h4 class="feedback-label">$1:</h4>');

            // STEP 5: Convert bullet markers to styled paragraphs
            html = html.replace(/<br>\s*•\s*/g, '</p><p class="feedback-bullet">');
            html = html.replace(/<p>•\s*/g, '<p class="feedback-bullet">');
            html = html.replace(/^•\s*/gm, '');

            // Convert numbered items to styled format
            html = html.replace(/<br>\s*(\d+)\.\s+/g, '</p><p class="feedback-numbered"><strong>$1.</strong> ');

            // Convert <br><br> to separate paragraphs for better spacing
            html = html.replace(/<br>\s*<br>/g, '</p><p>');

            // Convert hyphen list markers to feedback-bullet paragraphs
            html = html.replace(/<br>\s*-\s+/g, '</p><p class="feedback-bullet">');
            html = html.replace(/<br>\s*\*\s+/g, '</p><p class="feedback-bullet">');

            // STEP 6: Clean up empty paragraphs and fix structure
            html = html.replace(/<p>\s*<\/p>/g, '');
            html = html.replace(/<\/p>\s*<\/p>/g, '</p>');
            html = html.replace(/<p>\s*<p/g, '<p');

            // Wrap in paragraph if not already
            if (!html.startsWith('<p') && !html.startsWith('<h')) {
                html = '<p>' + html + '</p>';
            }

            return html;
        }

        function animateScore(target) {
            let current = 0;
            const el = els.scoreText;
            const bar = els.scoreProgress;
            const step = () => {
                current += (target - current) * 0.1;
                if (Math.abs(target - current) < 0.5) current = target;
                el.innerText = current.toFixed(0);
                bar.setAttribute('stroke-dasharray', `${Math.min(current, 100)}, 100`);
                if (current !== target) requestAnimationFrame(step);
            };
            step();
        }

        async function saveReview(text) {
            const { error } = await supabase.from('msc_cv_ai_resume_reviews').insert([{
                user_id: userId,
                score: parseScore(text),
                review_data: { review: text },
                file_name: selectedFile.name
            }]);
            if (error) console.error(error);
        }

        async function loadHistory() {
            els.historyContent.innerHTML = 'Loading...';
            const { data } = await supabase.from('msc_cv_ai_resume_reviews').select('*').eq('user_id', userId).order('created_at', { ascending: false }).limit(10);
            if (!data || !data.length) return els.historyContent.innerHTML = '<p class="text-muted">No history yet.</p>';

            els.historyContent.innerHTML = data.map(i => `
                <div class="history-item" onclick="showHistoryDetail('${i.id}')">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${i.file_name}</strong>
                        <span style="color:var(--primary); font-weight:bold;">${i.score?.toFixed(0)}%</span>
                    </div>
                    <div class="text-muted text-sm">${new Date(i.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');

            // Hack to store data for detail view
            window._historyData = data;
        }

        window.showHistoryDetail = (id) => {
            const item = window._historyData.find(i => i.id == id);
            const detail = document.getElementById('historyDetailContent');
            detail.style.display = 'block';
            detail.innerHTML = `<div class="review-card open"><div class="content-area" style="display:block">${formatText(item.review_data.review)}</div></div>`;
        };

        async function loadLeaderboard() {
            els.leaderboardContent.innerHTML = 'Loading...';
            const { data } = await supabase.from('msc_cv_ai_resume_reviews').select('score, file_name, created_at').order('score', { ascending: false }).limit(10);
            if (!data) return;
            els.leaderboardContent.innerHTML = data.map((i, idx) => `
                <div class="history-item" style="cursor:default;">
                    <div style="display:flex; justify-content:space-between;">
                        <span>#${idx + 1} ${i.file_name.substring(0, 15)}...</span>
                        <span style="color:var(--primary); font-weight:bold;">${i.score?.toFixed(0)}%</span>
                    </div>
                </div>
            `).join('');
        }

        // Initialize
        initReviewer();

        // Expose a function to start review from the current live preview
        window.startReviewFromPreview = async function () {
            try {
                if (window.toggleReviewer) window.toggleReviewer(true);

                // Check for html2canvas - fallback to global or bundle internal if needed
                const h2c = window.html2canvas || (window.html2pdf && window.html2pdf.Worker.prototype.html2canvas);

                if (!h2c) {
                    alert('Review engine (html2canvas) not ready. Please refresh and try again.');
                    return;
                }

                const frame = document.getElementById('cv-frame');
                const doc = frame?.contentDocument || frame?.contentWindow?.document;
                const node = doc?.getElementById('cv-page') || doc?.body;
                if (!frame || !doc || !node) {
                    alert('Unable to access the live CV preview.');
                    return;
                }

                // Reset UI to loading state
                if (els.heroSection) els.heroSection.style.display = 'none';
                if (els.uploadSection) els.uploadSection.style.display = 'none';
                if (els.previewArea) els.previewArea.style.display = 'none';
                if (els.loadingSection) els.loadingSection.style.display = 'block';

                // Capture the current CV preview as an image (same content as the PDF)
                const canvas = await h2c(node, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    onclone: (clonedDoc) => {
                        // Ensure styles are available in the clone for correct capture
                        const styles = doc.querySelectorAll('style, link[rel="stylesheet"]');
                        styles.forEach(s => clonedDoc.head.appendChild(s.cloneNode(true)));
                    }
                });

                pdfImages = [canvas.toDataURL('image/jpeg', 0.85).split(',')[1]];

                // Re-use the existing analysis pipeline
                await analyzeCv();
            } catch (e) {
                console.error("Review capture error:", e);
                alert('Failed to analyze current CV: ' + (e.message || 'Unknown error'));
                if (els.loadingSection) els.loadingSection.style.display = 'none';
                if (els.heroSection) els.heroSection.style.display = 'block';
                if (els.uploadSection) els.uploadSection.style.display = 'block';
            }
        };
    </script>

    <!-- Template Sidebar Overlay -->
    <div class="template-sidebar-overlay" id="template-sidebar-overlay" onclick="toggleTemplateSidebar(false)"></div>

    <!-- Template Sidebar -->
    <div class="template-sidebar" id="template-sidebar">
        <div class="template-sidebar-header">
            <h3>Choose Template</h3>
            <button class="template-sidebar-close" onclick="toggleTemplateSidebar(false)">×</button>
        </div>
        <div class="template-grid" id="template-grid">
            <!-- Cards injected by JS -->
        </div>
    </div>
</body>
<script src="cv-script.js"></script>

</html>